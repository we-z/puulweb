<!DOCTYPE html>
<html lang="en" class="js-loading">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="/js/fouc-prevention.js"></script>
    <style>
        .sub-nav { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .sub-nav-item { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; color: #555; transition: color 0.2s ease, border-bottom-color 0.2s ease; }
        .sub-nav-item:hover { color: #000; }
        .sub-nav-item.active { color: #000; border-bottom-color: #000; }
        .subsection-content { display: none; }
        .subsection-content.active { display: block; }
        .communication-placeholder { padding: 20px; background-color: #f8f9fa; border: 1px dashed #ced4da; border-radius: 8px; text-align: center; color: #6c757d; margin-top: 15px;}
        
        /* --- Refined Messaging Styles --- */

        /* Main Layout */
        .messaging-layout {
            display: flex;
            height: calc(100vh - 220px); /* Adjust based on header/nav height */
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .conversations-panel {
            width: 320px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            background: #fcfcfc;
        }

        .message-display-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .panel-header h5 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        /* Buttons */
        .btn-icon {
            background: transparent;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }
        .btn-icon:hover {
            background: #f0f2f5;
            color: #333;
        }
        #newConversationBtn {
             font-size: 28px;
             font-weight: 300;
        }
        #messageActionsBtn {
            font-size: 20px;
            font-weight: bold;
        }


        /* Search Bar */
         .search-bar {
            padding: 10px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
         .search-bar input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px; /* Pill shape */
            font-size: 0.9rem;
            background: #fff;
        }
        .search-bar input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.15);
        }

        /* Conversation List */
        .item-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

        .conversation-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e9e9e9;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .conversation-item:hover {
            background: #f5f5f5;
        }
        .conversation-item.active {
            background: #f0f2f5; /* Light gray for active */
        }
        .conv-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #6c757d; /* Neutral gray */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .conv-details { flex-grow: 1; overflow: hidden; }
        .conv-name { font-weight: 600; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; margin-bottom: 3px; }
        .conv-preview { font-size: 0.9rem; color: #666; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .conv-timestamp { font-size: 0.8rem; color: #999; margin-left: 10px; white-space: nowrap; }
        
        /* Message Display */
        .message-header { position: relative; }
        #conversationTitle {
            font-size: 1.2rem;
            color: #1a202c;
        }
        #messageActionsMenu { display: none; position: absolute; right: 20px; top: 60px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; padding: 5px; border: 1px solid #e0e0e0; }
        #messageActionsMenu ul { list-style: none; margin: 0; padding: 0; }
        #messageActionsMenu li { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-radius: 6px; font-size: 0.9rem;}
        #messageActionsMenu li:hover { background: #f0f2f5; }
        
        .message-list { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .message-item { display: flex; margin-bottom: 15px; max-width: 75%; }
        .message-item.sent { margin-left: auto; flex-direction: row-reverse; }
        .msg-avatar { width: 36px; height: 36px; border-radius: 50%; background: #ced4da; color: #495057; display: flex; align-items: center; justify-content: center; font-weight: 500; font-size: 0.9rem; margin-right: 10px; flex-shrink: 0; }
        .message-item.sent .msg-avatar { display: none; }
        .msg-bubble { padding: 10px 15px; border-radius: 18px; }
        .message-item.received .msg-bubble { background: #f0f2f5; color: #1c1e21; border-top-left-radius: 4px;}
        .message-item.sent .msg-bubble { background: #212529; color: white; border-top-right-radius: 4px;} /* Black for sent */
        .msg-sender { font-weight: 600; font-size: 0.85rem; margin-bottom: 5px; display: none;}
        .message-item.received .msg-sender { display: block; }
        .msg-text { line-height: 1.5; }
        .msg-timestamp { font-size: 0.75rem; color: #666; margin-top: 5px; text-align: right; }
        .message-item.sent .msg-timestamp { color: rgba(255,255,255,0.8); }

        /* Message Composer */
        .message-composer { display: flex; align-items: center; gap: 10px; padding: 15px 20px; border-top: 1px solid #e0e0e0; flex-shrink: 0; background: #fcfcfc; }
        #messageInput { 
            flex-grow: 1; 
            border: 1px solid #ced4da; 
            border-radius: 20px; 
            padding: 0 18px; 
            font-size: 1rem; 
            resize: none; 
            height: 40px;
            line-height: 40px;
            display: block;
            overflow-y: auto;
        }
        #messageInput:focus { outline: none; border-color: #495057; box-shadow: 0 0 0 2px rgba(73, 80, 87, 0.15); }
        #messageInput::placeholder {
            line-height: 40px;
        }
        #sendMessageBtn {
            background-color: #212529; /* Black */
            color: white;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease;
            padding: 0;
        }
        #sendMessageBtn:hover { background-color: #343a40; } /* Darker Black */
        #sendMessageBtn svg { width: 20px; height: 20px; }


        /* New Conversation Modal - Refined Styles */
        #newConversationModal .modal-content { padding: 25px 30px; }
        #newConversationModal .modal-header { border-bottom: none; padding-bottom: 10px; }
        #newConversationModal .modal-header h3 { font-size: 1.6rem; }
        #newConversationModal .modal-body { padding: 10px 0; }
        #newConversationModal .form-group label { font-weight: 600; font-size: 1rem; }
        #newConversationModal .user-list { max-height: 350px; overflow-y: auto; margin-top: 15px; border: none; }
        #newConversationModal .user-item { display: flex; align-items: center; padding: 12px 8px; border-radius: 8px; cursor: pointer; margin-bottom: 5px;}
        #newConversationModal .user-item:hover, #newConversationModal .user-item.selected { background-color: #f0f2f5; }
        #newConversationModal .user-item input[type="checkbox"] { transform: scale(1.2); margin-right: 15px; accent-color: #343a40; }
        #newConversationModal .user-item .user-name { font-weight: 500; font-size: 1rem; }
        #newConversationModal .modal-footer {
            padding-top: 25px;
            margin-top: 10px;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        #newConversationModal .modal-footer .cancel-btn,
        #newConversationModal .modal-footer .submit-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        #newConversationModal .modal-footer .submit-btn {
            background-color: #212529;
            color: white;
            border-color: #212529;
        }
        #newConversationModal .modal-footer .submit-btn:hover {
            background-color: #343a40;
            border-color: #343a40;
        }
        #newConversationModal .modal-footer .cancel-btn {
            background-color: #f8f9fa;
            color: #343a40;
            border-color: #ced4da;
        }
        #newConversationModal .modal-footer .cancel-btn:hover {
            background-color: #e9ecef;
            border-color: #adb5bd;
        }

    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="communicationView">
            <div class="content-header"><h2>Communication</h2></div>
            <div class="page-container">
                <div class="sub-nav" id="communicationSubNav">
                    <div class="sub-nav-item active" data-subsection="letters">Letters & Notices</div>
                    <div class="sub-nav-item" data-subsection="forms">Forms & Templates</div>
                    <div class="sub-nav-item" data-subsection="messages">Messages</div>
                </div>

                <div class="subsection-content active" id="lettersContent">
                    <h4>Letters & Notices</h4>
                    <div class="controls-container visible-by-default">
                        <div class="filter-group">
                            <label>Recipient Type:</label>
                            <div class="custom-dropdown" id="lettersFilterType">
                                <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Types</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Types</div>
                                    <div class="dropdown-option" data-value="Tenant">Tenant</div>
                                    <div class="dropdown-option" data-value="Owner">Owner</div>
                                    <div class="dropdown-option" data-value="Vendor">Vendor</div>
                                    <div class="dropdown-option" data-value="Group">Group</div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>Status:</label>
                            <div class="custom-dropdown" id="lettersFilterStatus">
                                <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Statuses</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Statuses</div>
                                    <div class="dropdown-option" data-value="Draft">Draft</div>
                                    <div class="dropdown-option" data-value="Sent">Sent</div>
                                    <div class="dropdown-option" data-value="Archived">Archived</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container">
                        <table class="data-table" id="lettersTable">
                            <thead><tr><th>Title/Subject</th><th>Recipient(s)</th><th>Date Sent</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="lettersTableBody"></tbody>
                        </table>
                        <div id="noLettersMessage" class="no-data-message"><div class="icon">‚úâÔ∏è</div><p>No letters or notices found.</p></div>
                    </div>
                </div>

                <div class="subsection-content" id="formsContent">
                    <h4>Forms & Templates</h4>
                    <div class="controls-container visible-by-default">
                        <div class="filter-group">
                            <label>Category:</label>
                            <div class="custom-dropdown" id="formsFilterCategory">
                                <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Categories</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                <div class="dropdown-options"><div class="dropdown-option" data-value="">All Categories</div></div>
                            </div>
                        </div>
                    </div>
                     <div class="data-table-container">
                        <table class="data-table" id="formsTable">
                            <thead><tr><th>Form/Template Name</th><th>Category</th><th>Last Updated</th><th>Usage Count</th><th>Actions</th></tr></thead>
                            <tbody id="formsTableBody"></tbody>
                        </table>
                        <div id="noFormsMessage" class="no-data-message"><div class="icon">üìÑ</div><p>No forms or templates created.</p></div>
                    </div>
                </div>

                <div class="subsection-content" id="messagesContent">
                    <h4>Messages</h4>
                    <p>Direct and group messaging with tenants, owners, and vendors.</p>
                    
                    <div class="messaging-layout">
                        <div class="conversations-panel">
                            <div class="panel-header">
                                <h5>Conversations</h5>
                                <button id="newConversationBtn" class="btn-icon" title="New Message">+</button>
                            </div>
                            <div class="search-bar">
                                <input type="search" placeholder="Search messages...">
                            </div>
                            <ul id="conversationList" class="item-list">
                                <!-- Conversation items are dynamically loaded here -->
                            </ul>
                        </div>

                        <div class="message-display-panel">
                            <div class="panel-header message-header">
                                <h5 id="conversationTitle">Select a Conversation</h5>
                                <button id="messageActionsBtn" class="btn-icon" title="Conversation Actions">...</button> 
                                <div id="messageActionsMenu">
                                    <ul>
                                        <li id="archiveConversationBtn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;"><path d="M.5 1a.5.5 0 0 0-1 0v11.586l1.293-1.293A.5.5 0 0 1 1.5 11H14.5a.5.5 0 0 1 .5.5v-1a.5.5 0 0 0-1 0v.5H1.707L1 11.207V1.5a.5.5 0 0 1 .5-.5H15.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 0 1 0v-3A1.5 1.5 0 0 0 15.5 0H.5z"/><path d="M16 11.5a.5.5 0 0 0-.5-.5h-15a.5.5 0 0 0 0 1h15a.5.5 0 0 0 .5-.5zM5 4.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5zm-2 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5zm-2 0a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 1 0V5a.5.5 0 0 0-.5-.5z"/></svg>
                                            Archive Conversation
                                        </li>
                                        <li id="deleteConversationBtn">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px; color: #dc3545;"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                            Delete Conversation
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div id="messageList" class="message-list">
                                <div class="communication-placeholder">Select a conversation to view messages.</div>
                            </div>
                            <div class="message-composer">
                                <textarea id="messageInput" placeholder="Type your message..."></textarea>
                                <button id="sendMessageBtn" title="Send Message">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16" style="width: 30px; height: 30px;"><path fill-rule="evenodd" d="M8 13a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V12.5a.5.5 0 0 0 .5.5z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-agent-container"></div>

    <button class="fab" id="addItemBtn" aria-label="Add new communication item">+</button>

    <!-- Modals -->
    <div id="letterModal" class="modal"><div class="modal-content" style="max-width: 700px;"><div class="modal-header"><h3>Create/Edit Letter/Notice</h3><button class="close-btn" data-modal-id="letterModal">&times;</button></div><form id="letterForm"><input type="hidden" name="letterId"><div class="form-group"><label>Title/Subject</label><input type="text" name="subject" required></div><div class="form-group"><label>Recipient Type</label><select name="recipientType"><option>Tenant</option><option>Owner</option><option>Vendor</option><option>Group</option></select></div><div class="form-group"><label>Recipients</label><input type="text" name="recipients" placeholder="Enter names, emails, or group name"></div><div class="form-group"><label>Body</label><textarea name="bodyContent" rows="10" placeholder="Compose letter content here..."></textarea></div><div class="form-group"><label>Status</label><select name="status"><option value="Draft">Draft</option><option value="Sent">Sent</option><option value="Archived">Archived</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="letterModal">Cancel</button><button type="submit" class="submit-btn">Save/Send</button></div></form></div></div>
    <div id="formModal" class="modal"><div class="modal-content" style="max-width: 700px;"><div class="modal-header"><h3>Create/Edit Form/Template</h3><button class="close-btn" data-modal-id="formModal">&times;</button></div><form id="formTemplateForm"><input type="hidden" name="formId"><div class="form-group"><label>Form/Template Name</label><input type="text" name="formName" required></div><div class="form-group"><label>Category</label><input type="text" name="category" placeholder="e.g., Leasing, Maintenance, Legal"></div><div class="form-group"><label>Content/Structure</label><textarea name="formContent" rows="10" placeholder="Define form fields or template content here (e.g., using markdown or a simple DSL)"></textarea></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="formModal">Cancel</button><button type="submit" class="submit-btn">Save Template</button></div></form></div></div>

    <div id="newConversationModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Start New Conversation</h3>
                <button class="close-btn" data-modal-id="newConversationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Search for users to message</label>
                    <input type="text" id="userSearchInput" placeholder="Search by name or email..." class="form-control">
                </div>
                <div id="usersForConversationList" class="user-list">
                    <!-- User items will be dynamically inserted here -->
                </div>
            </div>
            <div class="modal-footer">
                 <button type="button" class="cancel-btn" data-modal-id="newConversationModal">Cancel</button>
                 <button type="button" id="startConversationBtn" class="submit-btn">Start Conversation</button>
            </div>
        </div>
    </div>

    <div id="customAlertModal"><div class="custom-alert"><p></p></div></div>
    <div id="customConfirmModal" class="modal"><div class="modal-content confirm-modal-content"><div class="modal-header"><h3 id="customConfirmTitle"></h3><button class="close-btn" data-modal-id="customConfirmModal">&times;</button></div><div class="modal-body"><p id="customConfirmMessage"></p></div><div class="modal-footer"><button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button><button class="confirm-btn" id="customConfirmOk">OK</button></div></div></div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let pageCurrentUserId, pageDatabase; let commonDependencies = {};
        let pageCurrentUserDisplayName = sessionStorage.getItem('puulUserDisplayName');

        const DOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            letterModal: document.getElementById('letterModal'), letterForm: document.getElementById('letterForm'),
            formModal: document.getElementById('formModal'), formTemplateForm: document.getElementById('formTemplateForm'),
            lettersTableBody: document.getElementById('lettersTableBody'), noLettersMessage: document.getElementById('noLettersMessage'),
            formsTableBody: document.getElementById('formsTableBody'), noFormsMessage: document.getElementById('noFormsMessage'),
            // Messaging DOMElements
            conversationList: document.getElementById('conversationList'),
            messageList: document.getElementById('messageList'),
            messageInput: document.getElementById('messageInput'),
            sendMessageBtn: document.getElementById('sendMessageBtn'),
            newConversationBtn: document.getElementById('newConversationBtn'),
            currentConversationTitle: document.getElementById('conversationTitle'),
            messageActionsBtn: document.getElementById('messageActionsBtn'),
            messageActionsMenu: document.getElementById('messageActionsMenu'),
            deleteConversationBtn: document.getElementById('deleteConversationBtn'),
            archiveConversationBtn: document.getElementById('archiveConversationBtn'),
            // New Conversation Modal
            newConversationModal: document.getElementById('newConversationModal'),
            userSearchInput: document.getElementById('userSearchInput'),
            usersForConversationList: document.getElementById('usersForConversationList'),
            startConversationBtn: document.getElementById('startConversationBtn')
        };

        // Removed Mock Data for Messaging
        let currentConversationId = null; 
        let conversationsListener = null; // To store onValue listener for conversations
        let messagesListener = null;    // To store onValue listener for messages
        let allUsers = []; // Cache for user list

        // Data Caches
        let lettersData = [];
        let formsData = [];

        function pageInit(userId, db, ...allCommonDeps) {
            pageCurrentUserId = userId; pageDatabase = db;
            const [ fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeSearchableDropdown, commonInitializeSimpleDropdown ] = allCommonDeps;
            commonDependencies = { fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeSimpleDropdown };

            initializeSubNav();
            loadDataForActiveSubsection(); 
            initializeFilterControls();
            
            // Initialize Messaging with Firebase
            loadUserConversations(); 

            setupEventListeners(); 
            
            DOMElements.addItemBtn.addEventListener('click', () => {
                const activeSubSection = document.querySelector('#communicationSubNav .sub-nav-item.active').dataset.subsection;
                openModalForSubsection(activeSubSection);
            });
        }

        function initializeSubNav() {
            const subNavContainer = document.getElementById('communicationSubNav');
            const subsections = document.querySelectorAll('#communicationView .subsection-content');
            const subNavItems = subNavContainer.querySelectorAll('.sub-nav-item');
            let fab = DOMElements.addItemBtn;
            subNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    subNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const targetId = item.dataset.subsection + "Content";
                    subsections.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetId) content.classList.add('active');
                    });
                    loadDataForActiveSubsection(); 
                    if (item.dataset.subsection === 'messages') {
                        fab.style.display = 'none';
                        // loadUserConversations will handle rendering if needed
                        if (!currentConversationId && DOMElements.conversationList.firstChild) {
                            // If no conversation is selected, and list has items, select first.
                            // This logic might need adjustment based on how conversations are loaded/selected.
                        } else if (currentConversationId) {
                            loadMessagesForConversation(currentConversationId);
                        } else {
                            DOMElements.messageList.innerHTML = '<div class="communication-placeholder">Select a conversation to view messages.</div>';
                            if(DOMElements.currentConversationTitle) DOMElements.currentConversationTitle.textContent = 'Messages';
                        }
                    } else {
                        fab.style.display = 'flex';
                        if (messagesListener) messagesListener(); // Detach messages listener if navigating away
                        if (conversationsListener) conversationsListener(); // Detach conversations listener
                        messagesListener = null;
                        conversationsListener = null;
                        currentConversationId = null; // Clear active conversation
                    }
                });
            });
            const defaultActive = subNavContainer.querySelector('.sub-nav-item.active').dataset.subsection;
            if (defaultActive === 'messages') fab.style.display = 'none'; else fab.style.display = 'flex';
        }

        function renderActiveSubsectionData() {
            const activeSubSection = document.querySelector('#communicationSubNav .sub-nav-item.active').dataset.subsection;
            switch(activeSubSection) {
                case 'letters': renderLetters(); break;
                case 'forms': renderForms(); break;
            }
        }

        function initializeFilterControls() {
            document.querySelectorAll('.controls-container .custom-dropdown').forEach(dropdown => {
                commonDependencies.commonInitializeSimpleDropdown(dropdown, () => renderActiveSubsectionData());
            });

             document.querySelectorAll('.controls-toggle-btn').forEach(btn => {
                const controlsContainer = btn.nextElementSibling;
                const arrowIcon = btn.querySelector('.arrow-icon');
                if (!controlsContainer || !controlsContainer.classList.contains('controls-container')) return;
                btn.addEventListener('click', () => {
                    const isExpanded = controlsContainer.style.display === 'flex';
                    controlsContainer.style.display = isExpanded ? 'none' : 'flex';
                    if(arrowIcon) arrowIcon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
                });
                const isVisibleByDefault = controlsContainer.classList.contains('visible-by-default');
                if (isVisibleByDefault && window.innerWidth > 768) {
                    controlsContainer.style.display = 'flex';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(0deg)';
                } else {
                    controlsContainer.style.display = 'none';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(-90deg)';
                }
            });
        }
        
        function populateDynamicDropdown(dropdownId, optionsSet, allText) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            const optionsContainer = dropdown.querySelector('.dropdown-options');
            const selectedValueSpan = dropdown.querySelector('.selected-value');
            const currentValue = dropdown.dataset.value || '';
            optionsContainer.innerHTML = '';
            const allOption = document.createElement('div');
            allOption.className = 'dropdown-option';
            allOption.dataset.value = '';
            allOption.textContent = allText;
            optionsContainer.appendChild(allOption);
            Array.from(optionsSet).sort().forEach(optionValue => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.dataset.value = optionValue;
                option.textContent = optionValue;
                optionsContainer.appendChild(option);
            });
            const currentOption = optionsContainer.querySelector(`.dropdown-option[data-value="${currentValue}"]`);
            if (currentOption) {
                selectedValueSpan.textContent = currentOption.textContent;
                if(optionsContainer.querySelector('.selected')) optionsContainer.querySelector('.selected').classList.remove('selected');
                currentOption.classList.add('selected');
            } else {
                selectedValueSpan.textContent = allText;
                dropdown.dataset.value = '';
                if(optionsContainer.firstChild) optionsContainer.firstChild.classList.add('selected');
            }
        }

        function loadDataForActiveSubsection() {
            const activeSubSection = document.querySelector('#communicationSubNav .sub-nav-item.active').dataset.subsection;
            switch (activeSubSection) {
                case 'letters': loadLetters(); break;
                case 'forms': loadForms(); break;
                case 'messages': 
                    loadUserConversations(); // Ensure conversations are loaded when messages tab is active
                    if (!currentConversationId) {
                         if(DOMElements.currentConversationTitle) DOMElements.currentConversationTitle.textContent = 'Messages';
                         if(DOMElements.messageList) DOMElements.messageList.innerHTML = '<div class="communication-placeholder">Select a conversation.</div>';
                         if(DOMElements.messageActionsBtn) DOMElements.messageActionsBtn.style.display = 'none';
                    }
                    break;
            }
        }

        function setupEventListeners() {
            const forms = [
                {form: DOMElements.letterForm, path: 'letters', name: 'Letter/Notice', modalId: 'letterModal'},
                {form: DOMElements.formTemplateForm, path: 'forms', name: 'Form/Template', modalId: 'formModal'}
            ];
            forms.forEach(f => {
                if (f.form) f.form.addEventListener('submit', (e) => handleGenericFormSubmit(e, f.path, f.name, f.modalId));
            });

            // Messaging Event Listeners
            if (DOMElements.sendMessageBtn) {
                DOMElements.sendMessageBtn.addEventListener('click', handleSendMessage);
            }
            if (DOMElements.messageInput) {
                DOMElements.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
            }
            if (DOMElements.newConversationBtn) {
                DOMElements.newConversationBtn.addEventListener('click', () => {
                    openNewConversationModal();
                });
            }
            if (DOMElements.startConversationBtn) {
                DOMElements.startConversationBtn.addEventListener('click', handleStartConversation);
            }
            if (DOMElements.userSearchInput) {
                DOMElements.userSearchInput.addEventListener('input', (e) => renderUserList(e.target.value));
            }
            if(DOMElements.messageActionsBtn) {
                DOMElements.messageActionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if(currentConversationId) {
                        DOMElements.messageActionsMenu.style.display = DOMElements.messageActionsMenu.style.display === 'block' ? 'none' : 'block';
                    }
                });
            }
            if(DOMElements.deleteConversationBtn) {
                DOMElements.deleteConversationBtn.addEventListener('click', handleDeleteConversation);
            }
            if(DOMElements.archiveConversationBtn) {
                DOMElements.archiveConversationBtn.addEventListener('click', () => {
                    commonDependencies.commonShowAlert("Archiving conversations will be available soon!", "Feature Placeholder");
                    DOMElements.messageActionsMenu.style.display = 'none';
                });
            }
            // Hide menu if clicking outside
            window.addEventListener('click', (e) => {
                 // Close the actions menu if clicking outside of it
                if (DOMElements.messageActionsMenu.style.display === 'block' && !DOMElements.messageActionsMenu.contains(e.target) && !DOMElements.messageActionsBtn.contains(e.target)) {
                    DOMElements.messageActionsMenu.style.display = 'none';
                }
            });
        }
        
        // --- Relative Time Formatting ---
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const messageDate = new Date(timestamp);
            const diffSeconds = Math.floor((now - messageDate) / 1000);
            const diffDays = Math.floor(diffSeconds / 86400);

            if (diffSeconds < 60) return 'Just now';
            if (diffSeconds < 3600) return `${Math.floor(diffSeconds / 60)}m ago`;
            if (diffSeconds < 86400 && now.getDate() === messageDate.getDate()) {
                return messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            }
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays}d ago`;
            return messageDate.toLocaleDateString();
        }

        // Messaging Functions (Firebase Integrated)
        function loadUserConversations() {
            if (!pageCurrentUserId || !DOMElements.conversationList) return;

            if (conversationsListener) conversationsListener(); // Detach previous listener
            
            const conversationsRef = commonDependencies.fbRef(pageDatabase, `conversations/${pageCurrentUserId}`);
            // Order by last message timestamp, descending (most recent first)
            const conversationsQuery = commonDependencies.fbQuery(conversationsRef, commonDependencies.fbOrderByChild('lastMessageTimestamp'));

            conversationsListener = onValue(conversationsQuery, (snapshot) => {
                DOMElements.conversationList.innerHTML = '';
                let firstConversationId = null;
                let conversations = [];
                snapshot.forEach(childSnapshot => {
                    conversations.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                
                // Reverse to get descending order (Firebase returns ascending for numeric timestamps if not specified)
                conversations.reverse();

                if (conversations.length === 0) {
                    DOMElements.conversationList.innerHTML = '<li class="communication-placeholder">No conversations yet.</li>';
                    if(DOMElements.currentConversationTitle) DOMElements.currentConversationTitle.textContent = 'Messages';
                    if(DOMElements.messageList) DOMElements.messageList.innerHTML = '<div class="communication-placeholder">Start a new conversation!</div>';
                    if(DOMElements.messageActionsBtn) DOMElements.messageActionsBtn.style.display = 'none';
                    currentConversationId = null;
                    return;
                }

                conversations.forEach((conv, index) => {
                    if (index === 0 && !currentConversationId) { // Select the first conversation by default if none is active
                        firstConversationId = conv.id;
                    }
                    const li = document.createElement('li');
                    li.classList.add('conversation-item');
                    if (conv.id === currentConversationId) {
                        li.classList.add('active');
                    }
                    li.dataset.convId = conv.id;

                    const name = conv.name || 'Conversation'; // Default name
                    const avatarInitials = name.substring(0, 1) + (name.split(' ')[1] ? name.split(' ')[1].substring(0,1) : '');

                    li.innerHTML = `
                        <div class="conv-avatar">${avatarInitials.toUpperCase()}</div>
                        <div class="conv-details">
                            <div class="conv-name">${name}</div>
                            <div class="conv-preview">${conv.lastMessagePreview || 'No messages yet.'}</div>
                        </div>
                        <div class="conv-timestamp">${formatTimestamp(conv.lastMessageTimestamp)}</div>
                    `;
                    li.addEventListener('click', () => {
                        currentConversationId = conv.id;
                        loadUserConversations(); // Re-render to update active state
                        loadMessagesForConversation(conv.id);
                        if (DOMElements.currentConversationTitle) {
                            DOMElements.currentConversationTitle.textContent = `Conversation with ${name}`;
                        }
                    });
                    DOMElements.conversationList.appendChild(li);
                });

                if (firstConversationId && !currentConversationId) {
                    currentConversationId = firstConversationId;
                    loadMessagesForConversation(firstConversationId);
                     const firstConvData = conversations.find(c => c.id === firstConversationId);
                    if (DOMElements.currentConversationTitle && firstConvData) {
                        DOMElements.currentConversationTitle.textContent = `Conversation with ${firstConvData.name || 'Conversation'}`;
                    }
                     // Highlight the first conversation as active in the list
                    const activeLi = DOMElements.conversationList.querySelector(`[data-conv-id="${firstConversationId}"]`);
                    if (activeLi) activeLi.classList.add('active');
                } else if (currentConversationId) {
                    // Ensure the current conversation remains highlighted
                     const activeLi = DOMElements.conversationList.querySelector(`[data-conv-id="${currentConversationId}"]`);
                     if (activeLi) activeLi.classList.add('active');
                     else { // currentConversationId might no longer exist
                        currentConversationId = firstConversationId; // fallback
                        if(currentConversationId) {
                             loadMessagesForConversation(currentConversationId);
                             const firstConvData = conversations.find(c => c.id === firstConversationId);
                             if (DOMElements.currentConversationTitle && firstConvData) {
                                DOMElements.currentConversationTitle.textContent = `Conversation with ${firstConvData.name || 'Conversation'}`;
                             }
                             const newActiveLi = DOMElements.conversationList.querySelector(`[data-conv-id="${firstConversationId}"]`);
                             if (newActiveLi) newActiveLi.classList.add('active');
                        }
                     }
                }

            });
        }

        function loadMessagesForConversation(conversationId) {
            if (!pageCurrentUserId || !DOMElements.messageList || !conversationId) {
                if(DOMElements.messageList) DOMElements.messageList.innerHTML = '<div class="communication-placeholder">Select a conversation to view messages.</div>';
                if(DOMElements.messageActionsBtn) DOMElements.messageActionsBtn.style.display = 'none';
                return;
            }
            if(DOMElements.messageActionsBtn) DOMElements.messageActionsBtn.style.display = 'inline-block';
            currentConversationId = conversationId; // Ensure this is set

            if (messagesListener) messagesListener(); // Detach previous listener

            const messagesRef = commonDependencies.fbRef(pageDatabase, `messages/${conversationId}`);
            const messagesQuery = commonDependencies.fbQuery(messagesRef, commonDependencies.fbOrderByChild('timestamp')); // Order by time

            messagesListener = onValue(messagesQuery, (snapshot) => {
                DOMElements.messageList.innerHTML = '';
                if (!snapshot.exists()) {
                    DOMElements.messageList.innerHTML = '<div class="communication-placeholder">No messages in this conversation yet. Send one!</div>';
                    return;
                }
                snapshot.forEach(childSnapshot => {
                    const msg = { id: childSnapshot.key, ...childSnapshot.val() };
                    const msgItem = document.createElement('div');
                    const messageType = msg.senderId === pageCurrentUserId ? 'sent' : 'received';
                    msgItem.classList.add('message-item', messageType);
                    
                    const senderName = msg.senderName || (messageType === 'sent' ? 'You' : 'Other User');
                    const avatarInitials = senderName.substring(0,1) + (senderName.split(' ')[1] ? senderName.split(' ')[1].substring(0,1) : '');
                    let avatarHtml = `<div class="msg-avatar" title="${senderName}">${avatarInitials.toUpperCase()}</div>`;

                    if (messageType === 'received') {
                        msgItem.innerHTML = `
                            ${avatarHtml}
                            <div class="msg-bubble">
                                <div class="msg-sender">${senderName}</div>
                                <div class="msg-text">${msg.text}</div>
                                <div class="msg-timestamp">${formatTimestamp(msg.timestamp)}</div>
                            </div>
                        `;
                    } else { // 'sent'
                         msgItem.innerHTML = `
                            <div class="msg-bubble">
                                <div class="msg-text">${msg.text}</div>
                                <div class="msg-timestamp">${formatTimestamp(msg.timestamp)}</div>
                            </div>
                        `;
                    }

                    DOMElements.messageList.appendChild(msgItem);
                });
                DOMElements.messageList.scrollTop = DOMElements.messageList.scrollHeight;
            });
        }

        async function handleSendMessage() {
            if (!DOMElements.messageInput || !DOMElements.messageInput.value.trim() || !currentConversationId) {
                if (!currentConversationId) commonDependencies.commonShowAlert("No active conversation selected.", "Error");
                return;
            }
            const text = DOMElements.messageInput.value.trim();
            
            const newMessageData = {
                senderId: pageCurrentUserId,
                senderName: pageCurrentUserDisplayName, // Add sender's name
                text: text,
                timestamp: commonDependencies.fbServerTimestamp() // Use server timestamp
            };

            try {
                // Push new message to messages/{conversationId}
                const messageRef = commonDependencies.fbRef(pageDatabase, `messages/${currentConversationId}`);
                await commonDependencies.fbPush(messageRef, newMessageData);

                // Update conversation's last message preview and timestamp
                // Need to fetch participant UIDs from the conversation node
                const conversationRef = commonDependencies.fbRef(pageDatabase, `conversations/${pageCurrentUserId}/${currentConversationId}`);
                const convSnapshot = await commonDependencies.fbGetDbData(conversationRef);
                const conversationData = convSnapshot.val();

                if (conversationData && conversationData.participants) {
                    const updates = {};
                    // Update for current user
                    updates[`/conversations/${pageCurrentUserId}/${currentConversationId}/lastMessagePreview`] = text.substring(0, 40) + (text.length > 40 ? "..." : "");
                    updates[`/conversations/${pageCurrentUserId}/${currentConversationId}/lastMessageTimestamp`] = commonDependencies.fbServerTimestamp();
                    
                    // Update for other participants
                    Object.keys(conversationData.participants).forEach(participantId => {
                        if (participantId !== pageCurrentUserId) {
                            updates[`/conversations/${participantId}/${currentConversationId}/lastMessagePreview`] = text.substring(0, 40) + (text.length > 40 ? "..." : "");
                            updates[`/conversations/${participantId}/${currentConversationId}/lastMessageTimestamp`] = commonDependencies.fbServerTimestamp();
                            // Potentially add unread count logic here for the other participant
                        }
                    });
                    await commonDependencies.fbUpdateDbData(commonDependencies.fbRef(pageDatabase), updates);
                }
                
                DOMElements.messageInput.value = '';
                DOMElements.messageInput.focus();
                // Messages will re-render due to onValue listener in loadMessagesForConversation
                // Conversations list will re-render due to onValue listener in loadUserConversations
            } catch (error) {
                console.error("Error sending message:", error);
                commonDependencies.commonShowAlert("Failed to send message: " + error.message, "Error");
            }
        }

        async function handleGenericFormSubmit(e, firebasePath, itemName, modalId) {
            e.preventDefault();
            document.getElementById(modalId).style.display = 'none';
            
            if (!pageCurrentUserId) { commonDependencies.commonShowAlert('User not authenticated.'); return; }
            const form = e.target;
            const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
            const id = idInputName ? form.elements[idInputName].value : null;
            const data = {};
            for (let element of form.elements) {
                if (element.name && element.type !== 'submit' && element.type !== 'button') data[element.name] = element.value;
            }
            if(idInputName) delete data[idInputName];
            data.userId = pageCurrentUserId; data.updatedAt = commonDependencies.fbServerTimestamp();

            try {
                const path = `${firebasePath}/${pageCurrentUserId}`;
                if (id) {
                    const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                    const snapshot = await commonDependencies.fbGetDbData(itemRef);
                    const existingData = snapshot.val() || {};
                    await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                    commonDependencies.commonShowAlert(`${itemName} updated.`);
                } else {
                    data.createdAt = commonDependencies.fbServerTimestamp();
                    await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                    commonDependencies.commonShowAlert(`${itemName} added.`);
                }
            } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
        }

        function openModalForSubsection(subsection, id = null, data = {}) {
            let modal, form;
            switch (subsection) {
                case 'letters': modal = DOMElements.letterModal; form = DOMElements.letterForm; break;
                case 'forms': modal = DOMElements.formModal; form = DOMElements.formTemplateForm; break;
                default: return;
            }
            if (form) {
                form.reset();
                const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
                if(idInputName) form.elements[idInputName].value = id || '';
                for (const key in data) { if (form.elements[key]) form.elements[key].value = data[key]; }
            }
            if (modal) modal.style.display = 'flex';
        }

        async function handleDeleteGeneric(firebasePath, itemId, itemName) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await commonDependencies.commonShowConfirm(`Delete this ${itemName}?`);
            if (confirmed) {
                try {
                    await commonDependencies.fbRemove(commonDependencies.fbRef(pageDatabase, `${firebasePath}/${pageCurrentUserId}/${itemId}`));
                    commonDependencies.commonShowAlert(`${itemName} deleted.`);
                } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
            }
        }

        // Letters & Notices
        function loadLetters() {
            const dataRef = commonDependencies.fbRef(pageDatabase, `letters/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('updatedAt')), (snapshot) => {
                lettersData = [];
                snapshot.forEach(child => { lettersData.push({id: child.key, ...child.val()}); });
                renderLetters();
            });
        }
        function renderLetters() {
            DOMElements.lettersTableBody.innerHTML = ''; let hasData = false;
            const typeFilter = document.getElementById('lettersFilterType')?.dataset.value;
            const statusFilter = document.getElementById('lettersFilterStatus')?.dataset.value;

            const filteredData = lettersData.filter(item => {
                const matchesType = !typeFilter || item.recipientType === typeFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                return matchesType && matchesStatus;
            }).reverse();

            filteredData.forEach(item => { hasData = true; populateLetterRow(item); });
            DOMElements.noLettersMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateLetterRow(data) {
            const row = DOMElements.lettersTableBody.insertRow();
            row.insertCell().textContent = data.subject;
            row.insertCell().textContent = data.recipients || 'N/A';
            row.insertCell().textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleDateString() : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Draft').toLowerCase()}">${data.status || 'Draft'}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('letters', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('letters', data.id, 'Letter/Notice'); });
            row.addEventListener('click', () => openModalForSubsection('letters', data.id, data));
        }

        // Forms & Templates
        function loadForms() {
            const dataRef = commonDependencies.fbRef(pageDatabase, `forms/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('formName')), (snapshot) => {
                formsData = [];
                const categories = new Set();
                snapshot.forEach(child => { 
                    const form = {id: child.key, ...child.val()};
                    formsData.push(form);
                    if(form.category) categories.add(form.category);
                });
                populateDynamicDropdown('formsFilterCategory', categories, 'All Categories');
                renderForms();
            });
        }
        function renderForms() {
            DOMElements.formsTableBody.innerHTML = ''; let hasData = false;
            const categoryFilter = document.getElementById('formsFilterCategory')?.dataset.value;

            const filteredData = formsData.filter(item => {
                return !categoryFilter || item.category === categoryFilter;
            });

            filteredData.forEach(item => { hasData = true; populateFormRow(item); });
            DOMElements.noFormsMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateFormRow(data) {
            const row = DOMElements.formsTableBody.insertRow();
            row.insertCell().textContent = data.formName;
            row.insertCell().textContent = data.category || 'N/A';
            row.insertCell().textContent = data.updatedAt ? new Date(data.updatedAt).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.usageCount || 0; // Placeholder
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('forms', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('forms', data.id, 'Form/Template'); });
            row.addEventListener('click', () => openModalForSubsection('forms', data.id, data));
        }

        // --- New Conversation Functions ---
        async function openNewConversationModal() {
            DOMElements.newConversationModal.style.display = 'flex';
            DOMElements.usersForConversationList.innerHTML = '<div class="communication-placeholder" style="margin: 0; padding: 20px;">Loading users...</div>';
            await fetchAllUsers();
            renderUserList();
        }

        async function fetchAllUsers() {
             if (!pageCurrentUserId || !pageDatabase) return;
            allUsers = [];
            const userTypes = ['tenants', 'owners', 'vendors'];
            
            try {
                const promises = userTypes.map(type => {
                    const dataRef = commonDependencies.fbRef(pageDatabase, `${type}/${pageCurrentUserId}`);
                    return commonDependencies.fbGetDbData(dataRef);
                });

                const snapshots = await Promise.all(promises);

                snapshots.forEach((snapshot, index) => {
                    if (snapshot.exists()) {
                        const userType = userTypes[index];
                        snapshot.forEach(childSnapshot => {
                            const userData = childSnapshot.val();
                            const name = userData.fullName || userData.companyName || userData.email;
                            const id = userData.authUid; // Only consider users with an explicit authUid

                            // Only add if they have a valid authUid and it's not the current user
                            if (id && id !== pageCurrentUserId) {
                                allUsers.push({ 
                                    uid: id, 
                                    displayName: name, 
                                    email: userData.email || '',
                                    type: userType.slice(0, -1) // e.g., 'tenant'
                                });
                            }
                        });
                    }
                });
                 // Remove duplicates, in case a person exists in multiple lists with the same UID
                allUsers = allUsers.filter((user, index, self) =>
                    index === self.findIndex((u) => u.uid === user.uid)
                );

            } catch (error) {
                console.error("Error fetching users:", error);
                commonDependencies.commonShowAlert("Could not load users. " + error.message, "Error");
                DOMElements.usersForConversationList.innerHTML = '<div class="communication-placeholder" style="margin: 0; padding: 20px;">Could not load users.</div>';
            }
        }

        function renderUserList(searchTerm = '') {
            const listElement = DOMElements.usersForConversationList;
            listElement.innerHTML = '';
            const filteredUsers = allUsers.filter(user => 
                (user.displayName && user.displayName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (user.email && user.email.toLowerCase().includes(searchTerm.toLowerCase()))
            );

            if (filteredUsers.length === 0) {
                listElement.innerHTML = '<div class="communication-placeholder" style="margin: 0; padding: 20px;">No users found.</div>';
                return;
            }

            filteredUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.dataset.uid = user.uid;
                userItem.innerHTML = `
                    <input type="checkbox" class="user-select-checkbox" data-uid="${user.uid}">
                    <span class="user-name">${user.displayName || user.email}</span>
                `;
                userItem.addEventListener('click', (e) => {
                    // Toggle checkbox when clicking the item, but not on the checkbox itself
                    if (e.target.type !== 'checkbox') {
                       const checkbox = userItem.querySelector('.user-select-checkbox');
                       checkbox.checked = !checkbox.checked;
                    }
                });
                listElement.appendChild(userItem);
            });
        }

       async function handleStartConversation() {
            const selectedCheckboxes = DOMElements.usersForConversationList.querySelectorAll('.user-select-checkbox:checked');
            if (selectedCheckboxes.length === 0) {
                commonDependencies.commonShowAlert("Please select at least one user.", "Error");
                return;
            }

            const participantIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.uid);
            const allParticipantIds = [pageCurrentUserId, ...participantIds];

            // This part might need adjustment if a user's own `authUid` is not the same as `pageCurrentUserId`
            // For now, we assume the UID from the list is a valid, messageable auth UID.
            const participants = {};
            const participantNames = [pageCurrentUserDisplayName];
            allUsers.forEach(u => {
                if (participantIds.includes(u.uid)) {
                    participantNames.push(u.displayName || u.email);
                    participants[u.uid] = { displayName: u.displayName || u.email };
                }
            });
            participants[pageCurrentUserId] = { displayName: pageCurrentUserDisplayName };

            let conversationName = "Conversation";
            if (participantNames.length <= 2) {
                conversationName = participantNames.filter(name => name !== pageCurrentUserDisplayName)[0] || 'New Conversation';
            } else {
                conversationName = participantNames.map(name => name.split(' ')[0]).join(', ');
                if(conversationName.length > 50) conversationName = "Group Conversation";
            }
            
            try {
                const newConversationRef = commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, 'messages'));
                const newConversationId = newConversationRef.key;

                const conversationData = {
                    name: conversationName,
                    participants: participants,
                    createdAt: commonDependencies.fbServerTimestamp(),
                    lastMessageTimestamp: commonDependencies.fbServerTimestamp(), // Set initial timestamp for sorting
                    createdBy: pageCurrentUserId,
                    lastMessagePreview: "Conversation started."
                };

                const updates = {};
                allParticipantIds.forEach(id => {
                    updates[`/conversations/${id}/${newConversationId}`] = conversationData;
                });
                
                await commonDependencies.fbUpdateDbData(commonDependencies.fbRef(pageDatabase), updates);

                DOMElements.newConversationModal.style.display = 'none';
                currentConversationId = newConversationId; // Set as active conversation
                loadUserConversations(); // Refresh conversation list
                loadMessagesForConversation(newConversationId); // Load the new (empty) conversation
                if (DOMElements.currentConversationTitle) {
                    DOMElements.currentConversationTitle.textContent = `Conversation with ${conversationName}`;
                }

            } catch (error) {
                console.error("Error creating conversation:", error);
                commonDependencies.commonShowAlert("Failed to start conversation.", "Error");
            }
        }
        
        async function handleDeleteConversation() {
            if (!currentConversationId || !pageCurrentUserId) return;
            DOMElements.messageActionsMenu.style.display = 'none'; // Hide menu

            const confirmed = await commonDependencies.commonShowConfirm("Are you sure you want to delete this conversation? This only removes it for you.");
            if (confirmed) {
                try {
                    const conversationRef = commonDependencies.fbRef(pageDatabase, `conversations/${pageCurrentUserId}/${currentConversationId}`);
                    await commonDependencies.fbRemove(conversationRef);

                    // UI Cleanup
                    DOMElements.messageList.innerHTML = '<div class="communication-placeholder">Select a conversation.</div>';
                    DOMElements.currentConversationTitle.textContent = 'Messages';
                    DOMElements.messageActionsBtn.style.display = 'none';
                    currentConversationId = null; // Unset active conversation
                    // The onValue listener in loadUserConversations will handle removing it from the list.
                    commonDependencies.commonShowAlert("Conversation deleted.");
                } catch (error) {
                    console.error("Error deleting conversation:", error);
                    commonDependencies.commonShowAlert("Failed to delete conversation.", "Error");
                }
            }
        }

        initializeAuth(pageInit);
    </script>
</body>
</html> 