<!DOCTYPE html>
<html lang="en" class="js-loading">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporting - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="/js/fouc-prevention.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        .sub-nav { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .sub-nav-item { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; color: #555; transition: color 0.2s ease, border-bottom-color 0.2s ease; }
        .sub-nav-item:hover { color: #000; }
        .sub-nav-item.active { color: #000; border-bottom-color: #000; }
        .subsection-content { display: none; }
        .subsection-content.active { display: block; }
        .report-placeholder { padding: 20px; background-color: #f8f9fa; border: 1px dashed #ced4da; border-radius: 8px; text-align: center; color: #6c757d; margin-top: 15px;}
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .metric-card { padding: 20px; background-color: #f8f9fa; border: 1px solid #ced4da; border-radius: 8px; }
        .metric-value-large { font-size: 24px; font-weight: bold; }
        .metric-trend { color: #6c757d; }
        .metric-chart-placeholder { margin-top: 10px; }
        .charts-area { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .chart-container { 
            position: relative; 
            display: flex;
            flex-direction: column;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        .chart-container h5 {
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }
        .chart-container.full-width { flex-basis: 100%; height: 350px; }
        .chart-container.half-width { flex-basis: calc(50% - 10px); height: 300px; }
        
        /* Styles for generated reports */
        .report-view-area { padding: 20px; background-color: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-top: 15px; min-height: 300px; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .report-header h4 { margin: 0; }
        .report-actions button { margin-left: 10px; }
        .report-table { width: 100%; border-collapse: collapse; }
        .report-table th, .report-table td { padding: 8px 12px; border: 1px solid #ddd; text-align: left; }
        .report-table th { background-color: #f2f2f2; }
        .report-summary { margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 4px; }
        .report-summary p { margin: 5px 0; font-weight: 500; }
        .empty-report-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; color: #6c757d; text-align: center; }
        .empty-report-state .icon { font-size: 48px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div class="content-scroll-wrapper">
            <div id="reportingView">
                <div class="content-header"><h2>Reporting</h2></div>
                <div class="page-container">
                    <div class="sub-nav" id="reportingSubNav">
                        <div class="sub-nav-item active" data-subsection="reports">Reports</div>
                        <div class="sub-nav-item" data-subsection="scheduledReports">Scheduled Reports</div>
                        <div class="sub-nav-item" data-subsection="metrics">Metrics</div>
                        <div class="sub-nav-item" data-subsection="surveys">Surveys</div>
                    </div>

                    <div class="subsection-content active" id="reportsContent">
                        <h4>Reports</h4>
                        <p>Generate and view various financial, operational, and leasing reports.</p>
                        <div class="report-placeholder"></div>
                        <!-- Future: Filters for report types, date ranges, export options -->
                    </div>

                    <div class="subsection-content" id="scheduledReportsContent">
                        <h4>Scheduled Reports</h4>
                        <div class="controls-container visible-by-default">
                            <div class="filter-group">
                                <label>Report Name:</label>
                                <div class="custom-dropdown" id="scheduledFilterName">
                                    <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Reports</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                    <div class="dropdown-options"><div class="dropdown-option" data-value="">All Reports</div></div>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label>Frequency:</label>
                                <div class="custom-dropdown" id="scheduledFilterFrequency">
                                    <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Frequencies</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                    <div class="dropdown-options">
                                        <div class="dropdown-option" data-value="">All Frequencies</div>
                                        <div class="dropdown-option" data-value="Daily">Daily</div>
                                        <div class="dropdown-option" data-value="Weekly">Weekly</div>
                                        <div class="dropdown-option" data-value="Monthly">Monthly</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <div class="data-table-container">
                            <table class="data-table" id="scheduledReportsTable">
                                <thead><tr><th>Report Name</th><th>Frequency</th><th>Next Run Date</th><th>Recipients</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="scheduledReportsTableBody"></tbody>
                            </table>
                            <div id="noScheduledReportsMessage" class="no-data-message"><div class="icon">üóìÔ∏è</div><p>No reports currently scheduled.</p></div>
                        </div>
                    </div>

                    <div class="subsection-content" id="metricsContent">
                        <h4>Metrics & Analytics Dashboard</h4>
                        <p>Visualize key performance indicators (KPIs) and trends across your portfolio to make data-driven decisions.</p>
                        <div class="metrics-grid">
                            <div class="metric-card">
                                <h5>Occupancy Rate</h5>
                                <div class="metric-value-large"></div>
                                <div class="metric-trend"></div>
                            </div>
                            <div class="metric-card">
                                <h5>Average Delinquency</h5>
                                <div class="metric-value-large"></div>
                                <div class="metric-trend"></div>
                            </div>
                            <div class="metric-card">
                                <h5>Maintenance Costs (This Month)</h5>
                                <div class="metric-value-large"></div>
                                <div class="metric-trend"></div>
                            </div>
                            <div class="metric-card">
                                <h5>Lease Renewals (Last 90d)</h5>
                                <div class="metric-value-large"></div>
                                <div class="metric-trend"></div>
                            </div>
                        </div>
                        <div class="charts-area">
                            <div class="chart-container full-width">
                                <h5>Revenue vs. Expenses (Last 12 Months)</h5>
                                <canvas id="revenueExpensesChart"></canvas>
                            </div>
                            <div class="chart-container half-width">
                                <h5>Work Order Completion by Priority</h5>
                                 <canvas id="workOrderCompletionChart"></canvas>
                            </div>
                            <div class="chart-container half-width">
                                <h5>Vacancy Duration Analysis (Days)</h5>
                                <canvas id="vacancyDurationChart"></canvas>
                            </div>
                            <!-- More charts and KPI visualizations can be added here -->
                        </div>
                    </div>

                    <div class="subsection-content" id="surveysContent">
                        <h4>Surveys</h4>
                        <div class="controls-container visible-by-default">
                            <div class="filter-group">
                                <label>Target Audience:</label>
                                <div class="custom-dropdown" id="surveysFilterAudience">
                                    <div class="dropdown-selected" tabindex="0"><span class="selected-value">All</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                    <div class="dropdown-options">
                                        <div class="dropdown-option" data-value="">All</div>
                                        <div class="dropdown-option" data-value="Tenants">Tenants</div>
                                        <div class="dropdown-option" data-value="Owners">Owners</div>
                                        <div class="dropdown-option" data-value="All">All</div>
                                    </div>
                                </div>
                            </div>
                             <div class="filter-group">
                                <label>Status:</label>
                                <div class="custom-dropdown" id="surveysFilterStatus">
                                    <div class="dropdown-selected" tabindex="0"><span class="selected-value">All Statuses</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div>
                                    <div class="dropdown-options">
                                        <div class="dropdown-option" data-value="">All Statuses</div>
                                        <div class="dropdown-option" data-value="Draft">Draft</div>
                                        <div class="dropdown-option" data-value="Active">Active</div>
                                        <div class="dropdown-option" data-value="Closed">Closed</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="data-table-container">
                            <table class="data-table" id="surveysTable">
                                <thead><tr><th>Survey Title</th><th>Target Audience</th><th>Date Created</th><th>Responses</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="surveysTableBody"></tbody>
                            </table>
                            <div id="noSurveysMessage" class="no-data-message"><div class="icon">‚ùì</div><p>No surveys created yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="fab" id="addItemBtn" aria-label="Add new report/survey">+</button>
    </div>

    <div id="ai-agent-container"></div>

    <!-- Modals -->
    <div id="scheduledReportModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Schedule New Report</h3><button class="close-btn" data-modal-id="scheduledReportModal">&times;</button></div><form id="scheduledReportForm"><input type="hidden" name="scheduledReportId"><div class="form-group"><label>Report Type</label><select name="reportType"><option>Occupancy Summary</option><option>Rent Roll</option><option>Delinquency Report</option></select></div><div class="form-group"><label>Frequency</label><select name="frequency"><option>Daily</option><option>Weekly</option><option>Monthly</option></select></div><div class="form-group"><label>Recipients (comma-separated emails)</label><input type="text" name="recipients"></div><div class="form-group"><label>Status</label><select name="status"><option>Active</option><option>Paused</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="scheduledReportModal">Cancel</button><button type="submit" class="submit-btn">Save Schedule</button></div></form></div></div>
    <div id="surveyModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Create/Edit Survey</h3><button class="close-btn" data-modal-id="surveyModal">&times;</button></div><form id="surveyForm"><input type="hidden" name="surveyId"><div class="form-group"><label>Survey Title</label><input type="text" name="surveyTitle" required></div><div class="form-group"><label>Target Audience</label><select name="targetAudience"><option>Tenants</option><option>Owners</option><option>All</option></select></div><div class="form-group"><label>Description/Questions</label><textarea name="description" rows="5" placeholder="Enter survey questions here..."></textarea></div><div class="form-group"><label>Status</label><select name="status"><option>Draft</option><option>Active</option><option>Closed</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="surveyModal">Cancel</button><button type="submit" class="submit-btn">Save Survey</button></div></form></div></div>

    <div id="customAlertModal"><div class="custom-alert"><p></p></div></div>
    <div id="customConfirmModal" class="modal"><div class="modal-content confirm-modal-content"><div class="modal-header"><h3 id="customConfirmTitle"></h3><button class="close-btn" data-modal-id="customConfirmModal">&times;</button></div><div class="modal-body"><p id="customConfirmMessage"></p></div><div class="modal-footer"><button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button><button class="confirm-btn" id="customConfirmOk">OK</button></div></div></div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, initializeSimpleDropdown, hasAccess } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let pageCurrentUserId, pageDatabase; let commonDependencies = {};
        let activeCharts = {};

        // Data caches
        let scheduledReportsData = [];
        let surveysData = [];

        const DOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            scheduledReportModal: document.getElementById('scheduledReportModal'), scheduledReportForm: document.getElementById('scheduledReportForm'),
            surveyModal: document.getElementById('surveyModal'), surveyForm: document.getElementById('surveyForm'),
            scheduledReportsTableBody: document.getElementById('scheduledReportsTableBody'), noScheduledReportsMessage: document.getElementById('noScheduledReportsMessage'),
            surveysTableBody: document.getElementById('surveysTableBody'), noSurveysMessage: document.getElementById('noSurveysMessage'),
            reportsContent: document.getElementById('reportsContent'),
            reportSelectionContainer: null,
            reportViewArea: null,
            metricsContent: document.getElementById('metricsContent'),
            kpiOccupancyRateValue: null, kpiOccupancyRateTrend: null,
            kpiAvgDelinquencyValue: null, kpiAvgDelinquencyTrend: null,
            kpiMaintenanceCostsValue: null, kpiMaintenanceCostsTrend: null,
            kpiLeaseRenewalsValue: null, kpiLeaseRenewalsTrend: null,
            revenueExpensesChart: document.getElementById('revenueExpensesChart'),
            workOrderCompletionChart: document.getElementById('workOrderCompletionChart'),
            vacancyDurationChart: document.getElementById('vacancyDurationChart')
        };

        function pageInit(userId, db, ...allCommonDeps) {
            pageCurrentUserId = userId; pageDatabase = db;
            const [ fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeSimpleDropdown, commonHasAccess ] = allCommonDeps;
            commonDependencies = { fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, initializeSimpleDropdown, hasAccess: commonHasAccess };

            initializeSubNav();
            loadDataForActiveSubsection();
            setupEventListeners();
            setupReportAndMetricsDOMElements();
            initializeFilterControls();
            
            DOMElements.addItemBtn.addEventListener('click', () => {
                const activeSubSection = document.querySelector('#reportingSubNav .sub-nav-item.active').dataset.subsection;
                openModalForSubsection(activeSubSection);
            });

            // Gate features based on plan
            if (!hasAccess('plus')) {
                const metricsNavItem = document.querySelector('[data-subsection="metrics"]');
                if (metricsNavItem) metricsNavItem.style.display = 'none';

                const metricsContent = document.getElementById('metricsContent');
                if (metricsContent) metricsContent.style.display = 'none';
            }
        }

        function initializeSubNav() {
            const subNavContainer = document.getElementById('reportingSubNav');
            const subsections = document.querySelectorAll('#reportingView .subsection-content');
            const subNavItems = subNavContainer.querySelectorAll('.sub-nav-item');
            let fab = DOMElements.addItemBtn;
            // Hide FAB by default, show it for specific tabs.
            fab.style.display = 'none'; 

            subNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    subNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const targetId = item.dataset.subsection + "Content";
                    subsections.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetId) content.classList.add('active');
                    });
                    
                    // Destroy charts before loading new data to prevent canvas reuse issues
                    Object.values(activeCharts).forEach(chart => chart.destroy());
                    activeCharts = {};

                    loadDataForActiveSubsection();
                    
                    // Show FAB only for sections where adding makes sense
                    if (item.dataset.subsection === 'scheduledReports' || item.dataset.subsection === 'surveys') {
                        fab.style.display = 'flex';
                    } else {
                        fab.style.display = 'none';
                    }
                });
            });
            // Initial FAB state based on default active tab
            const defaultActive = subNavContainer.querySelector('.sub-nav-item.active').dataset.subsection;
            if (defaultActive === 'scheduledReports' || defaultActive === 'surveys') fab.style.display = 'flex'; else fab.style.display = 'none';
        }

        function renderActiveSubsectionData() {
            const activeSubSection = document.querySelector('#reportingSubNav .sub-nav-item.active').dataset.subsection;
            switch(activeSubSection) {
                case 'scheduledReports': renderScheduledReports(); break;
                case 'surveys': renderSurveys(); break;
            }
        }

        function initializeFilterControls() {
            document.querySelectorAll('.controls-container .custom-dropdown').forEach(dropdown => {
                initializeSimpleDropdown(dropdown, () => renderActiveSubsectionData());
            });

             document.querySelectorAll('.controls-toggle-btn').forEach(btn => {
                const controlsContainer = btn.nextElementSibling;
                const arrowIcon = btn.querySelector('.arrow-icon');
                if (!controlsContainer || !controlsContainer.classList.contains('controls-container')) return;
                btn.addEventListener('click', () => {
                    const isExpanded = controlsContainer.style.display === 'flex';
                    controlsContainer.style.display = isExpanded ? 'none' : 'flex';
                    if(arrowIcon) arrowIcon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
                });
                const isVisibleByDefault = controlsContainer.classList.contains('visible-by-default');
                if (isVisibleByDefault && window.innerWidth > 768) {
                    controlsContainer.style.display = 'flex';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(0deg)';
                } else {
                    controlsContainer.style.display = 'none';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(-90deg)';
                }
            });
        }

        function populateDynamicDropdown(dropdownId, optionsSet, allText) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            const optionsContainer = dropdown.querySelector('.dropdown-options');
            const selectedValueSpan = dropdown.querySelector('.selected-value');
            const currentValue = dropdown.dataset.value || '';
            optionsContainer.innerHTML = '';
            const allOption = document.createElement('div');
            allOption.className = 'dropdown-option';
            allOption.dataset.value = '';
            allOption.textContent = allText;
            optionsContainer.appendChild(allOption);
            Array.from(optionsSet).sort().forEach(optionValue => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.dataset.value = optionValue;
                option.textContent = optionValue;
                optionsContainer.appendChild(option);
            });
            const currentOption = optionsContainer.querySelector(`.dropdown-option[data-value="${currentValue}"]`);
            if (currentOption) {
                selectedValueSpan.textContent = currentOption.textContent;
                if(optionsContainer.querySelector('.selected')) optionsContainer.querySelector('.selected').classList.remove('selected');
                currentOption.classList.add('selected');
            } else {
                selectedValueSpan.textContent = allText;
                dropdown.dataset.value = '';
                if(optionsContainer.firstChild) optionsContainer.firstChild.classList.add('selected');
            }
        }

        function loadDataForActiveSubsection() {
            const activeSubSection = document.querySelector('#reportingSubNav .sub-nav-item.active').dataset.subsection;
            switch (activeSubSection) {
                case 'reports': loadAvailableReports(); break;
                case 'metrics': loadMetricsData(); break;
                case 'scheduledReports': loadScheduledReports(); break;
                case 'surveys': loadSurveys(); break;
            }
        }

        function setupEventListeners() {
            const forms = [
                {form: DOMElements.scheduledReportForm, path: 'scheduledReports', name: 'Scheduled Report'},
                {form: DOMElements.surveyForm, path: 'surveys', name: 'Survey'}
            ];
            forms.forEach(f => {
                if (f.form) f.form.addEventListener('submit', (e) => handleGenericFormSubmit(e, f.path, f.name, f.form.id.replace('Form','Modal')));
            });
        }

        async function handleGenericFormSubmit(e, firebasePath, itemName, modalId) {
            e.preventDefault();
            if (!pageCurrentUserId) { commonDependencies.commonShowAlert('User not authenticated.'); return; }
            const form = e.target;
            const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
            const id = idInputName ? form.elements[idInputName].value : null;
            const data = {};
            for (let element of form.elements) {
                if (element.name && element.type !== 'submit' && element.type !== 'button') data[element.name] = element.value;
            }
            if(idInputName) delete data[idInputName];
            data.userId = pageCurrentUserId; data.updatedAt = commonDependencies.fbServerTimestamp();

            try {
                const path = `${firebasePath}/${pageCurrentUserId}`;
                if (id) {
                    const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                    const snapshot = await commonDependencies.fbGetDbData(itemRef);
                    const existingData = snapshot.val() || {};
                    await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                    commonDependencies.commonShowAlert(`${itemName} updated.`);
                } else {
                    data.createdAt = commonDependencies.fbServerTimestamp();
                    await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                    commonDependencies.commonShowAlert(`${itemName} added.`);
                }
                document.getElementById(modalId).style.display = 'none';
            } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
        }

        function openModalForSubsection(subsection, id = null, data = {}) {
            let modal, form;
            switch (subsection) {
                case 'scheduledReports': modal = DOMElements.scheduledReportModal; form = DOMElements.scheduledReportForm; break;
                case 'surveys': modal = DOMElements.surveyModal; form = DOMElements.surveyForm; break;
                default: 
                    commonDependencies.commonShowAlert("This section does not support adding new items directly.", "Info");
                    return;
            }
            if (form) {
                form.reset();
                const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
                if(idInputName) form.elements[idInputName].value = id || '';
                for (const key in data) { if (form.elements[key]) form.elements[key].value = data[key]; }
            }
            if (modal) modal.style.display = 'flex';
        }

        async function handleDeleteGeneric(firebasePath, itemId, itemName) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await commonDependencies.commonShowConfirm(`Delete this ${itemName}?`);
            if (confirmed) {
                try {
                    await commonDependencies.fbRemove(commonDependencies.fbRef(pageDatabase, `${firebasePath}/${pageCurrentUserId}/${itemId}`));
                    commonDependencies.commonShowAlert(`${itemName} deleted.`);
                } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
            }
        }

        // Scheduled Reports
        function loadScheduledReports() {
            const dataRef = commonDependencies.fbRef(pageDatabase, `scheduledReports/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('reportType')), (snapshot) => {
                scheduledReportsData = [];
                const reportNames = new Set();
                snapshot.forEach(child => {
                    const report = {id: child.key, ...child.val()};
                    scheduledReportsData.push(report);
                    if(report.reportType) reportNames.add(report.reportType);
                });
                populateDynamicDropdown('scheduledFilterName', reportNames, 'All Reports');
                renderScheduledReports();
            });
        }
        function renderScheduledReports() {
            DOMElements.scheduledReportsTableBody.innerHTML = ''; let hasData = false;
            const nameFilter = document.getElementById('scheduledFilterName')?.dataset.value;
            const frequencyFilter = document.getElementById('scheduledFilterFrequency')?.dataset.value;
            
            const filteredData = scheduledReportsData.filter(item => {
                const matchesName = !nameFilter || item.reportType === nameFilter;
                const matchesFrequency = !frequencyFilter || item.frequency === frequencyFilter;
                return matchesName && matchesFrequency;
            });
            
            filteredData.forEach(item => { hasData = true; populateScheduledReportRow(item); });
            DOMElements.noScheduledReportsMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateScheduledReportRow(data) {
            const row = DOMElements.scheduledReportsTableBody.insertRow();
            row.insertCell().textContent = data.reportType || 'N/A';
            row.insertCell().textContent = data.frequency || 'N/A';
            row.insertCell().textContent = data.nextRunDate || 'N/A';
            row.insertCell().textContent = data.recipients || 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Paused').toLowerCase()}">${data.status || 'Paused'}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('scheduledReports', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('scheduledReports', data.id, 'Scheduled Report');});
            row.addEventListener('click', (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('button')) openModalForSubsection('scheduledReports', data.id, data);});
        }

        // Surveys
        function loadSurveys() {
            const dataRef = commonDependencies.fbRef(pageDatabase, `surveys/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('surveyTitle')), (snapshot) => {
                surveysData = [];
                snapshot.forEach(child => { surveysData.push({id: child.key, ...child.val()}); });
                renderSurveys();
            });
        }
        function renderSurveys() {
            DOMElements.surveysTableBody.innerHTML = ''; let hasData = false;
            const audienceFilter = document.getElementById('surveysFilterAudience')?.dataset.value;
            const statusFilter = document.getElementById('surveysFilterStatus')?.dataset.value;

            const filteredData = surveysData.filter(item => {
                const matchesAudience = !audienceFilter || item.targetAudience === audienceFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                return matchesAudience && matchesStatus;
            });

            filteredData.forEach(item => { hasData = true; populateSurveyRow(item); });
            DOMElements.noSurveysMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateSurveyRow(data) {
            const row = DOMElements.surveysTableBody.insertRow();
            row.insertCell().textContent = data.surveyTitle || 'N/A';
            row.insertCell().textContent = data.targetAudience || 'N/A';
            row.insertCell().textContent = data.createdAt ? new Date(data.createdAt).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.responsesCount || 0;
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Draft').toLowerCase()}">${data.status || 'Draft'}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('surveys', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('surveys', data.id, 'Survey');});
            row.addEventListener('click', (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('button')) openModalForSubsection('surveys', data.id, data);});
        }

        function setupReportAndMetricsDOMElements() {
            // Reports section
            if (DOMElements.reportsContent) {
                const placeholder = DOMElements.reportsContent.querySelector('.report-placeholder');
                if(placeholder) placeholder.remove(); // Remove old static placeholder

                DOMElements.reportSelectionContainer = document.createElement('div');
                DOMElements.reportSelectionContainer.className = 'report-selection-container';
                DOMElements.reportSelectionContainer.style.marginBottom = '20px';
                
                DOMElements.reportViewArea = document.createElement('div');
                DOMElements.reportViewArea.className = 'report-view-area'; 
                
                DOMElements.reportsContent.appendChild(DOMElements.reportSelectionContainer);
                DOMElements.reportsContent.appendChild(DOMElements.reportViewArea);
            }

            // Metrics section - KPI cards
            const metricsGrid = DOMElements.metricsContent.querySelector('.metrics-grid');
            if (metricsGrid) {
                const kpiCards = metricsGrid.children;
                if (kpiCards.length >= 4) {
                    DOMElements.kpiOccupancyRateValue = kpiCards[0].querySelector('.metric-value-large');
                    DOMElements.kpiOccupancyRateTrend = kpiCards[0].querySelector('.metric-trend');
                    
                    DOMElements.kpiAvgDelinquencyValue = kpiCards[1].querySelector('.metric-value-large');
                    DOMElements.kpiAvgDelinquencyTrend = kpiCards[1].querySelector('.metric-trend');

                    DOMElements.kpiMaintenanceCostsValue = kpiCards[2].querySelector('.metric-value-large');
                    DOMElements.kpiMaintenanceCostsTrend = kpiCards[2].querySelector('.metric-trend');

                    DOMElements.kpiLeaseRenewalsValue = kpiCards[3].querySelector('.metric-value-large');
                    DOMElements.kpiLeaseRenewalsTrend = kpiCards[3].querySelector('.metric-trend');
                }
            }
        }

        const availableReports = [
            { id: 'occupancy_summary', name: 'Occupancy Summary', description: 'Overview of property occupancy rates.', generator: generateOccupancySummary },
            { id: 'rent_roll', name: 'Rent Roll', description: 'Detailed list of tenants and rent status.', generator: generateRentRollReport },
            { id: 'delinquency_report', name: 'Delinquency Report', description: 'List of tenants with overdue payments.', generator: generateDelinquencyReport },
            { id: 'maintenance_activity', name: 'Maintenance Activity', description: 'Summary of work orders and maintenance tasks.', generator: generateMaintenanceActivityReport },
            { id: 'financial_statement', name: 'Financial Statement', description: 'Income, expenses, and overall financial health.', generator: generateFinancialStatementReport },
            { id: 'lease_expiration', name: 'Lease Expiration Report', description: 'Lists leases expiring within a selected timeframe.', generator: generateLeaseExpirationReport }
        ];

        function loadAvailableReports() {
            if (!DOMElements.reportSelectionContainer) return;
            DOMElements.reportSelectionContainer.innerHTML = '<h5>Select a Report:</h5>';
            
            const reportList = document.createElement('div');
            reportList.className = 'buttons-group'; // For styling as a group of buttons
            reportList.style.display = 'flex';
            reportList.style.gap = '10px';
            reportList.style.flexWrap = 'wrap';

            availableReports.forEach(report => {
                const button = document.createElement('button');
                button.className = 'btn-secondary';
                button.textContent = report.name;
                button.dataset.reportId = report.id;
                button.title = report.description;
                button.addEventListener('click', () => displayReport(report));
                reportList.appendChild(button);
            });
            DOMElements.reportSelectionContainer.appendChild(reportList);
            if(DOMElements.reportViewArea) {
                 DOMElements.reportViewArea.innerHTML = `
                    <div class="empty-report-state">
                        <div class="icon">üìÑ</div>
                        <p>Select a report to generate and view its details here.</p>
                    </div>
                `;
            }
        }

        async function displayReport(report) {
            if (!DOMElements.reportViewArea) return;

            // Show a loading state
            DOMElements.reportViewArea.innerHTML = `
                <div class="empty-report-state">
                    <div class="icon">‚è≥</div>
                    <p>Generating ${report.name}...</p>
                </div>
            `;
            
            try {
                // The generator function is now responsible for fetching data and returning HTML
                const reportHtml = await report.generator();
                DOMElements.reportViewArea.innerHTML = reportHtml;
                
                // Add event listeners for actions like print or export
                const printBtn = DOMElements.reportViewArea.querySelector('.report-print-btn');
                if(printBtn) printBtn.addEventListener('click', handlePrintReport);

                const exportBtn = DOMElements.reportViewArea.querySelector('.report-export-btn');
                if(exportBtn) exportBtn.addEventListener('click', handleExportReport);

            } catch (error) {
                console.error(`Error generating report ${report.name}:`, error);
                DOMElements.reportViewArea.innerHTML = `
                    <div class="empty-report-state">
                         <div class="icon">‚ö†Ô∏è</div>
                         <p>Could not generate ${report.name}.</p>
                         <p style="font-size: 0.8em; color: #dc3545;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // --- Data Fetching Helpers ---
        async function fetchAllData(dataType) {
            const dataRef = commonDependencies.fbRef(pageDatabase, `${dataType}/${pageCurrentUserId}`);
            const snapshot = await commonDependencies.fbGetDbData(dataRef);
            const data = snapshot.val() || {};
            // Convert to array and include ID
            return Object.keys(data).map(id => ({ id, ...data[id] }));
        }

        // --- Report Generation Functions ---
        function getReportHTML(title, tableHeaders, tableBodyRows, summary) {
            const headerRow = `<tr>${tableHeaders.map(h => `<th>${h}</th>`).join('')}</tr>`;
            return `
                <div class="report-header">
                    <h4>${title}</h4>
                    <div class="report-actions">
                        <button class="btn-secondary report-print-btn">Print</button>
                        <button class="btn-secondary report-export-btn" data-report-title="${title.replace(/ /g, '_')}">Export to CSV</button>
                    </div>
                </div>
                <table class="report-table" id="currentReportTable">
                    <thead>${headerRow}</thead>
                    <tbody>${tableBodyRows.join('')}</tbody>
                </table>
                ${summary ? `<div class="report-summary">${summary}</div>` : ''}
            `;
        }

        async function generateOccupancySummary() {
            const [properties, units] = await Promise.all([
                fetchAllData('properties'),
                fetchAllData('units')
            ]);
            
            if (units.length === 0) return `<div class="empty-report-state"><div class="icon">üè†</div><p>No units found to generate an occupancy summary.</p></div>`;

            const propertyMap = properties.reduce((map, p) => (map[p.id] = p.name, map), {});
            const occupiedUnits = units.filter(u => u.status === 'Occupied').length;
            const occupancyRate = (occupiedUnits / units.length) * 100;
            
            const headers = ['Unit', 'Property', 'Status'];
            const rows = units.map(u => `
                <tr>
                    <td>${u.name || 'N/A'}</td>
                    <td>${propertyMap[u.propertyId] || 'Unassigned'}</td>
                    <td><span class="status-badge status-${(u.status || 'Unknown').toLowerCase()}">${u.status || 'Unknown'}</span></td>
                </tr>
            `);

            const summary = `<p>Total Units: ${units.length}</p><p>Occupied Units: ${occupiedUnits}</p><p>Occupancy Rate: ${occupancyRate.toFixed(2)}%</p>`;
            return getReportHTML('Occupancy Summary', headers, rows, summary);
        }

        async function generateRentRollReport() {
            const [properties, units, leases, tenants] = await Promise.all([
                fetchAllData('properties'), fetchAllData('units'),
                fetchAllData('leases'), fetchAllData('tenants')
            ]);

            if (leases.length === 0) return `<div class="empty-report-state"><div class="icon">üìú</div><p>No active leases found for the Rent Roll report.</p></div>`;
            
            const propertyMap = properties.reduce((map, p) => (map[p.id] = p.name, map), {});
            const unitMap = units.reduce((map, u) => (map[u.id] = u, map), {});
            const tenantMap = tenants.reduce((map, t) => (map[t.id] = t.name, map), {});

            const headers = ['Property', 'Unit', 'Tenant', 'Rent', 'Lease Start', 'Lease End', 'Status'];
            let totalRent = 0;
            const rows = leases.map(l => {
                const unit = unitMap[l.unitId] || {};
                const rent = parseFloat(l.rentAmount || 0);
                totalRent += rent;
                return `
                    <tr>
                        <td>${propertyMap[unit.propertyId] || 'N/A'}</td>
                        <td>${unit.name || 'N/A'}</td>
                        <td>${tenantMap[l.tenantId] || 'N/A'}</td>
                        <td>$${rent.toFixed(2)}</td>
                        <td>${l.startDate ? new Date(l.startDate).toLocaleDateString() : 'N/A'}</td>
                        <td>${l.endDate ? new Date(l.endDate).toLocaleDateString() : 'N/A'}</td>
                        <td><span class="status-badge status-${(l.status || 'Unknown').toLowerCase()}">${l.status || 'Unknown'}</span></td>
                    </tr>
                `;
            });
            const summary = `<p>Total Leases: ${leases.length}</p><p>Total Monthly Rent: $${totalRent.toFixed(2)}</p>`;
            return getReportHTML('Rent Roll', headers, rows, summary);
        }

        async function generateDelinquencyReport() {
            const [leases, tenants, units, properties] = await Promise.all([
                 fetchAllData('leases'), fetchAllData('tenants'), fetchAllData('units'), fetchAllData('properties')
            ]);
            
            const delinquentLeases = leases.filter(l => l.isDelinquent && parseFloat(l.delinquentAmount) > 0);
            if (delinquentLeases.length === 0) return `<div class="empty-report-state"><div class="icon">üëç</div><p>No delinquent accounts found.</p></div>`;

            const tenantMap = tenants.reduce((map, t) => (map[t.id] = t, map), {});
            const unitMap = units.reduce((map, u) => (map[u.id] = u, map), {});
            const propertyMap = properties.reduce((map, p) => (map[p.id] = p.name, map), {});

            const headers = ['Tenant', 'Phone', 'Property', 'Unit', 'Delinquent Amount'];
            let totalDelinquentAmount = 0;
            const rows = delinquentLeases.map(l => {
                const tenant = tenantMap[l.tenantId] || {};
                const unit = unitMap[l.unitId] || {};
                const amount = parseFloat(l.delinquentAmount);
                totalDelinquentAmount += amount;
                return `
                    <tr>
                        <td>${tenant.name || 'N/A'}</td>
                        <td>${tenant.phone || 'N/A'}</td>
                        <td>${propertyMap[unit.propertyId] || 'N/A'}</td>
                        <td>${unit.name || 'N/A'}</td>
                        <td>$${amount.toFixed(2)}</td>
                    </tr>
                `;
            });
            const summary = `<p>Total Delinquent Accounts: ${delinquentLeases.length}</p><p>Total Amount Overdue: $${totalDelinquentAmount.toFixed(2)}</p>`;
            return getReportHTML('Delinquency Report', headers, rows, summary);
        }
        
        async function generateMaintenanceActivityReport() {
             const [workOrders, properties] = await Promise.all([
                fetchAllData('workOrders'), fetchAllData('properties')
            ]);
            if (workOrders.length === 0) return `<div class="empty-report-state"><div class="icon">üõ†Ô∏è</div><p>No maintenance activity recorded.</p></div>`;
            
            const propertyMap = properties.reduce((map, p) => (map[p.id] = p.name, map), {});

            const headers = ['Date', 'Property', 'Issue', 'Priority', 'Cost', 'Status'];
            let totalCost = 0;
            const rows = workOrders.map(wo => {
                const cost = parseFloat(wo.cost || 0);
                totalCost += cost;
                return `
                    <tr>
                        <td>${wo.date ? new Date(wo.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${propertyMap[wo.propertyId] || 'N/A'}</td>
                        <td>${wo.issue || 'N/A'}</td>
                        <td>${wo.priority || 'N/A'}</td>
                        <td>$${cost.toFixed(2)}</td>
                        <td><span class="status-badge status-${(wo.status || 'Unknown').toLowerCase()}">${wo.status || 'Unknown'}</span></td>
                    </tr>
                `;
            });
            const summary = `<p>Total Work Orders: ${workOrders.length}</p><p>Total Cost: $${totalCost.toFixed(2)}</p>`;
            return getReportHTML('Maintenance Activity', headers, rows, summary);
        }

        async function generateFinancialStatementReport() {
            const transactions = await fetchAllData('transactions');
            if (transactions.length === 0) return `<div class="empty-report-state"><div class="icon">üí∞</div><p>No financial transactions recorded.</p></div>`;
            
            const headers = ['Date', 'Type', 'Category', 'Description', 'Amount'];
            let totalIncome = 0;
            let totalExpenses = 0;
            const rows = transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(t => {
                const amount = parseFloat(t.amount || 0);
                if (t.type === 'Income') totalIncome += amount;
                if (t.type === 'Expense') totalExpenses += amount;
                 return `
                    <tr>
                        <td>${t.date ? new Date(t.date).toLocaleDateString() : 'N/A'}</td>
                        <td>${t.type || 'N/A'}</td>
                        <td>${t.category || 'N/A'}</td>
                        <td>${t.description || ''}</td>
                        <td style="color: ${t.type === 'Income' ? 'green' : 'red'}">$${amount.toFixed(2)}</td>
                    </tr>
                `;
            });
            const netIncome = totalIncome - totalExpenses;
            const summary = `
                <p>Total Income: $${totalIncome.toFixed(2)}</p>
                <p>Total Expenses: $${totalExpenses.toFixed(2)}</p>
                <p>Net Income: <strong style="color: ${netIncome >= 0 ? 'green' : 'red'}">$${netIncome.toFixed(2)}</strong></p>
            `;
            return getReportHTML('Financial Statement', headers, rows, summary);
        }
        
        async function generateLeaseExpirationReport() {
            const [leases, tenants, units, properties] = await Promise.all([
                 fetchAllData('leases'), fetchAllData('tenants'), fetchAllData('units'), fetchAllData('properties')
            ]);

            const upcomingExpirations = leases.filter(l => {
                const endDate = new Date(l.endDate);
                const today = new Date();
                const ninetyDaysFromNow = new Date();
                ninetyDaysFromNow.setDate(today.getDate() + 90);
                return endDate >= today && endDate <= ninetyDaysFromNow;
            }).sort((a,b) => new Date(a.endDate) - new Date(b.endDate));
            
            if (upcomingExpirations.length === 0) return `<div class="empty-report-state"><div class="icon">üóìÔ∏è</div><p>No leases expiring in the next 90 days.</p></div>`;

            const tenantMap = tenants.reduce((map, t) => (map[t.id] = t.name, map), {});
            const unitMap = units.reduce((map, u) => (map[u.id] = u, map), {});
            const propertyMap = properties.reduce((map, p) => (map[p.id] = p.name, map), {});

            const headers = ['Expiration Date', 'Tenant', 'Property', 'Unit', 'Days Remaining'];
            const rows = upcomingExpirations.map(l => {
                const unit = unitMap[l.unitId] || {};
                const endDate = new Date(l.endDate);
                const daysRemaining = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                 return `
                    <tr>
                        <td>${endDate.toLocaleDateString()}</td>
                        <td>${tenantMap[l.tenantId] || 'N/A'}</td>
                        <td>${propertyMap[unit.propertyId] || 'N/A'}</td>
                        <td>${unit.name || 'N/A'}</td>
                        <td>${daysRemaining}</td>
                    </tr>
                `;
            });
            const summary = `<p>Total Leases Expiring Soon: ${upcomingExpirations.length}</p>`;
            return getReportHTML('Lease Expiration (Next 90 Days)', headers, rows, summary);
        }

        // --- Report Actions ---
        function handlePrintReport() {
            const reportContent = DOMElements.reportViewArea.innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Print Report</title>');
            // Link to the common stylesheet to maintain some styling
            printWindow.document.write('<link rel="stylesheet" href="/css/platform_common.css" type="text/css" />');
            printWindow.document.write('<style> body { padding: 20px; } .report-actions { display: none; } </style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(reportContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => { printWindow.print(); }, 500);
        }

        function handleExportReport(event) {
            const table = document.getElementById('currentReportTable');
            if(!table) { commonDependencies.commonShowAlert("No report table found to export.", "Error"); return; }
            const reportTitle = event.currentTarget.dataset.reportTitle || 'report';
            
            let csvContent = "data:text/csv;charset=utf-8,";
            const rows = table.querySelectorAll("tr");
            
            rows.forEach(row => {
                let rowData = [];
                row.querySelectorAll("th, td").forEach(cell => {
                    // Escape commas and quotes
                    let cellText = cell.textContent.replace(/"/g, '""');
                    if (cellText.includes(',')) cellText = `"${cellText}"`;
                    rowData.push(cellText);
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${reportTitle}_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function loadMetricsData() {
            // This function will now orchestrate the fetching and calculation for all KPIs and Charts.
            // It will replace the old mock data logic entirely.
            
            // For now, we'll keep the function structure and call helpers
            calculateAndDisplayKPIs();
            generateCharts();
        }

        async function calculateAndDisplayKPIs() {
            // Reset KPIs to loading state
            DOMElements.kpiOccupancyRateValue.textContent = '...';
            DOMElements.kpiOccupancyRateTrend.textContent = 'Calculating...';
            DOMElements.kpiAvgDelinquencyValue.textContent = '...';
            DOMElements.kpiAvgDelinquencyTrend.textContent = 'Calculating...';
            DOMElements.kpiMaintenanceCostsValue.textContent = '...';
            DOMElements.kpiMaintenanceCostsTrend.textContent = 'Calculating...';
            DOMElements.kpiLeaseRenewalsValue.textContent = '...';
            DOMElements.kpiLeaseRenewalsTrend.textContent = 'Calculating...';

            try {
                // Fetch all necessary data in parallel
                const [units, leases, workOrders] = await Promise.all([
                    fetchAllData('units'),
                    fetchAllData('leases'),
                    fetchAllData('workOrders')
                ]);

                // --- 1. Occupancy Rate ---
                if (units.length > 0) {
                    const occupiedUnits = units.filter(u => u.status === 'Occupied').length;
                    const occupancyRate = (occupiedUnits / units.length) * 100;
                    DOMElements.kpiOccupancyRateValue.textContent = `${occupancyRate.toFixed(1)}%`;
                    DOMElements.kpiOccupancyRateTrend.textContent = `${occupiedUnits} / ${units.length} units`;
                } else {
                    DOMElements.kpiOccupancyRateValue.textContent = 'N/A';
                    DOMElements.kpiOccupancyRateTrend.textContent = 'No units found';
                }

                // --- 2. Average Delinquency ---
                // This is a simplified model. A real system would have more complex transaction tracking.
                const delinquentLeases = leases.filter(l => l.isDelinquent && parseFloat(l.delinquentAmount) > 0);
                if (delinquentLeases.length > 0) {
                    const totalDelinquency = delinquentLeases.reduce((sum, l) => sum + parseFloat(l.delinquentAmount), 0);
                    const avgDelinquency = totalDelinquency / delinquentLeases.length;
                    DOMElements.kpiAvgDelinquencyValue.textContent = `$${avgDelinquency.toFixed(2)}`;
                    DOMElements.kpiAvgDelinquencyTrend.textContent = `${delinquentLeases.length} delinquent accounts`;
                } else {
                    DOMElements.kpiAvgDelinquencyValue.textContent = '$0.00';
                    DOMElements.kpiAvgDelinquencyTrend.textContent = 'No delinquent accounts';
                }

                // --- 3. Maintenance Costs (This Month) ---
                const today = new Date();
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                const relevantWorkOrders = workOrders.filter(wo => {
                    const completedDate = new Date(wo.completedDate);
                    return wo.status === 'Completed' && wo.cost && completedDate >= startOfMonth;
                });
                const totalCost = relevantWorkOrders.reduce((sum, wo) => sum + parseFloat(wo.cost), 0);
                DOMElements.kpiMaintenanceCostsValue.textContent = `$${totalCost.toFixed(2)}`;
                DOMElements.kpiMaintenanceCostsTrend.textContent = `${relevantWorkOrders.length} work orders this month`;
                

                // --- 4. Lease Renewals (Last 90d) ---
                const ninetyDaysAgo = new Date();
                ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
                const expiringLeases = leases.filter(l => {
                    const endDate = new Date(l.endDate);
                    return endDate >= ninetyDaysAgo && endDate <= today;
                });
                const renewedLeases = expiringLeases.filter(l => l.status === 'Renewed').length;
                if (expiringLeases.length > 0) {
                    const renewalRate = (renewedLeases / expiringLeases.length) * 100;
                    DOMElements.kpiLeaseRenewalsValue.textContent = `${renewalRate.toFixed(1)}%`;
                    DOMElements.kpiLeaseRenewalsTrend.textContent = `${renewedLeases} of ${expiringLeases.length} renewed`;
                } else {
                    DOMElements.kpiLeaseRenewalsValue.textContent = 'N/A';
                     DOMElements.kpiLeaseRenewalsTrend.textContent = 'No leases expired recently';
                }

            } catch (error) {
                console.error("Error calculating KPIs:", error);
                commonDependencies.commonShowAlert("Could not load key metrics. " + error.message, "Error");
                 DOMElements.kpiOccupancyRateValue.textContent = 'Error';
                 DOMElements.kpiAvgDelinquencyValue.textContent = 'Error';
                 DOMElements.kpiMaintenanceCostsValue.textContent = 'Error';
                 DOMElements.kpiLeaseRenewalsValue.textContent = 'Error';
            }
        }

        async function generateCharts() {
            try {
                const [transactions, workOrders, units] = await Promise.all([
                    fetchAllData('transactions'),
                    fetchAllData('workOrders'),
                    fetchAllData('units')
                ]);

                generateRevenueExpensesChart(transactions);
                generateWorkOrderCompletionChart(workOrders);
                generateVacancyDurationChart(units);

            } catch (error) {
                console.error("Error generating charts:", error);
                commonDependencies.commonShowAlert("Could not load chart data. " + error.message, "Error");
            }
        }
        
        function generateRevenueExpensesChart(transactions) {
            const ctx = DOMElements.revenueExpensesChart?.getContext('2d');
            if (!ctx) return;

            const twelveMonthsAgo = new Date();
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);

            const monthlyData = {};
            for (let i = 0; i < 12; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[monthKey] = { revenue: 0, expenses: 0 };
            }

            transactions.forEach(t => {
                const transDate = new Date(t.date);
                if (transDate >= twelveMonthsAgo) {
                    const monthKey = `${transDate.getFullYear()}-${String(transDate.getMonth() + 1).padStart(2, '0')}`;
                    if (monthlyData[monthKey]) {
                        if (t.type === 'Income') {
                            monthlyData[monthKey].revenue += parseFloat(t.amount);
                        } else if (t.type === 'Expense') {
                            monthlyData[monthKey].expenses += parseFloat(t.amount);
                        }
                    }
                }
            });

            const labels = Object.keys(monthlyData).sort();
            const revenueData = labels.map(label => monthlyData[label].revenue);
            const expensesData = labels.map(label => monthlyData[label].expenses);

            if(activeCharts.revenueExpenses) activeCharts.revenueExpenses.destroy();
            activeCharts.revenueExpenses = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => new Date(l + '-02').toLocaleString('default', { month: 'short', year: '2-digit' })),
                    datasets: [
                        { label: 'Revenue', data: revenueData, backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                        { label: 'Expenses', data: expensesData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        function generateWorkOrderCompletionChart(workOrders) {
            const ctx = DOMElements.workOrderCompletionChart?.getContext('2d');
            if (!ctx) return;

            const priorityCounts = { 'High': 0, 'Medium': 0, 'Low': 0, 'Unknown': 0 };
            workOrders.forEach(wo => {
                const priority = wo.priority || 'Unknown';
                if(priorityCounts.hasOwnProperty(priority)) {
                    priorityCounts[priority]++;
                } else {
                    priorityCounts['Unknown']++;
                }
            });

            if(activeCharts.woCompletion) activeCharts.woCompletion.destroy();
            activeCharts.woCompletion = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(priorityCounts),
                    datasets: [{
                        data: Object.values(priorityCounts),
                        backgroundColor: ['#dc3545', '#fd7e14', '#28a745', '#6c757d']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function generateVacancyDurationChart(units) {
             const ctx = DOMElements.vacancyDurationChart?.getContext('2d');
            if (!ctx) return;

            const vacantUnits = units.filter(u => u.status === 'Vacant' && u.becameVacantOn);
            const vacancyDurations = vacantUnits.map(u => {
                const vacantDate = new Date(u.becameVacantOn);
                const today = new Date();
                const diffTime = Math.abs(today - vacantDate);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // in days
            });
            
            // Simple average for now. A histogram would be better for distribution.
            const avgDuration = vacancyDurations.length > 0 
                ? vacancyDurations.reduce((a, b) => a + b, 0) / vacancyDurations.length
                : 0;
            
            const labels = vacantUnits.map(u => u.name || `Unit ${u.id.substring(0,5)}`);

            if(activeCharts.vacancyDuration) activeCharts.vacancyDuration.destroy();
            activeCharts.vacancyDuration = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Days Vacant',
                        data: vacancyDurations,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        title: { display: true, text: `Average Vacancy: ${avgDuration.toFixed(1)} days` }
                    }
                }
            });
        }

        function populateKPIs(data) {
            if (DOMElements.kpiOccupancyRateValue) DOMElements.kpiOccupancyRateValue.textContent = data.occupancy.value;
            if (DOMElements.kpiOccupancyRateTrend) DOMElements.kpiOccupancyRateTrend.textContent = data.occupancy.trend;

            if (DOMElements.kpiAvgDelinquencyValue) DOMElements.kpiAvgDelinquencyValue.textContent = data.delinquency.value;
            if (DOMElements.kpiAvgDelinquencyTrend) DOMElements.kpiAvgDelinquencyTrend.textContent = data.delinquency.trend;

            if (DOMElements.kpiMaintenanceCostsValue) DOMElements.kpiMaintenanceCostsValue.textContent = data.maintenance.value;
            if (DOMElements.kpiMaintenanceCostsTrend) DOMElements.kpiMaintenanceCostsTrend.textContent = data.maintenance.trend;

            if (DOMElements.kpiLeaseRenewalsValue) DOMElements.kpiLeaseRenewalsValue.textContent = data.renewals.value;
            if (DOMElements.kpiLeaseRenewalsTrend) DOMElements.kpiLeaseRenewalsTrend.textContent = data.renewals.trend;
        }

        initializeAuth((...args) => pageInit(...args, hasAccess));
    </script>
</body>
</html> 