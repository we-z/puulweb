<!DOCTYPE html>
<html lang="en" class="js-loading">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="/js/fouc-prevention.js"></script>
    <style>
        .sub-nav { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 20px; }
        .sub-nav-item { padding: 10px 15px; /* Adjusted padding */ cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -1px; font-weight: 500; color: #555; transition: color 0.2s ease, border-bottom-color 0.2s ease; font-size: 0.9rem; /* Slightly smaller font for more tabs */}
        .sub-nav-item:hover { color: #000; }
        .sub-nav-item.active { color: #000; border-bottom-color: #000; }
        .subsection-content { display: none; }
        .subsection-content.active { display: block; }
        .form-group-row { display: flex; gap: 15px; }

        /* Journal Entry Modal Styles */
        .je-table {
            display: grid;
            grid-template-columns: minmax(150px, 2fr) minmax(150px, 3fr) minmax(90px, 1fr) minmax(120px, 1.5fr) auto;
            gap: 10px;
            align-items: center;
            padding: 0 5px; /* Reduced padding */
        }
        .je-header {
            font-weight: bold;
            font-size: 0.8rem;
            color: #555;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 5px;
        }
        .je-line-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .je-line-item:last-child {
            border-bottom: none;
        }
        .je-line-item select, .je-line-item input {
            width: 100%;
            font-size: 0.9rem;
        }
        .delete-je-line-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .delete-je-line-btn svg {
            width: 16px;
            height: 16px;
            fill: #888;
            transition: fill 0.2s ease;
        }
        .delete-je-line-btn:hover svg {
            fill: #dc3545;
        }
        .je-totals {
            grid-column: 1 / -1;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 15px 5px;
            margin-top: 10px;
            background-color: #f9f9f9;
            border-top: 2px solid #e0e0e0;
        }
        .je-totals-summary {
            display: grid;
            grid-template-columns: auto auto;
            gap: 5px 20px;
            align-items: center;
            font-size: 0.95rem;
        }
        .je-totals-summary label {
            text-align: right;
            color: #333;
            font-weight: 500;
        }
        .je-totals-summary span {
            text-align: right;
            min-width: 100px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1rem;
            font-weight: bold;
        }
        #jeBalanceStatus {
            font-weight: bold;
            margin-left: 25px;
            padding: 6px 12px;
            border-radius: 20px; /* pill shape */
            font-size: 0.8rem;
            text-transform: uppercase;
        }
        #jeBalanceStatus.balanced {
            color: #155724;
            background-color: #d4edda;
        }
        #jeBalanceStatus.unbalanced {
            color: #721c24;
            background-color: #f8d7da;
        }
        #addJeLineBtn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            background-color: #6c757d; /* Monotone color */
            color: white;
            padding: 9px 18px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
            margin-top: 15px; /* give some space */
            border: none;
            cursor: pointer;
        }
        #addJeLineBtn:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="accountingView">
            <div class="content-header"><h2>Accounting</h2></div>
            <div class="page-container">
                <div class="sub-nav" id="accountingSubNav">
                    <div class="sub-nav-item active" data-subsection="receivables">Receivables</div>
                    <div class="sub-nav-item" data-subsection="payables">Payables</div>
                    <div class="sub-nav-item" data-subsection="bankAccounts">Bank Accounts</div>
                    <div class="sub-nav-item" data-subsection="journalEntries">Journal Entries</div>
                    <div class="sub-nav-item" data-subsection="bankTransfers">Bank Transfers</div>
                    <div class="sub-nav-item" data-subsection="glAccounts">GL Accounts</div>
                    <div class="sub-nav-item" data-subsection="diagnostics">Diagnostics</div>
                </div>

                <div class="subsection-content active" id="receivablesContent"><h4>Receivables</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Property:</label><div class="custom-dropdown" id="receivablesFilterProperty"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Properties</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Properties</div></div></div></div><div class="filter-group"><label>Status:</label><div class="custom-dropdown" id="receivablesFilterStatus"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Statuses</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Statuses</div><div class="dropdown-option" data-value="Due">Due</div><div class="dropdown-option" data-value="Paid">Paid</div><div class="dropdown-option" data-value="Overdue">Overdue</div><div class="dropdown-option" data-value="Partial">Partial</div></div></div></div></div><div class="data-table-container"><table class="data-table" id="receivablesTable"><thead><tr><th>Date</th><th>Tenant/Payer</th><th>Property</th><th>Description</th><th>Amount Due</th><th>Amount Paid</th><th>Status</th><th>Actions</th></tr></thead><tbody id="receivablesTableBody"></tbody></table><div id="noReceivablesMessage" class="no-data-message"><div class="icon">💸</div><p>No receivables recorded.</p></div></div></div>
                <div class="subsection-content" id="payablesContent"><h4>Payables</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Property:</label><div class="custom-dropdown" id="payablesFilterProperty"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Properties</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Properties</div></div></div></div><div class="filter-group"><label>Status:</label><div class="custom-dropdown" id="payablesFilterStatus"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Statuses</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Statuses</div><div class="dropdown-option" data-value="Unpaid">Unpaid</div><div class="dropdown-option" data-value="Paid">Paid</div><div class="dropdown-option" data-value="Pending">Pending</div></div></div></div></div><div class="data-table-container"><table class="data-table" id="payablesTable"><thead><tr><th>Due Date</th><th>Vendor/Payee</th><th>Property (Optional)</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody id="payablesTableBody"></tbody></table><div id="noPayablesMessage" class="no-data-message"><div class="icon">🧾</div><p>No payables recorded.</p></div></div></div>
                <div class="subsection-content" id="bankAccountsContent"><h4>Bank Accounts</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Type:</label><div class="custom-dropdown" id="bankAccountsFilterType"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Types</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Types</div><div class="dropdown-option" data-value="Checking">Checking</div><div class="dropdown-option" data-value="Savings">Savings</div><div class="dropdown-option" data-value="Credit Card">Credit Card</div><div class="dropdown-option" data-value="Loan">Loan</div><div class="dropdown-option" data-value="Other">Other</div></div></div></div></div><div class="data-table-container"><table class="data-table" id="bankAccountsTable"><thead><tr><th>Account Name</th><th>Bank Name</th><th>Account Number (Last 4)</th><th>Type</th><th>Current Balance</th><th>Actions</th></tr></thead><tbody id="bankAccountsTableBody"></tbody></table><div id="noBankAccountsMessage" class="no-data-message"><div class="icon">🏦</div><p>No bank accounts set up.</p></div></div></div>
                <div class="subsection-content" id="journalEntriesContent"><h4>Journal Entries</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Start Date:</label><input type="date" id="journalEntriesFilterStartDate" class="form-control"></div><div class="filter-group"><label>End Date:</label><input type="date" id="journalEntriesFilterEndDate" class="form-control"></div></div><div class="data-table-container"><table class="data-table" id="journalEntriesTable"><thead><tr><th>Date</th><th>Entry ID</th><th>Description</th><th>Total Debits</th><th>Total Credits</th><th>Actions</th></tr></thead><tbody id="journalEntriesTableBody"></tbody></table><div id="noJournalEntriesMessage" class="no-data-message"><div class="icon">📓</div><p>No journal entries found.</p></div></div></div>
                <div class="subsection-content" id="bankTransfersContent"><h4>Bank Transfers</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Status:</label><div class="custom-dropdown" id="bankTransfersFilterStatus"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Statuses</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Statuses</div><div class="dropdown-option" data-value="Pending">Pending</div><div class="dropdown-option" data-value="Completed">Completed</div><div class="dropdown-option" data-value="Failed">Failed</div></div></div></div></div><div class="data-table-container"><table class="data-table" id="bankTransfersTable"><thead><tr><th>Date</th><th>From Account</th><th>To Account</th><th>Amount</th><th>Memo</th><th>Status</th><th>Actions</th></tr></thead><tbody id="bankTransfersTableBody"></tbody></table><div id="noBankTransfersMessage" class="no-data-message"><div class="icon">↔️</div><p>No bank transfers recorded.</p></div></div></div>
                <div class="subsection-content" id="glAccountsContent"><h4>GL Accounts (Chart of Accounts)</h4><div class="controls-container visible-by-default"><div class="filter-group"><label>Type:</label><div class="custom-dropdown" id="glAccountsFilterType"><div class="dropdown-selected" tabindex="0"><span class="selected-value">All Types</span><svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></div><div class="dropdown-options"><div class="dropdown-option" data-value="">All Types</div><div class="dropdown-option" data-value="Asset">Asset</div><div class="dropdown-option" data-value="Liability">Liability</div><div class="dropdown-option" data-value="Equity">Equity</div><div class="dropdown-option" data-value="Income">Income</div><div class="dropdown-option" data-value="Expense">Expense</div></div></div></div></div><div class="data-table-container"><table class="data-table" id="glAccountsTable"><thead><tr><th>Account Number</th><th>Account Name</th><th>Type</th><th>Sub-Type</th><th>Balance (Calculated)</th><th>Actions</th></tr></thead><tbody id="glAccountsTableBody"></tbody></table><div id="noGLAccountsMessage" class="no-data-message"><div class="icon">📊</div><p>Chart of Accounts is empty.</p></div></div></div>
                <div class="subsection-content" id="diagnosticsContent">
                    <h4>Accounting Diagnostics</h4>
                    <div class="diagnostics-overview">
                        <p>This section provides tools to help identify and resolve potential discrepancies or issues in your accounting data. Select a diagnostic report to run:</p>
                    </div>
                    <div class="diagnostic-item-list">
                        <div class="diagnostic-item">
                            <h5>Unreconciled Transactions Report</h5>
                            <p>Identifies bank transactions that have not been matched or reconciled with your accounting records.</p>
                            <button class="btn-secondary run-diagnostic-btn" data-diagnostic="unreconciled">Run Report</button>
                            <div class="diagnostic-results" id="results-unreconciled"></div>
                        </div>
                        <div class="diagnostic-item">
                            <h5>Aged Payables/Receivables Discrepancy Check</h5>
                            <p>Compares summary aging reports with outstanding balances to find inconsistencies.</p>
                            <button class="btn-secondary run-diagnostic-btn" data-diagnostic="aging-discrepancy">Run Check</button>
                            <div class="diagnostic-results" id="results-aging-discrepancy"></div>
                        </div>
                        <div class="diagnostic-item">
                            <h5>GL Balance Anomaly Detection</h5>
                            <p>Scans General Ledger accounts for unusual balances or unexpected activity (e.g., asset with credit balance).</p>
                            <button class="btn-secondary run-diagnostic-btn" data-diagnostic="gl-anomaly">Run Scan</button>
                            <div class="diagnostic-results" id="results-gl-anomaly"></div>
                        </div>
                        <div class="diagnostic-item">
                            <h5>Data Integrity Check</h5>
                            <p>Performs a series of checks for common data entry errors or orphaned records.</p>
                            <button class="btn-secondary run-diagnostic-btn" data-diagnostic="data-integrity">Run Check</button>
                            <div class="diagnostic-results" id="results-data-integrity"></div>
                        </div>
                        <!-- More diagnostic tools can be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="ai-agent-container"></div>

    <button class="fab" id="addItemBtn" aria-label="Add new accounting item">+</button>

    <!-- Modals -->
    <div id="receivableModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Add/Edit Receivable</h3><button class="close-btn" data-modal-id="receivableModal">&times;</button></div><form id="receivableForm"><input type="hidden" name="receivableId"><div class="form-group"><label>Date</label><input type="date" name="date" required></div><div class="form-group"><label>Tenant/Payer</label><input type="text" name="payerName" required></div><div class="form-group"><label>Property</label><select name="propertyId" required></select></div><div class="form-group"><label>Description</label><input type="text" name="description" required></div><div class="form-group"><label>Amount Due ($)</label><input type="number" name="amountDue" step="0.01" required></div><div class="form-group"><label>Status</label><select name="status"><option>Due</option><option>Paid</option><option>Overdue</option><option>Partial</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="receivableModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div></form></div></div>
    <div id="payableModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Add/Edit Payable</h3><button class="close-btn" data-modal-id="payableModal">&times;</button></div><form id="payableForm"><input type="hidden" name="payableId"><div class="form-group"><label>Due Date</label><input type="date" name="dueDate" required></div><div class="form-group"><label>Vendor/Payee</label><input type="text" name="payeeName" required></div><div class="form-group"><label>Property (Optional)</label><select name="propertyId"><option value="">N/A</option></select></div><div class="form-group"><label>Description</label><input type="text" name="description" required></div><div class="form-group"><label>Amount ($)</label><input type="number" name="amount" step="0.01" required></div><div class="form-group"><label>Status</label><select name="status"><option>Unpaid</option><option>Paid</option><option>Pending</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="payableModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div></form></div></div>
    <div id="bankAccountModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Add/Edit Bank Account</h3><button class="close-btn" data-modal-id="bankAccountModal">&times;</button></div><form id="bankAccountForm"><input type="hidden" name="bankAccountId"><div class="form-group"><label>Account Name</label><input type="text" name="accountName" required></div><div class="form-group"><label>Bank Name</label><input type="text" name="bankName"></div><div class="form-group"><label>Account Number</label><input type="text" name="accountNumber" placeholder="Full number (stored securely)"></div><div class="form-group"><label>Account Type</label><select name="accountType"><option>Checking</option><option>Savings</option><option>Credit Card</option><option>Loan</option><option>Other</option></select></div><div class="form-group"><label>Opening Balance ($)</label><input type="number" name="openingBalance" step="0.01"></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="bankAccountModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div></form></div></div>
    <div id="journalEntryModal" class="modal">
        <div class="modal-content" style="max-width: 850px;">
            <div class="modal-header">
                <h3>Add/Edit Journal Entry</h3>
                <button class="close-btn" data-modal-id="journalEntryModal">&times;</button>
            </div>
            <form id="journalEntryForm">
                <input type="hidden" name="journalEntryId">
                <div class="form-group-row">
                    <div class="form-group" style="flex: 1;">
                        <label>Date</label>
                        <input type="date" name="date" required>
                    </div>
                    <div class="form-group" style="flex: 2;">
                        <label>Description</label>
                        <input type="text" name="description" required placeholder="Overall description for the entry">
                    </div>
                </div>
                <div class="form-group">
                    <div id="jeLinesHeader" class="je-table je-header">
                        <div style="grid-column: 1;">GL Account</div>
                        <div style="grid-column: 2;">Description</div>
                        <div style="grid-column: 3;">Type</div>
                        <div style="grid-column: 4; text-align: right;">Amount</div>
                        <div style="grid-column: 5;"></div>
                    </div>
                    <div id="jeLinesContainer">
                        <!-- Journal entry lines will be dynamically inserted here -->
                    </div>
                    <div id="jeLinesFooter" class="je-totals">
                        <div class="je-totals-summary">
                            <label>Totals:</label>
                            <span id="totalDebits">$0.00</span>
                            <div></div>
                            <span id="totalCredits">$0.00</span>
                        </div>
                        <div id="jeBalanceStatus"></div>
                    </div>
                </div>
                <button type="button" id="addJeLineBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    <span>Add Line</span>
                </button>
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="cancel-btn" data-modal-id="journalEntryModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save</button>
                </div>
            </form>
        </div>
    </div>
    <div id="bankTransferModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Add/Edit Bank Transfer</h3><button class="close-btn" data-modal-id="bankTransferModal">&times;</button></div><form id="bankTransferForm"><input type="hidden" name="bankTransferId"><div class="form-group"><label>Date</label><input type="date" name="date" required></div><div class="form-group"><label>From Account</label><select name="fromAccountId" required></select></div><div class="form-group"><label>To Account</label><select name="toAccountId" required></select></div><div class="form-group"><label>Amount ($)</label><input type="number" name="amount" step="0.01" required></div><div class="form-group"><label>Memo</label><input type="text" name="memo"></div><div class="form-group"><label>Status</label><select name="status"><option value="Pending">Pending</option><option value="Completed">Completed</option><option value="Failed">Failed</option></select></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="bankTransferModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div></form></div></div>
    <div id="glAccountModal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Add/Edit GL Account</h3><button class="close-btn" data-modal-id="glAccountModal">&times;</button></div><form id="glAccountForm"><input type="hidden" name="glAccountId"><div class="form-group"><label>Account Number</label><input type="text" name="accountNumber" required></div><div class="form-group"><label>Account Name</label><input type="text" name="accountName" required></div><div class="form-group"><label>Type</label><select name="type"><option>Asset</option><option>Liability</option><option>Equity</option><option>Income</option><option>Expense</option></select></div><div class="form-group"><label>Sub-Type (Optional)</label><input type="text" name="subType"></div><div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="glAccountModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div></form></div></div>

    <div id="customAlertModal"><div class="custom-alert"><p></p></div></div>
    <div id="customConfirmModal" class="modal"><div class="modal-content confirm-modal-content"><div class="modal-header"><h3 id="customConfirmTitle"></h3><button class="close-btn" data-modal-id="customConfirmModal">&times;</button></div><div class="modal-body"><p id="customConfirmMessage"></p></div><div class="modal-footer"><button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button><button class="confirm-btn" id="customConfirmOk">OK</button></div></div></div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData, initializeCustomDropdown } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Module-scoped variables initialized first
        let commonDependencies = {};
        let pageCurrentUserId;
        let pageDatabase;
        let localPropertiesMap = {};
        let localBankAccountsMap = {};
        let localGLAccountsMap = {};

        // Data Caches
        let receivablesData = [], payablesData = [], bankAccountsData = [], 
            journalEntriesData = [], bankTransfersData = [], glAccountsData = [];

        const DOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            receivableModal: document.getElementById('receivableModal'), receivableForm: document.getElementById('receivableForm'),
            payableModal: document.getElementById('payableModal'), payableForm: document.getElementById('payableForm'),
            bankAccountModal: document.getElementById('bankAccountModal'), bankAccountForm: document.getElementById('bankAccountForm'),
            journalEntryModal: document.getElementById('journalEntryModal'), journalEntryForm: document.getElementById('journalEntryForm'), addJeLineBtn: document.getElementById('addJeLineBtn'),
            bankTransferModal: document.getElementById('bankTransferModal'), bankTransferForm: document.getElementById('bankTransferForm'),
            glAccountModal: document.getElementById('glAccountModal'), glAccountForm: document.getElementById('glAccountForm'),
            receivablesTableBody: document.getElementById('receivablesTableBody'), noReceivablesMessage: document.getElementById('noReceivablesMessage'),
            payablesTableBody: document.getElementById('payablesTableBody'), noPayablesMessage: document.getElementById('noPayablesMessage'),
            bankAccountsTableBody: document.getElementById('bankAccountsTableBody'), noBankAccountsMessage: document.getElementById('noBankAccountsMessage'),
            journalEntriesTableBody: document.getElementById('journalEntriesTableBody'), noJournalEntriesMessage: document.getElementById('noJournalEntriesMessage'),
            bankTransfersTableBody: document.getElementById('bankTransfersTableBody'), noBankTransfersMessage: document.getElementById('noBankTransfersMessage'),
            glAccountsTableBody: document.getElementById('glAccountsTableBody'), noGLAccountsMessage: document.getElementById('noGLAccountsMessage'),
        };

        function pageInit(userId, db, fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbDataExt, fbUpdateDbDataExt, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeCustomDropdown) {
            pageCurrentUserId = userId;
            pageDatabase = db;
            
            commonDependencies.fbRef = fbRef;
            commonDependencies.fbPush = fbPush;
            commonDependencies.fbSet = fbSet;
            commonDependencies.fbRemove = fbRemove;
            commonDependencies.fbServerTimestamp = fbServerTimestamp;
            commonDependencies.fbQuery = fbQuery;
            commonDependencies.fbOrderByChild = fbOrderByChild;
            commonDependencies.fbEqualTo = fbEqualTo;
            commonDependencies.fbGetDbData = fbGetDbDataExt;
            commonDependencies.fbUpdateDbData = fbUpdateDbDataExt;
            commonDependencies.commonShowAlert = commonShowAlert;
            commonDependencies.commonShowConfirm = commonShowConfirm;
            commonDependencies.commonEditIcon = commonEditIcon;
            commonDependencies.commonDeleteIcon = commonDeleteIcon;
            commonDependencies.initializeCustomDropdown = commonInitializeCustomDropdown;

            initializeSubNav();
            initializePropertiesListener();
            initializeBankAccountsListener();
            initializeGLAccountsListener();
            initializeFilterControls();
            loadDataForActiveSubsection();
            setupEventListeners();
            setupDiagnosticButtons();
            
            if (DOMElements.addItemBtn) {
                DOMElements.addItemBtn.addEventListener('click', () => {
                    const activeSubSection = document.querySelector('#accountingSubNav .sub-nav-item.active').dataset.subsection;
                    openModalForSubsection(activeSubSection);
                });
            }
        }

        function initializeSubNav() {
            const subNavContainer = document.getElementById('accountingSubNav');
            if (!subNavContainer) return;
            const subsections = document.querySelectorAll('#accountingView .subsection-content');
            const subNavItems = subNavContainer.querySelectorAll('.sub-nav-item');
            subNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    subNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const targetId = item.dataset.subsection + "Content";
                    subsections.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetId) content.classList.add('active');
                    });
                    loadDataForActiveSubsection();
                    if (DOMElements.addItemBtn) {
                        DOMElements.addItemBtn.style.display = item.dataset.subsection === 'diagnostics' ? 'none' : 'flex';
                    }
                });
            });
        }

        function initializePropertiesListener() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(propertiesRef, commonDependencies.fbOrderByChild('address')), (snapshot) => {
                localPropertiesMap = {};
                snapshot.forEach(propSnapshot => { localPropertiesMap[propSnapshot.key] = propSnapshot.val().address; });
                const selectsToPopulate = [DOMElements.receivableForm?.elements.propertyId, DOMElements.payableForm?.elements.propertyId];
                selectsToPopulate.forEach(select => {
                    if(select) {
                        const currentVal = select.value;
                        select.innerHTML = select.name === 'propertyId' && select.parentElement.textContent.includes('(Optional)') ? '<option value="">N/A</option>' : '<option value="">Select Property</option>';
                        snapshot.forEach(propSnapshot => {
                            const option = document.createElement('option');
                            option.value = propSnapshot.key; option.textContent = propSnapshot.val().address;
                            select.appendChild(option);
                        });
                        select.value = currentVal;
                    }
                });
                populateDynamicDropdown('receivablesFilterProperty', new Set(Object.values(localPropertiesMap)), 'All Properties', localPropertiesMap, true);
                populateDynamicDropdown('payablesFilterProperty', new Set(Object.values(localPropertiesMap)), 'All Properties', localPropertiesMap, true);
                renderActiveSubsectionData();
            });
        }
        function initializeBankAccountsListener() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const bankAccountsRef = commonDependencies.fbRef(pageDatabase, `bankAccounts/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(bankAccountsRef, commonDependencies.fbOrderByChild('accountName')), (snapshot) => {
                localBankAccountsMap = {};
                snapshot.forEach(accSnapshot => { localBankAccountsMap[accSnapshot.key] = accSnapshot.val().accountName; });
                const selectsToPopulate = [DOMElements.bankTransferForm?.elements.fromAccountId, DOMElements.bankTransferForm?.elements.toAccountId];
                selectsToPopulate.forEach(select => {
                    if(select) {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Select Account</option>';
                        snapshot.forEach(accSnapshot => {
                            const option = document.createElement('option');
                            option.value = accSnapshot.key; option.textContent = `${accSnapshot.val().accountName} (...${accSnapshot.val().accountNumber?.slice(-4) || 'XXXX'})`;
                            select.appendChild(option);
                        });
                        select.value = currentVal;
                    }
                });
                renderActiveSubsectionData();
            });
        }
        function initializeGLAccountsListener() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const glAccountsRef = commonDependencies.fbRef(pageDatabase, `glAccounts/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(glAccountsRef, commonDependencies.fbOrderByChild('accountNumber')), (snapshot) => {
                localGLAccountsMap = {};
                snapshot.forEach(glSnapshot => { localGLAccountsMap[glSnapshot.key] = { name: glSnapshot.val().accountName, number: glSnapshot.val().accountNumber }; });
                renderActiveSubsectionData();
            });
        }

        function initializeFilterControls() {
             document.querySelectorAll('.controls-container .custom-dropdown').forEach(dropdown => {
                initializeCustomDropdown(dropdown, () => renderActiveSubsectionData());
            });

             document.querySelectorAll('.controls-toggle-btn').forEach(btn => {
                const controlsContainer = btn.nextElementSibling;
                const arrowIcon = btn.querySelector('.arrow-icon');
                if (!controlsContainer || !controlsContainer.classList.contains('controls-container')) return;
                btn.addEventListener('click', () => {
                    const isExpanded = controlsContainer.style.display === 'flex';
                    controlsContainer.style.display = isExpanded ? 'none' : 'flex';
                    if(arrowIcon) arrowIcon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
                });
                const isVisibleByDefault = controlsContainer.classList.contains('visible-by-default');
                if (isVisibleByDefault && window.innerWidth > 768) {
                    controlsContainer.style.display = 'flex';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(0deg)';
                } else {
                    controlsContainer.style.display = 'none';
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(-90deg)';
                }
            });

            // Date range filters
            const startDateInput = document.getElementById('journalEntriesFilterStartDate');
            const endDateInput = document.getElementById('journalEntriesFilterEndDate');
            [startDateInput, endDateInput].forEach(input => {
                if (input) {
                    input.addEventListener('change', () => renderJournalEntries());
                }
            });
        }

        function populateDynamicDropdown(dropdownId, optionsSet, allText, valueMap = null, mapIsReversed = false) {
            const dropdown = document.getElementById(dropdownId);
            if (!dropdown) return;
            const optionsContainer = dropdown.querySelector('.dropdown-options');
            const selectedValueSpan = dropdown.querySelector('.selected-value');
            const currentValue = dropdown.dataset.value || '';
            optionsContainer.innerHTML = '';
            const allOption = document.createElement('div');
            allOption.className = 'dropdown-option';
            allOption.dataset.value = '';
            allOption.textContent = allText;
            optionsContainer.appendChild(allOption);
            Array.from(optionsSet).sort().forEach(optionText => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                if (valueMap) {
                    const key = mapIsReversed ? Object.keys(valueMap).find(k => valueMap[k] === optionText) : optionText;
                    option.dataset.value = key;
                } else {
                    option.dataset.value = optionText;
                }
                option.textContent = optionText;
                optionsContainer.appendChild(option);
            });
            const currentOption = optionsContainer.querySelector(`.dropdown-option[data-value="${currentValue}"]`);
            if (currentOption) {
                selectedValueSpan.textContent = currentOption.textContent;
                if(optionsContainer.querySelector('.selected')) optionsContainer.querySelector('.selected').classList.remove('selected');
                currentOption.classList.add('selected');
            } else {
                selectedValueSpan.textContent = allText;
                dropdown.dataset.value = '';
                if(optionsContainer.firstChild) optionsContainer.firstChild.classList.add('selected');
            }
        }

        function loadDataForActiveSubsection() {
            const activeNavItem = document.querySelector('#accountingSubNav .sub-nav-item.active');
            if (!activeNavItem) return;
            const activeSubSection = activeNavItem.dataset.subsection;
            switch (activeSubSection) {
                case 'receivables': loadReceivables(); break;
                case 'payables': loadPayables(); break;
                case 'bankAccounts': loadBankAccounts(); break;
                case 'journalEntries': loadJournalEntries(); break;
                case 'bankTransfers': loadBankTransfers(); break;
                case 'glAccounts': loadGLAccounts(); break;
            }
        }

        function setupEventListeners() {
            const forms = [
                {form: DOMElements.receivableForm, path: 'receivables', name: 'Receivable'},
                {form: DOMElements.payableForm, path: 'payables', name: 'Payable'},
                {form: DOMElements.bankAccountForm, path: 'bankAccounts', name: 'Bank Account'},
                {form: DOMElements.journalEntryForm, path: 'journalEntries', name: 'Journal Entry'},
                {form: DOMElements.bankTransferForm, path: 'bankTransfers', name: 'Bank Transfer'},
                {form: DOMElements.glAccountForm, path: 'glAccounts', name: 'GL Account'}
            ];
            forms.forEach(f => {
                if (f.form) f.form.addEventListener('submit', (e) => handleGenericFormSubmit(e, f.path, f.name, f.form.id.replace('Form','Modal')));
            });
            if(DOMElements.addJeLineBtn) DOMElements.addJeLineBtn.addEventListener('click', () => addJournalEntryLine());

            const jeLinesContainer = DOMElements.journalEntryForm.querySelector('#jeLinesContainer');
            if (jeLinesContainer) {
                jeLinesContainer.addEventListener('input', (e) => {
                    if (e.target.matches('input[name^="debit_"], input[name^="credit_"]')) {
                        updateJournalEntryTotals();
                    }
                });
            }
        }

        async function handleGenericFormSubmit(e, firebasePath, itemName, modalId) {
            e.preventDefault();
            if (!pageCurrentUserId || !commonDependencies.fbServerTimestamp) { commonDependencies.commonShowAlert('System error or user not authenticated.'); return; }
            const form = e.target;
            const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
            const id = idInputName ? form.elements[idInputName].value : null;
            let data = {};
            if (firebasePath === 'journalEntries') {
                data.date = form.elements.date.value;
                data.description = form.elements.description.value;
                data.lines = [];
                const lineContainers = form.querySelectorAll('.je-line-item');
                let totalDebits = 0, totalCredits = 0;
                for (const lineEl of lineContainers) {
                    const type = lineEl.querySelector('select[name^="lineType_"]').value;
                    const amount = parseFloat(lineEl.querySelector('input[name^="lineAmount_"]').value) || 0;
                    const lineData = {
                        glAccountId: lineEl.querySelector('select[name^="glAccountId_"]').value,
                        description: lineEl.querySelector('input[name^="lineDescription_"]').value,
                        debit: type === 'debit' ? amount : 0,
                        credit: type === 'credit' ? amount : 0,
                    };

                    if (!lineData.glAccountId || amount === 0) { continue; }
                    data.lines.push(lineData);
                    totalDebits += lineData.debit;
                    totalCredits += lineData.credit;
                }
                if (data.lines.length < 2) { commonDependencies.commonShowAlert('Journal entry must have at least two lines.'); return; }
                if (Math.abs(totalDebits - totalCredits) > 0.001) { commonDependencies.commonShowAlert('Debits must equal credits. Please check your entry.'); return; }
                data.totalDebits = totalDebits;
                data.totalCredits = totalCredits;
            } else {
                for (let element of form.elements) {
                    if (element.name && element.type !== 'submit' && element.type !== 'button') data[element.name] = element.value;
                }
                if(idInputName) delete data[idInputName];
            }
            data.userId = pageCurrentUserId; data.updatedAt = commonDependencies.fbServerTimestamp();
            try {
                const path = `${firebasePath}/${pageCurrentUserId}`;
                if (id) {
                    const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                    const snapshot = await commonDependencies.fbGetDbData(itemRef);
                    const existingData = snapshot.val() || {};
                    await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                    commonDependencies.commonShowAlert(`${itemName} updated.`);
                } else {
                    data.createdAt = commonDependencies.fbServerTimestamp();
                    await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                    commonDependencies.commonShowAlert(`${itemName} added.`);
                }
                if (document.getElementById(modalId)) document.getElementById(modalId).style.display = 'none';
            } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
        }

        function openModalForSubsection(subsection, id = null, data = {}) {
            let modal, form;
            switch (subsection) {
                case 'receivables': modal = DOMElements.receivableModal; form = DOMElements.receivableForm; break;
                case 'payables': modal = DOMElements.payableModal; form = DOMElements.payableForm; break;
                case 'bankAccounts': modal = DOMElements.bankAccountModal; form = DOMElements.bankAccountForm; break;
                case 'journalEntries': modal = DOMElements.journalEntryModal; form = DOMElements.journalEntryForm; resetJournalEntryLines(form, data.lines); break;
                case 'bankTransfers': modal = DOMElements.bankTransferModal; form = DOMElements.bankTransferForm; break;
                case 'glAccounts': modal = DOMElements.glAccountModal; form = DOMElements.glAccountForm; break;
                default: return;
            }
            if (form) {
                form.reset();
                const idInputName = Object.keys(form.elements).find(key => key.name && key.name.toLowerCase().includes('id') && form.elements[key].type === 'hidden');
                if(idInputName && form.elements[idInputName]) form.elements[idInputName].value = id || '';
                if (subsection !== 'journalEntries') { 
                     for (const key in data) { if (form.elements[key]) form.elements[key].value = data[key]; }
                } else {
                    if (form.elements.date) form.elements.date.value = data.date || '';
                    if (form.elements.description) form.elements.description.value = data.description || '';
                }
            }
            if (modal) modal.style.display = 'flex';
        }
        async function handleDeleteGeneric(firebasePath, itemId, itemName) {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.commonShowConfirm) return;
            const confirmed = await commonDependencies.commonShowConfirm(`Delete this ${itemName}?`);
            if (confirmed) {
                try {
                    await commonDependencies.fbRemove(commonDependencies.fbRef(pageDatabase, `${firebasePath}/${pageCurrentUserId}/${itemId}`));
                    commonDependencies.commonShowAlert(`${itemName} deleted.`);
                } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
            }
        }

        function loadReceivables() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `receivables/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('date')), (snapshot) => {
                receivablesData = [];
                snapshot.forEach(child => { receivablesData.push({id: child.key, ...child.val()}); });
                renderReceivables();
            });
        }
        function renderReceivables() {
            DOMElements.receivablesTableBody.innerHTML = ''; let hasData = false;
            const propertyFilter = document.getElementById('receivablesFilterProperty')?.dataset.value;
            const statusFilter = document.getElementById('receivablesFilterStatus')?.dataset.value;

            const filteredData = receivablesData.filter(item => {
                const matchesProperty = !propertyFilter || item.propertyId === propertyFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                return matchesProperty && matchesStatus;
            }).reverse();

            filteredData.forEach(item => { hasData = true; populateReceivableRow(item); });
            DOMElements.noReceivablesMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateReceivableRow(data) {
            const row = DOMElements.receivablesTableBody.insertRow();
            row.insertCell().textContent = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.payerName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || 'N/A';
            row.insertCell().textContent = data.description;
            row.insertCell().textContent = data.amountDue ? `$${parseFloat(data.amountDue).toFixed(2)}` : 'N/A';
            row.insertCell().textContent = data.amountPaid ? `$${parseFloat(data.amountPaid).toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'due').toLowerCase()}">${data.status || 'Due'}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('receivables', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('receivables', data.id, 'Receivable'));
            row.addEventListener('click', () => openModalForSubsection('receivables', data.id, data));
        }
        function loadPayables() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `payables/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('dueDate')), (snapshot) => {
                payablesData = [];
                snapshot.forEach(child => { payablesData.push({id: child.key, ...child.val()}); });
                renderPayables();
            });
        }
        function renderPayables() {
            DOMElements.payablesTableBody.innerHTML = ''; let hasData = false;
            const propertyFilter = document.getElementById('payablesFilterProperty')?.dataset.value;
            const statusFilter = document.getElementById('payablesFilterStatus')?.dataset.value;

            const filteredData = payablesData.filter(item => {
                const matchesProperty = !propertyFilter || !item.propertyId || item.propertyId === propertyFilter;
                const matchesStatus = !statusFilter || item.status === statusFilter;
                return matchesProperty && matchesStatus;
            }).reverse();

            filteredData.forEach(child => { hasData = true; populatePayableRow(child); });
            DOMElements.noPayablesMessage.style.display = hasData ? 'none' : 'block';
        }
        function populatePayableRow(data) {
            const row = DOMElements.payablesTableBody.insertRow();
            row.insertCell().textContent = data.dueDate ? new Date(data.dueDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.payeeName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || 'N/A';
            row.insertCell().textContent = data.description;
            row.insertCell().textContent = data.amount ? `$${parseFloat(data.amount).toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'unpaid').toLowerCase()}">${data.status || 'Unpaid'}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('payables', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('payables', data.id, 'Payable'));
            row.addEventListener('click', () => openModalForSubsection('payables', data.id, data));
        }
        function loadBankAccounts() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `bankAccounts/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('accountName')), (snapshot) => {
                bankAccountsData = [];
                snapshot.forEach(child => { bankAccountsData.push({id: child.key, ...child.val()}); });
                renderBankAccounts();
            });
        }
        function renderBankAccounts() {
            DOMElements.bankAccountsTableBody.innerHTML = ''; let hasData = false;
            const typeFilter = document.getElementById('bankAccountsFilterType')?.dataset.value;
            
            const filteredData = bankAccountsData.filter(item => {
                const matchesType = !typeFilter || item.accountType === typeFilter;
                return matchesType;
            });
            
            filteredData.forEach(child => { hasData = true; populateBankAccountRow(child); });
            DOMElements.noBankAccountsMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateBankAccountRow(data) {
            const row = DOMElements.bankAccountsTableBody.insertRow();
            row.insertCell().textContent = data.accountName;
            row.insertCell().textContent = data.bankName || 'N/A';
            row.insertCell().textContent = data.accountNumber ? `...${data.accountNumber.slice(-4)}` : 'N/A';
            row.insertCell().textContent = data.accountType || 'N/A';
            row.insertCell().textContent = data.currentBalance ? `$${parseFloat(data.currentBalance).toFixed(2)}` : 'N/A'; 
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('bankAccounts', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('bankAccounts', data.id, 'Bank Account'));
            row.addEventListener('click', () => openModalForSubsection('bankAccounts', data.id, data));
        }
        function updateJournalEntryTotals() {
            const lines = DOMElements.journalEntryForm.querySelectorAll('.je-line-item');
            let totalDebits = 0, totalCredits = 0;

            lines.forEach(line => {
                const type = line.querySelector('select[name^="lineType_"]').value;
                const amount = parseFloat(line.querySelector('input[name^="lineAmount_"]').value) || 0;
                if (type === 'debit') {
                    totalDebits += amount;
                } else {
                    totalCredits += amount;
                }
            });

            const formatter = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('totalDebits').textContent = formatter.format(totalDebits);
            document.getElementById('totalCredits').textContent = formatter.format(totalCredits);

            const statusEl = document.getElementById('jeBalanceStatus');
            if (Math.abs(totalDebits - totalCredits) < 0.001 && totalDebits > 0) {
                statusEl.textContent = 'Balanced';
                statusEl.className = 'balanced';
            } else {
                statusEl.textContent = 'Unbalanced';
                statusEl.className = 'unbalanced';
            }
        }
        
        function addJournalEntryLine(glAccountId = '', description = '', type = 'debit', amount = '') {
            const container = DOMElements.journalEntryForm.querySelector('#jeLinesContainer');
            const lineNum = Date.now(); // Use timestamp for a more unique ID
            const lineDiv = document.createElement('div');
            lineDiv.className = 'je-table je-line-item';

            let glOptionsHTML = '<option value="">Select GL Account</option>';
            for (const [id, acc] of Object.entries(localGLAccountsMap)) {
                const isSelected = id === glAccountId ? 'selected' : '';
                glOptionsHTML += `<option value="${id}" ${isSelected}>${acc.number} - ${acc.name}</option>`;
            }

            const typeOptionsHTML = `
                <option value="debit" ${type === 'debit' ? 'selected' : ''}>Debit</option>
                <option value="credit" ${type === 'credit' ? 'selected' : ''}>Credit</option>
            `;

            lineDiv.innerHTML = `
                <div style="grid-column: 1;"><select name="glAccountId_${lineNum}" class="form-control" required>${glOptionsHTML}</select></div>
                <div style="grid-column: 2;"><input type="text" name="lineDescription_${lineNum}" class="form-control" placeholder="Line item description" value="${description}"></div>
                <div style="grid-column: 3;"><select name="lineType_${lineNum}" class="form-control">${typeOptionsHTML}</select></div>
                <div style="grid-column: 4;"><input type="number" name="lineAmount_${lineNum}" class="form-control" placeholder="$0.00" style="text-align: right;" step="0.01" min="0" value="${amount}"></div>
                <div style="grid-column: 5; text-align: center;">
                    <button type="button" class="delete-je-line-btn">${commonDependencies.commonDeleteIcon}</button>
                </div>
            `;
            
            lineDiv.querySelector('.delete-je-line-btn').addEventListener('click', () => {
                lineDiv.remove();
                updateJournalEntryTotals();
            });
            container.appendChild(lineDiv);
        }

        function resetJournalEntryLines(form, lines = []) {
            if (!form) return;
            const container = form.querySelector('#jeLinesContainer');
            if (!container) return;
            container.innerHTML = ''; 
            if (lines && lines.length > 0) {
                lines.forEach(line => {
                    const isDebit = line.debit && parseFloat(line.debit) > 0;
                    const type = isDebit ? 'debit' : 'credit';
                    const amount = isDebit ? line.debit : line.credit;
                    addJournalEntryLine(line.glAccountId, line.description, type, amount);
                });
            } else {
                addJournalEntryLine('', '', 'debit', ''); 
                addJournalEntryLine('', '', 'credit', ''); 
            }
            updateJournalEntryTotals();
        }
        function loadJournalEntries() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `journalEntries/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('date')), (snapshot) => {
                journalEntriesData = [];
                snapshot.forEach(child => { journalEntriesData.push({id: child.key, ...child.val()}); });
                renderJournalEntries();
            });
        }
        function renderJournalEntries() {
            DOMElements.journalEntriesTableBody.innerHTML = ''; let hasData = false;
            const startDateFilter = document.getElementById('journalEntriesFilterStartDate')?.value;
            const endDateFilter = document.getElementById('journalEntriesFilterEndDate')?.value;
            
            const filteredData = journalEntriesData.filter(item => {
                if (!item.date) return false;
                const itemDate = new Date(item.date + 'T00:00:00');
                const matchesStart = !startDateFilter || itemDate >= new Date(startDateFilter + 'T00:00:00');
                const matchesEnd = !endDateFilter || itemDate <= new Date(endDateFilter + 'T00:00:00');
                return matchesStart && matchesEnd;
            }).reverse();

            filteredData.forEach(child => { hasData = true; populateJournalEntryRow(child); });
            DOMElements.noJournalEntriesMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateJournalEntryRow(data) {
            const row = DOMElements.journalEntriesTableBody.insertRow();
            row.insertCell().textContent = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.id.substring(0,8) + '...';
            row.insertCell().textContent = data.description;
            row.insertCell().textContent = data.totalDebits ? `$${parseFloat(data.totalDebits).toFixed(2)}` : '$0.00';
            row.insertCell().textContent = data.totalCredits ? `$${parseFloat(data.totalCredits).toFixed(2)}` : '$0.00';
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('journalEntries', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('journalEntries', data.id, 'Journal Entry'));
            row.addEventListener('click', () => openModalForSubsection('journalEntries', data.id, data));
        }
        function loadBankTransfers() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `bankTransfers/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('date')), (snapshot) => {
                bankTransfersData = [];
                snapshot.forEach(child => { bankTransfersData.push({id: child.key, ...child.val()}); });
                renderBankTransfers();
            });
        }
        function renderBankTransfers() {
            DOMElements.bankTransfersTableBody.innerHTML = ''; let hasData = false;
            const statusFilter = document.getElementById('bankTransfersFilterStatus')?.dataset.value;

            const filteredData = bankTransfersData.filter(item => {
                const matchesStatus = !statusFilter || item.status === statusFilter;
                return matchesStatus;
            }).reverse();

            filteredData.forEach(child => { hasData = true; populateBankTransferRow(child); });
            DOMElements.noBankTransfersMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateBankTransferRow(data) {
            const row = DOMElements.bankTransfersTableBody.insertRow();
            row.insertCell().textContent = data.date ? new Date(data.date).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = localBankAccountsMap[data.fromAccountId] || 'N/A';
            row.insertCell().textContent = localBankAccountsMap[data.toAccountId] || 'N/A';
            row.insertCell().textContent = data.amount ? `$${parseFloat(data.amount).toFixed(2)}` : 'N/A';
            row.insertCell().textContent = data.memo || 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'pending').toLowerCase()}">${data.status || 'Pending'}</span>`; 
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('bankTransfers', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('bankTransfers', data.id, 'Bank Transfer'));
            row.addEventListener('click', () => openModalForSubsection('bankTransfers', data.id, data));
        }
        function loadGLAccounts() {
            if (!pageCurrentUserId || !pageDatabase || !commonDependencies.fbRef) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `glAccounts/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(dataRef, commonDependencies.fbOrderByChild('accountNumber')), (snapshot) => {
                glAccountsData = [];
                snapshot.forEach(child => { glAccountsData.push({id: child.key, ...child.val()}); });
                renderGLAccounts();
            });
        }
        function renderGLAccounts() {
            DOMElements.glAccountsTableBody.innerHTML = ''; let hasData = false;
            const typeFilter = document.getElementById('glAccountsFilterType')?.dataset.value;
            
            const filteredData = glAccountsData.filter(item => {
                const matchesType = !typeFilter || item.type === typeFilter;
                return matchesType;
            });

            filteredData.forEach(child => { hasData = true; populateGLAccountRow(child); });
            DOMElements.noGLAccountsMessage.style.display = hasData ? 'none' : 'block';
        }
        function populateGLAccountRow(data) {
            const row = DOMElements.glAccountsTableBody.insertRow();
            row.insertCell().textContent = data.accountNumber;
            row.insertCell().textContent = data.accountName;
            row.insertCell().textContent = data.type;
            row.insertCell().textContent = data.subType || 'N/A';
            row.insertCell().textContent = 'N/A'; 
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('glAccounts', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('glAccounts', data.id, 'GL Account'));
            row.addEventListener('click', () => openModalForSubsection('glAccounts', data.id, data));
        }

        function setupDiagnosticButtons() {
            const diagnosticButtons = document.querySelectorAll('.run-diagnostic-btn');
            diagnosticButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    const diagnosticType = e.target.dataset.diagnostic;
                    const resultsDiv = document.getElementById(`results-${diagnosticType}`);
                    if (resultsDiv) {
                        resultsDiv.innerHTML = '<p style="color: #6c757d; font-style: italic;">Running diagnostic...</p>';
                    }
                    try {
                        await runDiagnostic(diagnosticType, resultsDiv);
                    } catch (error) {
                        console.error("Diagnostic error:", error);
                        if (resultsDiv) {
                            resultsDiv.innerHTML = `<p style="color: #dc3545;">An error occurred while running the diagnostic: ${error.message}</p>`;
                        }
                        commonDependencies.commonShowAlert(`An error occurred: ${error.message}`);
                    }
                });
            });
        }

        async function runDiagnostic(diagnosticType, resultsDiv) {
            const [
                receivablesSnap,
                payablesSnap,
                glAccountsSnap,
                journalEntriesSnap,
                bankAccountsSnap,
                propertiesSnap,
                bankTransfersSnap
            ] = await Promise.all([
                getDbData(commonDependencies.fbRef(pageDatabase, `receivables/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `payables/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `glAccounts/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `journalEntries/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `bankAccounts/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`)),
                getDbData(commonDependencies.fbRef(pageDatabase, `bankTransfers/${pageCurrentUserId}`))
            ]);

            const receivables = receivablesSnap.val() || {};
            const payables = payablesSnap.val() || {};
            const glAccounts = glAccountsSnap.val() || {};
            const journalEntries = journalEntriesSnap.val() || {};
            const bankAccounts = bankAccountsSnap.val() || {};
            const properties = propertiesSnap.val() || {};
            const bankTransfers = bankTransfersSnap.val() || {};

            // Add IDs to objects
            Object.keys(glAccounts).forEach(id => glAccounts[id].id = id);
            Object.keys(journalEntries).forEach(id => journalEntries[id].id = id);

            let glBalances = calculateGLAccountBalances(journalEntries, glAccounts);

            switch (diagnosticType) {
                case 'unreconciled':
                    runUnreconciledReport(resultsDiv, receivables, payables);
                    break;
                case 'aging-discrepancy':
                    runAgingDiscrepancyCheck(resultsDiv, receivables, payables, glAccounts, glBalances);
                    break;
                case 'gl-anomaly':
                    runGLAnomalyScan(resultsDiv, glAccounts, glBalances);
                    break;
                case 'data-integrity':
                    runDataIntegrityCheck(resultsDiv, journalEntries, receivables, payables, bankTransfers, bankAccounts, glAccounts, properties);
                    break;
                default:
                    resultsDiv.innerHTML = `<p>This diagnostic is not yet implemented.</p>`;
            }
        }

        function calculateGLAccountBalances(journalEntries, glAccounts) {
            const balances = {};
            for (const glId in glAccounts) {
                balances[glId] = 0;
            }

            for (const jeId in journalEntries) {
                const entry = journalEntries[jeId];
                if (entry.lines && Array.isArray(entry.lines)) {
                    entry.lines.forEach(line => {
                        if (balances[line.glAccountId] !== undefined) {
                            balances[line.glAccountId] += (parseFloat(line.debit) || 0) - (parseFloat(line.credit) || 0);
                        }
                    });
                }
            }
            return balances;
        }

        function renderFindings(resultsDiv, title, findings, emptyMessage) {
             let content = `<h5>${title}</h5>`;
             if (findings.length === 0) {
                 content += `<p class="text-success">${emptyMessage}</p>`;
             } else {
                 content += `<ul class="diagnostic-findings-list">`;
                 findings.forEach(finding => {
                     content += `<li>${finding}</li>`;
                 });
                 content += `</ul>`;
             }
             resultsDiv.innerHTML = content;
        }

        function runUnreconciledReport(resultsDiv, receivables, payables) {
            let findings = [];
            
            Object.values(receivables).forEach(r => {
                if (r.status === 'Paid') {
                    findings.push(`Receivable from ${r.payerName} for $${parseFloat(r.amountDue).toFixed(2)} marked as 'Paid' on ${r.date}. Review if a corresponding journal entry to debit a bank account and credit Accounts Receivable has been recorded.`);
                }
            });

            Object.values(payables).forEach(p => {
                if (p.status === 'Paid') {
                    findings.push(`Payable to ${p.payeeName} for $${parseFloat(p.amount).toFixed(2)} marked as 'Paid' with due date ${p.dueDate}. Review if a corresponding journal entry to credit a bank account and debit Accounts Payable has been recorded.`);
                }
            });
            
            renderFindings(resultsDiv, 'Unreconciled Transactions Report', findings, 'No paid receivables or payables requiring review were found.');
        }

        function runAgingDiscrepancyCheck(resultsDiv, receivables, payables, glAccounts, glBalances) {
            let findings = [];
            
            const arAccount = Object.values(glAccounts).find(a => a.accountName.toLowerCase().includes('accounts receivable'));
            let totalReceivables = 0;
            Object.values(receivables).forEach(r => {
                if (['Due', 'Overdue', 'Partial'].includes(r.status)) {
                    totalReceivables += parseFloat(r.amountDue) - (parseFloat(r.amountPaid) || 0);
                }
            });
            
            if (arAccount) {
                const arBalance = glBalances[arAccount.id];
                if (Math.abs(arBalance - totalReceivables) > 0.01) {
                    findings.push(`Accounts Receivable balance discrepancy found. GL balance is $${arBalance.toFixed(2)}, but total outstanding receivables is $${totalReceivables.toFixed(2)}.`);
                }
            } else {
                findings.push('Could not find a GL Account for "Accounts Receivable". Unable to perform discrepancy check for receivables.');
            }

            const apAccount = Object.values(glAccounts).find(a => a.accountName.toLowerCase().includes('accounts payable'));
            let totalPayables = 0;
            Object.values(payables).forEach(p => {
                if (['Unpaid', 'Pending'].includes(p.status)) {
                    totalPayables += parseFloat(p.amount);
                }
            });

            if (apAccount) {
                const apBalance = Math.abs(glBalances[apAccount.id]); // AP has credit balance
                if (Math.abs(apBalance - totalPayables) > 0.01) {
                    findings.push(`Accounts Payable balance discrepancy found. GL balance is $${apBalance.toFixed(2)}, but total outstanding payables is $${totalPayables.toFixed(2)}.`);
                }
            } else {
                findings.push('Could not find a GL Account for "Accounts Payable". Unable to perform discrepancy check for payables.');
            }
            
            renderFindings(resultsDiv, 'Aged Payables/Receivables Discrepancy Check', findings, 'No discrepancies found between subledgers and general ledger.');
        }

        function runGLAnomalyScan(resultsDiv, glAccounts, glBalances) {
            let findings = [];
            const expectations = {
                'Asset': 'debit', 'Expense': 'debit',
                'Liability': 'credit', 'Equity': 'credit', 'Income': 'credit'
            };

            for (const glId in glBalances) {
                const account = glAccounts[glId];
                if (!account) continue;

                const balance = glBalances[glId];
                const expectedType = expectations[account.type];
                
                if (expectedType === 'debit' && balance < -0.01) {
                    findings.push(`GL Anomaly: ${account.type} account '${account.accountName}' (${account.accountNumber}) has an unexpected credit balance of $${Math.abs(balance).toFixed(2)}.`);
                } else if (expectedType === 'credit' && balance > 0.01) {
                    findings.push(`GL Anomaly: ${account.type} account '${account.accountName}' (${account.accountNumber}) has an unexpected debit balance of $${balance.toFixed(2)}.`);
                }
            }
            renderFindings(resultsDiv, 'GL Balance Anomaly Detection', findings, 'No general ledger balance anomalies detected.');
        }

        function runDataIntegrityCheck(resultsDiv, journalEntries, receivables, payables, bankTransfers, bankAccounts, glAccounts, properties) {
            let findings = [];
            const propertyIds = Object.keys(properties);
            const bankAccountIds = Object.keys(bankAccounts);
            const glAccountIds = Object.keys(glAccounts);

            Object.values(journalEntries).forEach(je => {
                if (!je.lines || !Array.isArray(je.lines)) {
                    findings.push(`Data Integrity: Journal Entry <a href="#" onclick="openModalForSubsection('journalEntries', '${je.id}', JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(je))}')))">${je.id.substring(0,8)}...</a> has malformed line data.`);
                    return;
                }
                let debits = 0, credits = 0;
                je.lines.forEach((line, index) => {
                    debits += parseFloat(line.debit) || 0;
                    credits += parseFloat(line.credit) || 0;
                    if (!glAccountIds.includes(line.glAccountId)) {
                        findings.push(`Data Integrity: Journal Entry <a href="#" onclick="openModalForSubsection('journalEntries', '${je.id}', JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(je))}')))">${je.id.substring(0,8)}...</a>, line ${index + 1}, refers to a non-existent GL Account ID.`);
                    }
                });
                if (Math.abs(debits - credits) > 0.01) {
                     findings.push(`Data Integrity: Journal Entry <a href="#" onclick="openModalForSubsection('journalEntries', '${je.id}', JSON.parse(decodeURIComponent('${encodeURIComponent(JSON.stringify(je))}')))">${je.id.substring(0,8)}...</a> is out of balance. Debits: $${debits.toFixed(2)}, Credits: $${credits.toFixed(2)}.`);
                }
            });

            Object.entries(receivables).forEach(([id, r]) => {
                if (r.propertyId && !propertyIds.includes(r.propertyId)) {
                    findings.push(`Data Integrity: Receivable for ${r.payerName} refers to a non-existent Property ID.`);
                }
            });
            Object.entries(payables).forEach(([id, p]) => {
                if (p.propertyId && !propertyIds.includes(p.propertyId)) {
                    findings.push(`Data Integrity: Payable to ${p.payeeName} refers to a non-existent Property ID.`);
                }
            });
            Object.entries(bankTransfers).forEach(([id, t]) => {
                if (t.fromAccountId && !bankAccountIds.includes(t.fromAccountId)) {
                    findings.push(`Data Integrity: Bank Transfer from a non-existent account.`);
                }
                if (t.toAccountId && !bankAccountIds.includes(t.toAccountId)) {
                     findings.push(`Data Integrity: Bank Transfer to a non-existent account.`);
                }
            });

            renderFindings(resultsDiv, 'Data Integrity Check', findings, 'No data integrity issues found.');
        }

        function renderActiveSubsectionData() {
            const activeNavItem = document.querySelector('#accountingSubNav .sub-nav-item.active');
            if (!activeNavItem) return;
            const activeSubSection = activeNavItem.dataset.subsection;
            switch (activeSubSection) {
                case 'receivables': renderReceivables(); break;
                case 'payables': renderPayables(); break;
                case 'bankAccounts': renderBankAccounts(); break;
                case 'journalEntries': renderJournalEntries(); break;
                case 'bankTransfers': renderBankTransfers(); break;
                case 'glAccounts': renderGLAccounts(); break;
            }
        }

        initializeAuth(pageInit);
    </script>
</body>
</html> 