<!DOCTYPE html>
<html lang="en" class="js-loading">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="/js/fouc-prevention.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .metric-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .metric-item h5 {
            color: #64748b;
            font-size: 0.875rem;
            margin: 0 0 8px 0;
        }
        .metric-value {
            font-size: 1.875rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 8px 0;
        }
        .metric-detail {
            display: inline-block;
            color: #000;
            padding: 6px 14px;
            border-radius: 16px;
            background-color: #ffffff;
            font-size: 0.875rem;
            cursor: pointer;
            margin: 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s ease-in-out;
        }
        .metric-detail:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .activity-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .activity-list li {
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
            color: #475569;
            font-size: 0.875rem;
        }
        .activity-list li:last-child {
            border-bottom: none;
        }
        .view-all-link {
            display: inline-block;
            margin-top: 16px;
            color: #3b82f6;
            text-decoration: none;
            font-size: 0.875rem;
        }
        .view-all-link:hover {
            text-decoration: underline;
        }
        .quick-links {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        .quick-link-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 8px;
            text-decoration: none;
            color: #1e293b;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .quick-link-item:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-top: 24px;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .chart-container h5 {
            margin: 0 0 16px 0;
            color: #1e293b;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        .activity-modal-btn {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 28px;
            background: #22223b;
            color: #fff;
            border: 1.5px solid #22223b;
            border-radius: 24px;
            font-size: 1rem;
            font-weight: 500;
            transition: background 0.18s, color 0.18s, border-color 0.18s;
            cursor: pointer;
            outline: none;
        }
        .activity-modal-btn:hover, .activity-modal-btn:focus {
            background: #393a56;
            color: #fff;
            border-color: #393a56;
        }
        .activity-link {
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }
        .activity-link:hover, .activity-link:focus {
            background: #f3f4f6;
            color: #22223b;
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div class="content-header">
            <h2>Dashboard</h2>
        </div>
        <div class="page-container">
            <!-- Dashboard Section: Key Metrics -->
            <div class="dashboard-section">
                <h4>Key Metrics Overview</h4>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <h5>Monthly Recurring Revenue</h5>
                        <p class="metric-value" id="monthlyRecurringRevenueValue"><span class="skeleton skeleton-block"></span></p>
                        <p class="metric-detail">View Report</p>
                    </div>
                    <div class="metric-item">
                        <h5>Occupancy Rate</h5>
                        <p class="metric-value" id="occupancyRateValue"><span class="skeleton skeleton-block"></span></p>
                        <p class="metric-detail">View Report</p>
                    </div>
                    <div class="metric-item">
                        <h5>Open Maintenance Requests</h5>
                        <p class="metric-value" id="openMaintenanceValue"><span class="skeleton skeleton-block"></span></p>
                        <p class="metric-detail">View Requests</p>
                    </div>
                    <div class="metric-item">
                        <h5>Overdue Payments</h5>
                        <p class="metric-value" id="overduePaymentsValue"><span class="skeleton skeleton-block"></span></p>
                        <p class="metric-detail">View Payments</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section: Charts -->
            <div class="dashboard-section">
                <h4>Performance Analytics</h4>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h5>Revenue vs Expenses</h5>
                        <div class="chart-wrapper">
                            <div class="skeleton skeleton-block" style="height: 200px;"></div>
                            <canvas id="revenueExpensesChart" style="display:none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h5>Occupancy Trends</h5>
                        <div class="chart-wrapper">
                            <div class="skeleton skeleton-block" style="height: 200px;"></div>
                            <canvas id="occupancyTrendsChart" style="display:none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h5>Maintenance Requests by Priority</h5>
                        <div class="chart-wrapper">
                            <div class="skeleton skeleton-block" style="height: 200px;"></div>
                            <canvas id="maintenancePriorityChart" style="display:none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h5>Payment Status Distribution</h5>
                        <div class="chart-wrapper">
                            <div class="skeleton skeleton-block" style="height: 200px;"></div>
                            <canvas id="paymentStatusChart" style="display:none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Section: Recent Activity -->
            <div class="dashboard-section">
                <h4>Recent Activity</h4>
                <ul class="activity-list" id="activityList"></ul>
                <button id="viewAllActivityBtn" class="activity-modal-btn" type="button">View all activity</button>
            </div>

            <!-- Dashboard Section: Quick Links -->
            <div class="dashboard-section">
                <h4>Quick Links</h4>
                <div class="quick-links">
                    <a href="platform_properties.html" class="quick-link-item">Manage Properties</a>
                    <a href="platform_leasing.html" class="quick-link-item">Manage Leases</a>
                    <a href="platform_maintenance.html" class="quick-link-item">Maintenance Requests</a>
                    <a href="platform_accounting.html" class="quick-link-item">Accounting Overview</a>
                    <a href="platform_people.html" class="quick-link-item">Manage People</a>
                </div>
            </div>
        </div>
    </div>
    
    <div id="ai-agent-container"></div>

    <div id="customAlertModal">
        <div class="custom-alert">
            <p id="customAlertMessage"></p>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3>All Recent Activity</h3>
                <button class="close-btn" data-modal-id="activityModal">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="activity-list" id="activityModalList">
                    <li>Loading activity...</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeAuth, showAlert, getDbData } from './js/platform_common.js';
        import { getDatabase, ref, onValue, query, orderByChild, limitToLast, equalTo, get, startAt } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let pageCurrentUserId;
        let pageDatabase;
        let charts = {};

        const DOMElements = {
            monthlyRecurringRevenueValue: document.getElementById('monthlyRecurringRevenueValue'),
            occupancyRateValue: document.getElementById('occupancyRateValue'),
            openMaintenanceValue: document.getElementById('openMaintenanceValue'),
            overduePaymentsValue: document.getElementById('overduePaymentsValue'),
            activityList: document.getElementById('activityList')
        };

        function pageInit(userId, db, commonShowAlert, commonGetDbData) {
            pageCurrentUserId = userId;
            pageDatabase = db;
            console.log("Dashboard page initialized for user:", userId);
            
            loadKeyMetrics();
            loadRecentActivity();
            initializeCharts();
            setupMetricDetailHandlers();
            setupActivityModal();
        }

        function setupMetricDetailHandlers() {
            // Monthly Recurring Revenue - View Details
            const mrrDetail = document.querySelector('.metric-item:nth-child(1) .metric-detail');
            if (mrrDetail) {
                mrrDetail.addEventListener('click', () => {
                    window.location.href = 'platform_reporting.html?view=rent_roll';
                });
            }

            // Occupancy Rate - View Report
            const occupancyRateDetail = document.querySelector('.metric-item:nth-child(2) .metric-detail');
            if (occupancyRateDetail) {
                occupancyRateDetail.addEventListener('click', () => {
                    window.location.href = 'platform_reporting.html?view=occupancy';
                });
            }

            // Open Maintenance - View Requests
            const maintenanceDetail = document.querySelector('.metric-item:nth-child(3) .metric-detail');
            if (maintenanceDetail) {
                maintenanceDetail.addEventListener('click', () => {
                    window.location.href = 'platform_maintenance.html?status=open';
                });
            }

            // Overdue Payments - View Payments
            const paymentsDetail = document.querySelector('.metric-item:nth-child(4) .metric-detail');
            if (paymentsDetail) {
                paymentsDetail.addEventListener('click', () => {
                    window.location.href = 'platform_accounting.html?status=overdue';
                });
            }
        }

        function initializeCharts() {
            // Revenue vs Expenses Chart
            const revenueExpensesCanvas = document.getElementById('revenueExpensesChart');
            const revenueExpensesSkeleton = revenueExpensesCanvas.previousElementSibling;
            
            // Show canvas and hide skeleton
            if (revenueExpensesSkeleton && revenueExpensesSkeleton.classList.contains('skeleton')) {
                revenueExpensesSkeleton.remove();
            }
            revenueExpensesCanvas.style.display = '';
            
            const revenueExpensesCtx = revenueExpensesCanvas.getContext('2d');
            charts.revenueExpenses = new Chart(revenueExpensesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Revenue',
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            data: []
                        },
                        {
                            label: 'Expenses',
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            data: []
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Occupancy Trends Chart
            const occupancyTrendsCanvas = document.getElementById('occupancyTrendsChart');
            const occupancyTrendsSkeleton = occupancyTrendsCanvas.previousElementSibling;
            
            // Show canvas and hide skeleton
            if (occupancyTrendsSkeleton && occupancyTrendsSkeleton.classList.contains('skeleton')) {
                occupancyTrendsSkeleton.remove();
            }
            occupancyTrendsCanvas.style.display = '';
            
            const occupancyTrendsCtx = occupancyTrendsCanvas.getContext('2d');
            charts.occupancyTrends = new Chart(occupancyTrendsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Occupancy Rate',
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        data: []
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + '%'
                            }
                        }
                    }
                }
            });

            // Maintenance Priority Chart
            const maintenancePriorityCanvas = document.getElementById('maintenancePriorityChart');
            const maintenancePrioritySkeleton = maintenancePriorityCanvas.previousElementSibling;
            
            // Show canvas and hide skeleton
            if (maintenancePrioritySkeleton && maintenancePrioritySkeleton.classList.contains('skeleton')) {
                maintenancePrioritySkeleton.remove();
            }
            maintenancePriorityCanvas.style.display = '';
            
            const maintenancePriorityCtx = maintenancePriorityCanvas.getContext('2d');
            charts.maintenancePriority = new Chart(maintenancePriorityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['High', 'Medium', 'Low'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#EF4444',
                            '#F59E0B',
                            '#10B981'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            // Payment Status Chart
            const paymentStatusCanvas = document.getElementById('paymentStatusChart');
            const paymentStatusSkeleton = paymentStatusCanvas.previousElementSibling;
            
            // Show canvas and hide skeleton
            if (paymentStatusSkeleton && paymentStatusSkeleton.classList.contains('skeleton')) {
                paymentStatusSkeleton.remove();
            }
            paymentStatusCanvas.style.display = '';
            
            const paymentStatusCtx = paymentStatusCanvas.getContext('2d');
            charts.paymentStatus = new Chart(paymentStatusCtx, {
                type: 'pie',
                data: {
                    labels: ['Paid', 'Overdue', 'Pending'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#10B981',
                            '#EF4444',
                            '#F59E0B'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });

            loadChartData();
        }

        async function loadChartData() {
            if (!pageCurrentUserId || !pageDatabase) return;

            // Calculate the date 12 months ago to create a query range
            const aYearAgo = new Date();
            aYearAgo.setMonth(aYearAgo.getMonth() - 12);
            const aYearAgoISO = aYearAgo.toISOString().split('T')[0];

            // Load Revenue vs Expenses data
            const transactionsRef = ref(pageDatabase, `transactions/${pageCurrentUserId}`);
            // Corrected query to fetch all transactions in the last 12 months
            const transactionsQuery = query(transactionsRef, orderByChild('date'), startAt(aYearAgoISO));

            onValue(transactionsQuery, (snapshot) => {
                const monthlyData = {};
                snapshot.forEach(child => {
                    const transaction = child.val();
                    // Fix: Ensure date is parsed as local time to avoid timezone-related errors
                    const date = new Date(transaction.date + 'T00:00:00');
                    // Use a consistent key format 'YYYY-MM' for proper sorting
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = { revenue: 0, expenses: 0 };
                    }
                    
                    // Corrected the case-sensitive check for transaction type
                    if (transaction.type === 'Income') {
                        monthlyData[monthKey].revenue += parseFloat(transaction.amount);
                    } else {
                        monthlyData[monthKey].expenses += parseFloat(transaction.amount);
                    }
                });
                
                // For debugging: log the processed monthly data
                console.log("Processed Monthly Data for Chart:", monthlyData);

                const labels = Object.keys(monthlyData).sort(); // Sorting keys alphabetically now works for 'YYYY-MM'
                const revenueData = labels.map(month => monthlyData[month].revenue);
                const expensesData = labels.map(month => monthlyData[month].expenses);

                // If no data, show empty state
                if (labels.length === 0) {
                    charts.revenueExpenses.data.labels = ['No data available'];
                    charts.revenueExpenses.data.datasets[0].data = [0];
                    charts.revenueExpenses.data.datasets[1].data = [0];
                } else {
                    charts.revenueExpenses.data.labels = labels.map(month => {
                        const [year, monthNum] = month.split('-');
                        return new Date(year, monthNum - 1).toLocaleDateString('default', { month: 'short', year: '2-digit' });
                    });
                    charts.revenueExpenses.data.datasets[0].data = revenueData;
                    charts.revenueExpenses.data.datasets[1].data = expensesData;
                }
                charts.revenueExpenses.update();
            });

            // Load Occupancy Trends data
            const leasesRef = ref(pageDatabase, `leases/${pageCurrentUserId}`);
            const leasesQuery = query(leasesRef, orderByChild('startDate'), limitToLast(12));
            onValue(leasesQuery, (snapshot) => {
                const monthlyOccupancy = {};
                let totalUnits = 0;

                // First, get total units from properties
                const propertiesRef = ref(pageDatabase, `properties/${pageCurrentUserId}`);
                onValue(propertiesRef, (propertiesSnapshot) => {
                    propertiesSnapshot.forEach(property => {
                        totalUnits += parseInt(property.val().numberOfUnits) || 1;
                    });

                    // Then calculate occupancy rates
                    snapshot.forEach(lease => {
                        const leaseData = lease.val();
                        const startDate = new Date(leaseData.startDate);
                        const endDate = new Date(leaseData.endDate);
                        const monthKey = `${startDate.getFullYear()}-${startDate.getMonth() + 1}`;
                        
                        if (!monthlyOccupancy[monthKey]) {
                            monthlyOccupancy[monthKey] = 0;
                        }
                        monthlyOccupancy[monthKey]++;
                    });

                    const labels = Object.keys(monthlyOccupancy).sort();
                    const occupancyData = labels.map(month => (monthlyOccupancy[month] / totalUnits) * 100);

                    // If no data, show empty state
                    if (labels.length === 0) {
                        charts.occupancyTrends.data.labels = ['No data available'];
                        charts.occupancyTrends.data.datasets[0].data = [0];
                    } else {
                        charts.occupancyTrends.data.labels = labels.map(month => {
                            const [year, monthNum] = month.split('-');
                            return new Date(year, monthNum - 1).toLocaleDateString('default', { month: 'short', year: '2-digit' });
                        });
                        charts.occupancyTrends.data.datasets[0].data = occupancyData;
                    }
                    charts.occupancyTrends.update();
                });
            });

            // Load Maintenance Priority data
            const workOrdersRef = ref(pageDatabase, `workOrders/${pageCurrentUserId}`);
            onValue(workOrdersRef, (snapshot) => {
                const priorityCounts = { high: 0, medium: 0, low: 0 };
                snapshot.forEach(wo => {
                    const priority = wo.val().priority?.toLowerCase() || 'medium';
                    priorityCounts[priority]++;
                });

                charts.maintenancePriority.data.datasets[0].data = [
                    priorityCounts.high,
                    priorityCounts.medium,
                    priorityCounts.low
                ];
                
                // If no data, show empty state
                if (priorityCounts.high === 0 && priorityCounts.medium === 0 && priorityCounts.low === 0) {
                    charts.maintenancePriority.data.labels = ['No maintenance requests'];
                    charts.maintenancePriority.data.datasets[0].data = [1];
                    charts.maintenancePriority.data.datasets[0].backgroundColor = ['#e5e7eb'];
                }
                charts.maintenancePriority.update();
            });

            // Load Payment Status data
            const receivablesRef = ref(pageDatabase, `receivables/${pageCurrentUserId}`);
            onValue(receivablesRef, (snapshot) => {
                const statusCounts = { paid: 0, overdue: 0, pending: 0 };
                snapshot.forEach(receivable => {
                    const status = receivable.val().status?.toLowerCase() || 'pending';
                    statusCounts[status]++;
                });

                charts.paymentStatus.data.datasets[0].data = [
                    statusCounts.paid,
                    statusCounts.overdue,
                    statusCounts.pending
                ];
                
                // If no data, show empty state
                if (statusCounts.paid === 0 && statusCounts.overdue === 0 && statusCounts.pending === 0) {
                    charts.paymentStatus.data.labels = ['No payment data'];
                    charts.paymentStatus.data.datasets[0].data = [1];
                    charts.paymentStatus.data.datasets[0].backgroundColor = ['#e5e7eb'];
                }
                charts.paymentStatus.update();
            });
        }

        async function loadKeyMetrics() {
            if (!pageCurrentUserId || !pageDatabase) return;

            // Monthly Recurring Revenue & Active Leases for Occupancy
            const leasesRef = ref(pageDatabase, `leases/${pageCurrentUserId}`);
            const activeLeasesQuery = query(leasesRef, orderByChild('status'), equalTo('Active'));
            onValue(activeLeasesQuery, (snapshot) => {
                let mrr = 0;
                let activeLeaseCount = 0;
                if (snapshot.exists()) {
                    activeLeaseCount = snapshot.size;
                    snapshot.forEach(childSnapshot => {
                        mrr += parseFloat(childSnapshot.val().rentAmount) || 0;
                    });
                }
                if (DOMElements.monthlyRecurringRevenueValue) {
                    // Remove skeleton if present
                    const skeleton = DOMElements.monthlyRecurringRevenueValue.querySelector('.skeleton');
                    if (skeleton) {
                        skeleton.remove();
                    }
                    DOMElements.monthlyRecurringRevenueValue.textContent = `$${mrr.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                calculateAndDisplayOccupancyRate(activeLeaseCount);
            });

            // Open Maintenance Requests
            const workOrdersRef = ref(pageDatabase, `workOrders/${pageCurrentUserId}`);
            onValue(workOrdersRef, (snapshot) => {
                let openCount = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const wo = childSnapshot.val();
                        if (wo.status === 'Open' || wo.status === 'In Progress') {
                            openCount++;
                        }
                    });
                }
                if (DOMElements.openMaintenanceValue) {
                    // Remove skeleton if present
                    const skeleton = DOMElements.openMaintenanceValue.querySelector('.skeleton');
                    if (skeleton) {
                        skeleton.remove();
                    }
                    DOMElements.openMaintenanceValue.textContent = openCount;
                }
            });

            // Overdue Payments
            const receivablesRef = ref(pageDatabase, `receivables/${pageCurrentUserId}`);
            const overdueReceivablesQuery = query(receivablesRef, orderByChild('status'), equalTo('Overdue'));
            onValue(overdueReceivablesQuery, (snapshot) => {
                let totalOverdue = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        const receivable = childSnapshot.val();
                        totalOverdue += parseFloat(receivable.amount) || 0;
                    });
                }
                if (DOMElements.overduePaymentsValue) {
                    // Remove skeleton if present
                    const skeleton = DOMElements.overduePaymentsValue.querySelector('.skeleton');
                    if (skeleton) {
                        skeleton.remove();
                    }
                    DOMElements.overduePaymentsValue.textContent = `$${totalOverdue.toLocaleString()}`;
                }
            });
        }

        async function calculateAndDisplayOccupancyRate(activeLeaseCount) {
            const propertiesRef = ref(pageDatabase, `properties/${pageCurrentUserId}`);
            onValue(propertiesRef, (snapshot) => {
                let totalUnits = 0;
                if (snapshot.exists()) {
                    snapshot.forEach(propSnapshot => {
                        const property = propSnapshot.val();
                        totalUnits += parseInt(property.numberOfUnits) || 1;
                    });
                }
                let occupancyRate = "0%";
                if (totalUnits > 0) {
                    occupancyRate = ((activeLeaseCount / totalUnits) * 100).toFixed(1) + '%';
                }
                if (DOMElements.occupancyRateValue) {
                    // Remove skeleton if present
                    const skeleton = DOMElements.occupancyRateValue.querySelector('.skeleton');
                    if (skeleton) {
                        skeleton.remove();
                    }
                    DOMElements.occupancyRateValue.textContent = occupancyRate;
                }
            });
        }

        async function loadRecentActivity() {
            if (!pageCurrentUserId || !pageDatabase || !DOMElements.activityList) return;
            DOMElements.activityList.innerHTML = '';
            
            const activities = [];
            const maxActivitiesPerType = 2;

            // Fetch recent leases
            try {
                const leasesRef = ref(pageDatabase, `leases/${pageCurrentUserId}`);
                const recentLeasesQuery = query(leasesRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const leaseSnapshot = await get(recentLeasesQuery);
                if (leaseSnapshot.exists()) {
                    leaseSnapshot.forEach(child => {
                        const lease = child.val();
                        const propertyName = lease.propertyId ? `Property ID ${lease.propertyId.substring(0,6)}...` : 'a property';
                        activities.push({ 
                            text: `New lease started for ${propertyName} with ${lease.tenants || 'tenant(s)'}.`, 
                            timestamp: lease.updatedAt || lease.createdAt,
                            type: 'lease'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent leases:", error);
                // Don't show error to user, just continue with other data
            }

            // Fetch recent work orders
            try {
                const workOrdersRef = ref(pageDatabase, `workOrders/${pageCurrentUserId}`);
                const recentWoQuery = query(workOrdersRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const woSnapshot = await get(recentWoQuery);
                if (woSnapshot.exists()) {
                    woSnapshot.forEach(child => {
                        const wo = child.val();
                        const propertyName = wo.propertyId ? `Property ID ${wo.propertyId.substring(0,6)}...` : 'a property';
                        activities.push({ 
                            text: `Work order '${wo.title || 'Untitled'}' for ${propertyName} was updated to status: ${wo.status}.`, 
                            timestamp: wo.updatedAt || wo.createdAt,
                            type: 'workOrder'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent work orders:", error);
                // Don't show error to user, just continue with other data
            }

            // Fetch recent payments
            try {
                const receivablesRef = ref(pageDatabase, `receivables/${pageCurrentUserId}`);
                const recentPaymentsQuery = query(receivablesRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const paymentsSnapshot = await get(recentPaymentsQuery);
                if (paymentsSnapshot.exists()) {
                    paymentsSnapshot.forEach(child => {
                        const payment = child.val();
                        activities.push({ 
                            text: `Payment of $${parseFloat(payment.amount).toLocaleString()} received for ${payment.description || 'rent'}.`, 
                            timestamp: payment.updatedAt || payment.createdAt,
                            type: 'payment'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent payments:", error);
                // Don't show error to user, just continue with other data
            }
            
            // Sort activities by timestamp (descending) and take top 4
            activities.sort((a, b) => b.timestamp - a.timestamp);
            const displayedActivities = activities.slice(0, 4);

            if (displayedActivities.length > 0) {
                displayedActivities.forEach(activity => {
                    const li = document.createElement('li');
                    li.textContent = activity.text;
                    li.classList.add('activity-link');
                    li.setAttribute('tabindex', '0');
                    li.dataset.type = activity.type;
                    li.addEventListener('click', () => handleActivityClick(activity.type));
                    li.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleActivityClick(activity.type); });
                    DOMElements.activityList.appendChild(li);
                });
            } else {
                DOMElements.activityList.innerHTML = '<li>No recent activity to display. Some data may be unavailable due to permissions.</li>';
            }
        }

        function handleActivityClick(type) {
            if (type === 'lease') {
                window.location.href = 'platform_leasing.html';
            } else if (type === 'workOrder') {
                window.location.href = 'platform_maintenance.html';
            } else if (type === 'payment') {
                window.location.href = 'platform_accounting.html';
            }
        }

        function setupActivityModal() {
            const openBtn = document.getElementById('viewAllActivityBtn');
            const modal = document.getElementById('activityModal');
            const closeBtn = modal.querySelector('.close-btn');
            const activityModalList = document.getElementById('activityModalList');

            openBtn.addEventListener('click', () => {
                modal.style.display = 'flex';
                loadAllActivityForModal();
            });
            closeBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        async function loadAllActivityForModal() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const activityModalList = document.getElementById('activityModalList');
            activityModalList.innerHTML = '';
            const activities = [];
            const maxActivitiesPerType = 10;
            try {
                // Leases
                const leasesRef = ref(pageDatabase, `leases/${pageCurrentUserId}`);
                const recentLeasesQuery = query(leasesRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const leaseSnapshot = await get(recentLeasesQuery);
                if (leaseSnapshot.exists()) {
                    leaseSnapshot.forEach(child => {
                        const lease = child.val();
                        const propertyName = lease.propertyId ? `Property ID ${lease.propertyId.substring(0,6)}...` : 'a property';
                        activities.push({ 
                            text: `New lease started for ${propertyName} with ${lease.tenants || 'tenant(s)'}.`, 
                            timestamp: lease.updatedAt || lease.createdAt,
                            type: 'lease'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent leases:", error);
            }
            
            try {
                // Work Orders
                const workOrdersRef = ref(pageDatabase, `workOrders/${pageCurrentUserId}`);
                const recentWoQuery = query(workOrdersRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const woSnapshot = await get(recentWoQuery);
                if (woSnapshot.exists()) {
                    woSnapshot.forEach(child => {
                        const wo = child.val();
                        const propertyName = wo.propertyId ? `Property ID ${wo.propertyId.substring(0,6)}...` : 'a property';
                        activities.push({ 
                            text: `Work order '${wo.title || 'Untitled'}' for ${propertyName} was updated to status: ${wo.status}.`, 
                            timestamp: wo.updatedAt || wo.createdAt,
                            type: 'workOrder'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent work orders:", error);
            }
            
            try {
                // Payments
                const receivablesRef = ref(pageDatabase, `receivables/${pageCurrentUserId}`);
                const recentPaymentsQuery = query(receivablesRef, orderByChild('updatedAt'), limitToLast(maxActivitiesPerType));
                const paymentsSnapshot = await get(recentPaymentsQuery);
                if (paymentsSnapshot.exists()) {
                    paymentsSnapshot.forEach(child => {
                        const payment = child.val();
                        activities.push({ 
                            text: `Payment of $${parseFloat(payment.amount).toLocaleString()} received for ${payment.description || 'rent'}.`, 
                            timestamp: payment.updatedAt || payment.createdAt,
                            type: 'payment'
                        });
                    });
                }
            } catch (error) { 
                console.warn("Could not fetch recent payments:", error);
            }
            
            // Sort and display
            activities.sort((a, b) => b.timestamp - a.timestamp);
            if (activities.length > 0) {
                activities.forEach(activity => {
                    const li = document.createElement('li');
                    li.textContent = activity.text;
                    li.classList.add('activity-link');
                    li.setAttribute('tabindex', '0');
                    li.dataset.type = activity.type;
                    li.addEventListener('click', () => handleActivityClick(activity.type));
                    li.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleActivityClick(activity.type); });
                    activityModalList.appendChild(li);
                });
            } else {
                activityModalList.innerHTML = '<li>No recent activity to display. Some data may be unavailable due to permissions.</li>';
            }
        }

        initializeAuth(pageInit);
    </script>
</body>
</html>