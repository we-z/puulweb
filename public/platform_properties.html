<!DOCTYPE html>
<html lang="en" class="js-loading">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="/js/fouc-prevention.js"></script>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div class="content-scroll-wrapper">
            <div id="propertiesView">
                <div class="content-header">
                    <h2>Properties</h2>
                </div>
                <div class="page-container">
                    <button class="controls-toggle-btn" id="controlsToggleBtnProperties">
                        <span>Filters & Sort</span>
                        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="controls-container visible-by-default">
                        <div class="filter-group">
                            <label for="customFilterPropertyType">Type:</label>
                            <div class="custom-dropdown" id="customFilterPropertyType">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Types</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="">All Types</div>
                                    <div class="dropdown-option" data-value="Single Family Home">Single Family Home</div>
                                    <div class="dropdown-option" data-value="Apartment Unit">Apartment Unit</div>
                                    <div class="dropdown-option" data-value="Multi-Family Building">Multi-Family Building</div>
                                    <div class="dropdown-option" data-value="Condominium">Condominium</div>
                                    <div class="dropdown-option" data-value="Townhouse">Townhouse</div>
                                    <div class="dropdown-option" data-value="Commercial Storefront">Commercial Storefront</div>
                                    <div class="dropdown-option" data-value="Office Space">Office Space</div>
                                    <div class="dropdown-option" data-value="Industrial Warehouse">Industrial Warehouse</div>
                                    <div class="dropdown-option" data-value="Vacant Land">Vacant Land</div>
                                    <div class="dropdown-option" data-value="Other">Other</div>
                                </div>
                            </div>
                        </div>
                        <div class="sort-group">
                            <label for="customSortPropertiesBy">Sort by:</label>
                            <div class="custom-dropdown" id="customSortPropertiesBy">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Address</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="address">Address</div>
                                    <div class="dropdown-option" data-value="type">Type</div>
                                </div>
                            </div>
                            <div class="custom-dropdown" id="customSortPropertiesOrder">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Ascending</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="asc">Ascending</div>
                                    <div class="dropdown-option" data-value="desc">Descending</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container properties-table-container">
                        <table class="data-table" id="propertiesTable">
                            <thead>
                                <tr>
                                    <th>Address</th>
                                    <th>Type</th>
                                    <th>Last Paid Period</th>
                                    <th>Work Orders (Open/Total)</th>
                                    <th>Applications</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="propertiesTableBody">
                            </tbody>
                        </table>
                        <div id="noPropertiesMessage" class="no-data-message" style="display: none;">
                            <div class="icon">üè†</div>
                            <p>No properties added yet.</p>
                            <span>Click the '+' button to add your first one!</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="fab" id="addItemBtn" aria-label="Add new property">
            +
        </button>
    </div>

    <div id="ai-agent-container"></div>

    <!-- Modal for Adding/Editing Properties -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="propertyModalTitle">Add New Property</h3>
                <button class="close-btn" data-modal-id="propertyModal">&times;</button>
            </div>
            <form id="propertyForm">
                <input type="hidden" id="propertyIdInput" name="propertyId">
                <div class="form-group">
                    <label for="propertyAddress">Full Address</label>
                    <input type="text" id="propertyAddress" name="address" required placeholder="e.g., 123 Main St, Anytown, ST 12345">
                </div>
                <div class="form-group">
                    <label for="propertyType">Type</label>
                    <select id="propertyType" name="type">
                        <option value="Single Family Home">Single Family Home</option>
                        <option value="Apartment Unit">Apartment Unit</option>
                        <option value="Multi-Family Building">Multi-Family Building</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Commercial Storefront">Commercial Storefront</option>
                        <option value="Office Space">Office Space</option>
                        <option value="Industrial Warehouse">Industrial Warehouse</option>
                        <option value="Vacant Land">Vacant Land</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="propertySubType">Sub-Type / Name (Optional)</label>
                    <input type="text" id="propertySubType" name="propertySubType" placeholder="e.g., Detached, Park Place Apartments">
                </div>
                <div class="form-group">
                    <label for="numberOfUnits">Number of Units (if applicable)</label>
                    <input type="number" id="numberOfUnits" name="numberOfUnits" min="1" step="1" placeholder="e.g., 1 for SFH, 10 for building">
                </div>
                <div class="form-group">
                    <label for="yearBuilt">Year Built</label>
                    <input type="number" id="yearBuilt" name="yearBuilt" min="1800" max="2099" step="1" placeholder="e.g., 1995">
                </div>
                <div class="form-group">
                    <label for="squareFootage">Square Footage</label>
                    <input type="number" id="squareFootage" name="squareFootage" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="bedrooms">Bedrooms</label>
                    <input type="number" id="bedrooms" name="bedrooms" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="bathrooms">Bathrooms</label>
                    <input type="number" id="bathrooms" name="bathrooms" min="0" step="0.5">
                </div>
                <div class="form-group">
                    <label for="parkingSpots">Parking Spots</label>
                    <input type="number" id="parkingSpots" name="parkingSpots" min="0" step="1">
                </div>
                <div class="form-group">
                    <label for="amenities">Amenities (comma-separated)</label>
                    <textarea id="amenities" name="amenities" rows="2" placeholder="e.g., Pool, Gym, In-unit Laundry"></textarea>
                </div>
                <div class="form-group">
                    <label for="purchasePrice">Purchase Price ($)</label>
                    <input type="number" id="purchasePrice" name="purchasePrice" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="purchaseDate">Purchase Date</label>
                    <input type="date" id="purchaseDate" name="purchaseDate">
                </div>
                <div class="form-group">
                    <label for="marketValue">Estimated Market Value ($)</label>
                    <input type="number" id="marketValue" name="marketValue" min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label for="propertyNotes">Notes (Optional)</label>
                    <textarea id="propertyNotes" name="notes" rows="3" placeholder="e.g., Access codes, specific details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" data-modal-id="propertyModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Custom Alert Toast Structure -->
    <div id="customAlertModal">
        <div class="custom-alert">
            <p>This is an alert message.</p>
        </div>
    </div>

    <!-- Applications Modal -->
    <div id="applicationsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="applicationsModalTitle">Property Applications</h3>
                <button class="close-btn" data-modal-id="applicationsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="applications-header">
                    <div class="application-link-section">
                        <h4>Application Link</h4>
                        <p>Share this unique link with potential tenants:</p>
                        <div class="link-container">
                            <input type="text" id="applicationLink" readonly>
                            <button class="copy-btn" id="copyLinkBtn">Copy</button>
                        </div>
                    </div>
                    <div class="applications-list">
                        <h4>Submitted Applications</h4>
                        <div id="applicationsList">
                            <div class="no-applications">No applications submitted yet.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div id="applicationDetailsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="applicationDetailsTitle">Application Details</h3>
                <button class="close-btn" data-modal-id="applicationDetailsModal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="applicationDetailsContent">
                    <!-- Application details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Common Confirm Modal -->
    <div id="customConfirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="customConfirmTitle">Confirm Action</h3>
                 <button class="close-btn" data-modal-id="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button>
                <button class="confirm-btn" id="customConfirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        console.log('[platform_properties.html] Script module started.');

        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData, initializeSimpleDropdown } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Page-specific DOM Elements
        const pageDOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            propertyModal: document.getElementById('propertyModal'),
            propertyModalTitle: document.getElementById('propertyModalTitle'),
            propertyForm: document.getElementById('propertyForm'),
            propertyIdInput: document.getElementById('propertyIdInput'),
            propertyAddress: document.getElementById('propertyAddress'),
            propertyType: document.getElementById('propertyType'),
            propertySubType: document.getElementById('propertySubType'),
            numberOfUnits: document.getElementById('numberOfUnits'),
            yearBuilt: document.getElementById('yearBuilt'),
            squareFootage: document.getElementById('squareFootage'),
            bedrooms: document.getElementById('bedrooms'),
            bathrooms: document.getElementById('bathrooms'),
            parkingSpots: document.getElementById('parkingSpots'),
            amenities: document.getElementById('amenities'),
            purchasePrice: document.getElementById('purchasePrice'),
            purchaseDate: document.getElementById('purchaseDate'),
            marketValue: document.getElementById('marketValue'),
            propertyNotes: document.getElementById('propertyNotes'),
            propertiesTableBody: document.getElementById('propertiesTableBody'),
            noPropertiesMessage: document.getElementById('noPropertiesMessage'),
            filterPropertyType: document.getElementById('customFilterPropertyType'),
            sortPropertiesBy: document.getElementById('customSortPropertiesBy'),
            sortPropertiesOrder: document.getElementById('customSortPropertiesOrder'),
            controlsToggleBtn: document.getElementById('controlsToggleBtnProperties'),
            controlsContainer: document.querySelector('#propertiesView .controls-container')
        };

        let pageCurrentUserId;
        let pageDatabase;
        let commonDependencies = {}; // To store common functions and icons
        let propertiesData = []; // Data cache for properties
        let receivablesData = []; // Data cache for receivables

        function pageInit(userId, db, fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon) {
            pageCurrentUserId = userId;
            pageDatabase = db;
            
            commonDependencies = {
                fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, 
                fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, 
                commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon,
                initializeSimpleDropdown
            };

            loadProperties();
            loadReceivables();

            // Initialize custom dropdowns for properties page
            const propertiesCommonOnChange = () => renderProperties();
            initializeSimpleDropdown(pageDOMElements.filterPropertyType, propertiesCommonOnChange);
            initializeSimpleDropdown(pageDOMElements.sortPropertiesBy, propertiesCommonOnChange);
            initializeSimpleDropdown(pageDOMElements.sortPropertiesOrder, propertiesCommonOnChange);

            // Initialize controls toggle button for Properties page
            if (pageDOMElements.controlsToggleBtn && pageDOMElements.controlsContainer) {
                pageDOMElements.controlsToggleBtn.addEventListener('click', () => {
                    const isExpanded = pageDOMElements.controlsContainer.style.display === 'flex';
                    pageDOMElements.controlsContainer.style.display = isExpanded ? 'none' : 'flex';
                    const arrowIcon = pageDOMElements.controlsToggleBtn.querySelector('.arrow-icon');
                    if(arrowIcon) arrowIcon.style.transform = isExpanded ? 'rotate(-90deg)' : 'rotate(0deg)';
                });
                
                const isVisibleByDefault = pageDOMElements.controlsContainer.classList.contains('visible-by-default');
                 if (isVisibleByDefault && window.innerWidth > 768) {
                    pageDOMElements.controlsContainer.style.display = 'flex';
                    const arrowIcon = pageDOMElements.controlsToggleBtn.querySelector('.arrow-icon');
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(0deg)';
                } else {
                    pageDOMElements.controlsContainer.style.display = 'none';
                    const arrowIcon = pageDOMElements.controlsToggleBtn.querySelector('.arrow-icon');
                    if(arrowIcon) arrowIcon.style.transform = 'rotate(-90deg)';
                }
            }

            if (pageDOMElements.addItemBtn) {
                pageDOMElements.addItemBtn.addEventListener('click', () => {
                    openPropertyModal(); // Open for new property
                });
            }

            if (pageDOMElements.propertyForm) {
                pageDOMElements.propertyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!pageCurrentUserId) {
                        commonDependencies.commonShowAlert('User not authenticated. Please sign in again.', 'Authentication Error');
                        return;
                    }
                    const address = pageDOMElements.propertyAddress.value.trim();
                    const type = pageDOMElements.propertyType.value;
                    const subType = pageDOMElements.propertySubType.value.trim();
                    const numberOfUnits = pageDOMElements.numberOfUnits.value;
                    const year = pageDOMElements.yearBuilt.value;
                    const squareFootage = pageDOMElements.squareFootage.value;
                    const bedrooms = pageDOMElements.bedrooms.value;
                    const bathrooms = pageDOMElements.bathrooms.value;
                    const parkingSpots = pageDOMElements.parkingSpots.value;
                    const amenities = pageDOMElements.amenities.value.trim();
                    const purchasePrice = pageDOMElements.purchasePrice.value;
                    const purchaseDate = pageDOMElements.purchaseDate.value;
                    const marketValue = pageDOMElements.marketValue.value;
                    const notes = pageDOMElements.propertyNotes.value.trim();
                    const propertyId = pageDOMElements.propertyIdInput.value;

                    if (!address) {
                        commonDependencies.commonShowAlert('Address is required for properties.', 'Validation Error');
                        return;
                    }

                    const propertyData = {
                        address,
                        type,
                        propertySubType: subType,
                        numberOfUnits: numberOfUnits ? parseInt(numberOfUnits) : null,
                        yearBuilt: year ? parseInt(year) : null,
                        squareFootage: squareFootage ? parseFloat(squareFootage) : null,
                        bedrooms: bedrooms ? parseInt(bedrooms) : null,
                        bathrooms: bathrooms ? parseFloat(bathrooms) : null,
                        parkingSpots: parkingSpots ? parseInt(parkingSpots) : null,
                        amenities,
                        purchasePrice: purchasePrice ? parseFloat(purchasePrice) : null,
                        purchaseDate: purchaseDate || null,
                        marketValue: marketValue ? parseFloat(marketValue) : null,
                        notes,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };

                    try {
                        if (propertyId) {
                            const propertyRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${propertyId}`);
                            const snapshot = await commonDependencies.fbGetDbData(propertyRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(propertyRef, {...existingData, ...propertyData, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Property updated successfully!');
                        } else {
                            propertyData.createdAt = commonDependencies.fbServerTimestamp();
                            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
                            await commonDependencies.fbPush(propertiesRef, propertyData);
                            commonDependencies.commonShowAlert('Property added successfully!');
                        }
                        if(pageDOMElements.propertyModal) pageDOMElements.propertyModal.style.display = 'none';
                    } catch (error) {
                        console.error('Error saving property:', error);
                        commonDependencies.commonShowAlert(`Error saving property: ${error.message}`, 'Save Error');
                    }
                });
            }
        }

        function loadReceivables() {
            if (!pageCurrentUserId || !pageDatabase) return;

            const receivablesRef = commonDependencies.fbRef(pageDatabase, `receivables/${pageCurrentUserId}`);
            
            onValue(receivablesRef, (snapshot) => {
                receivablesData = [];
                snapshot.forEach(childSnapshot => {
                    receivablesData.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderProperties();
            }, { onlyOnce: false });
        }

        function loadProperties() {
            if (!pageCurrentUserId || !pageDatabase || !pageDOMElements.propertiesTableBody) return;

            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            
            onValue(propertiesRef, (snapshot) => {
                propertiesData = [];
                snapshot.forEach(childSnapshot => {
                    propertiesData.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderProperties();
            }, { onlyOnce: false }); // Listen for real-time updates
        }

        function renderProperties() {
            if (!pageDOMElements.propertiesTableBody) return;
            pageDOMElements.propertiesTableBody.innerHTML = '';
            
            let filteredProperties = [...propertiesData];

            // Apply filters
            const filterType = pageDOMElements.filterPropertyType.dataset.value;
            if (filterType) {
                filteredProperties = filteredProperties.filter(p => p.type === filterType);
            }

            // Apply sorting
            const sortBy = pageDOMElements.sortPropertiesBy.dataset.value || 'address';
            const sortOrder = pageDOMElements.sortPropertiesOrder.dataset.value || 'asc';
            
            filteredProperties.sort((a, b) => {
                let valA = a[sortBy] ? a[sortBy].toString().toLowerCase() : '';
                let valB = b[sortBy] ? b[sortBy].toString().toLowerCase() : '';
                let comparison = 0;
                if (valA > valB) comparison = 1;
                else if (valA < valB) comparison = -1;
                return sortOrder === 'desc' ? comparison * -1 : comparison;
            });

            const lastPaidMap = {};
            if (receivablesData && receivablesData.length > 0) {
                receivablesData
                    .filter(r => r.status === 'Paid' && r.propertyId && r.date)
                    .forEach(r => {
                        if (!lastPaidMap[r.propertyId] || new Date(r.date) > new Date(lastPaidMap[r.propertyId])) {
                            lastPaidMap[r.propertyId] = r.date;
                        }
                    });
            }

            if (filteredProperties.length === 0) {
                pageDOMElements.noPropertiesMessage.style.display = 'flex';
            } else {
                pageDOMElements.noPropertiesMessage.style.display = 'none';
                filteredProperties.forEach(prop => {
                    const lastPaidDate = lastPaidMap[prop.id];
                    populatePropertyRow(prop, lastPaidDate);
                });
            }
        }

        function populatePropertyRow(data, lastPaidDate) {
            if (!pageDOMElements.propertiesTableBody) return;
            const row = pageDOMElements.propertiesTableBody.insertRow();
            row.insertCell().textContent = data.address || 'N/A';
            row.insertCell().textContent = data.type || 'N/A';
            row.insertCell().textContent = lastPaidDate ? new Date(lastPaidDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = 'N/A'; // Placeholder for Work Orders (Open/Total)
            
            // Applications column
            const applicationsCell = row.insertCell();
            applicationsCell.className = 'applications-cell';
            applicationsCell.innerHTML = `
                <button class="applications-btn-primary" data-property-id="${data.id}" data-property-data='${JSON.stringify(data).replace(/'/g, "&apos;")}'>
                    <span class="btn-text">Applications</span>
                </button>`;
            
            // Add event listener to applications button
            applicationsCell.querySelector('.applications-btn-primary').addEventListener('click', (e) => {
                e.stopPropagation();
                openApplicationsModal(data.id, data);
            });
            
            const actionsCell = row.insertCell();
            actionsCell.className = 'actions-cell';
            actionsCell.innerHTML = `
                <button class="edit-btn" title="Edit">
                    <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z"></path>
                        <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button class="delete-btn" title="Delete">
                    <svg class="icon" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>`;
            
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                openPropertyModal(data.id, data); 
            });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { 
                e.stopPropagation(); 
                handleDeleteProperty(data.id, data.address);
            });
            row.addEventListener('click', () => openPropertyModal(data.id, data));
        }

        async function handleDeleteProperty(propertyId, propertyAddress) {
            if (!pageCurrentUserId || !pageDatabase || !propertyId) return;
            const confirmed = await commonDependencies.commonShowConfirm(
                `Are you sure you want to delete the property: ${propertyAddress || 'this property'}? This action cannot be undone.`, 
                'Delete Property'
            );
            if (confirmed) {
                try {
                    const propertyRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${propertyId}`);
                    await commonDependencies.fbRemove(propertyRef);
                    commonDependencies.commonShowAlert('Property deleted successfully!');
                    // loadProperties(); // Data will be reloaded by onValue listener
                } catch (error) {
                    console.error('Error deleting property:', error);
                    commonDependencies.commonShowAlert(`Error: ${error.message}`, 'Delete Error');
                }
            }
        }

        // Modified to handle populating all new fields
        function openPropertyModal(id = null, data = {}) {
            if (!pageDOMElements.propertyForm || !pageDOMElements.propertyModal) return;
            pageDOMElements.propertyForm.reset();
            pageDOMElements.propertyModalTitle.textContent = id ? 'Edit Property' : 'Add New Property';
            
            pageDOMElements.propertyIdInput.value = id || '';
            pageDOMElements.propertyAddress.value = data.address || '';
            pageDOMElements.propertyType.value = data.type || 'Single Family Home';
            pageDOMElements.propertySubType.value = data.propertySubType || '';
            pageDOMElements.numberOfUnits.value = data.numberOfUnits || '';
            pageDOMElements.yearBuilt.value = data.yearBuilt || '';
            pageDOMElements.squareFootage.value = data.squareFootage || '';
            pageDOMElements.bedrooms.value = data.bedrooms || '';
            pageDOMElements.bathrooms.value = data.bathrooms || '';
            pageDOMElements.parkingSpots.value = data.parkingSpots || '';
            pageDOMElements.amenities.value = data.amenities || '';
            pageDOMElements.purchasePrice.value = data.purchasePrice || '';
            pageDOMElements.purchaseDate.value = data.purchaseDate || '';
            pageDOMElements.marketValue.value = data.marketValue || '';
            pageDOMElements.propertyNotes.value = data.notes || '';
            
            pageDOMElements.propertyModal.style.display = 'flex';
        }

        // Applications functionality
        let currentPropertyId = null;
        let applicationsData = [];



        function openApplicationsModal(propertyId, propertyData) {
            currentPropertyId = propertyId;
            const applicationsModal = document.getElementById('applicationsModal');
            const applicationsModalTitle = document.getElementById('applicationsModalTitle');
            const applicationLink = document.getElementById('applicationLink');
            
            applicationsModalTitle.textContent = `Applications - ${propertyData.address}`;
            
            // Generate unique application link
            const baseUrl = window.location.origin;
            const applicationUrl = `${baseUrl}/application.html?propertyId=${propertyId}&userId=${pageCurrentUserId}&applicationId=${generateUniqueId()}`;
            applicationLink.value = applicationUrl;
            
            applicationsModal.style.display = 'flex';
            loadApplications(propertyId);
        }

        function generateUniqueId() {
            return 'app_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function loadApplications(propertyId) {
            if (!pageCurrentUserId || !pageDatabase) return;

            const applicationsRef = commonDependencies.fbRef(pageDatabase, `applications/${pageCurrentUserId}/${propertyId}`);
            
            onValue(applicationsRef, (snapshot) => {
                applicationsData = [];
                snapshot.forEach(childSnapshot => {
                    applicationsData.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                renderApplications();
            }, { onlyOnce: false });
        }

        function renderApplications() {
            const applicationsList = document.getElementById('applicationsList');
            if (!applicationsList) return;

            if (applicationsData.length === 0) {
                applicationsList.innerHTML = '<div class="no-applications">No applications submitted yet.</div>';
                return;
            }

            applicationsList.innerHTML = applicationsData.map(app => `
                <div class="application-item" data-application-id="${app.id}">
                    <div class="application-header">
                        <div class="applicant-name">${app.firstName} ${app.lastName}</div>
                        <div class="application-date">${app.submittedAt ? new Date(app.submittedAt).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div class="application-details">
                        <div class="detail-item">
                            <span class="label">Email:</span>
                            <span class="value">${app.email || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Phone:</span>
                            <span class="value">${app.phone || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Monthly Income:</span>
                            <span class="value">${app.monthlyIncome ? `$${parseFloat(app.monthlyIncome).toLocaleString()}` : 'N/A'}</span>
                        </div>
                    </div>
                    <div class="application-actions">
                        <button class="view-btn" onclick="viewApplicationDetails('${app.id}')">View Details</button>
                    </div>
                </div>
            `).join('');
        }

        // Global function for viewing application details
        window.viewApplicationDetails = function(applicationId) {
            const application = applicationsData.find(app => app.id === applicationId);
            if (!application) return;

            const detailsModal = document.getElementById('applicationDetailsModal');
            const detailsTitle = document.getElementById('applicationDetailsTitle');
            const detailsContent = document.getElementById('applicationDetailsContent');

            detailsTitle.textContent = `Application - ${application.firstName} ${application.lastName}`;

            detailsContent.innerHTML = `
                <div class="application-details-full">
                    <div class="detail-section">
                        <h4>Personal Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Name:</span>
                                <span class="value">${application.firstName} ${application.lastName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Email:</span>
                                <span class="value">${application.email}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Phone:</span>
                                <span class="value">${application.phone}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Date of Birth:</span>
                                <span class="value">${application.dateOfBirth}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">SSN:</span>
                                <span class="value">${application.ssn}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Current Address:</span>
                                <span class="value">${application.currentAddress}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Employment Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Employer:</span>
                                <span class="value">${application.employerName}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Job Title:</span>
                                <span class="value">${application.jobTitle}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Employer Phone:</span>
                                <span class="value">${application.employerPhone}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Monthly Income:</span>
                                <span class="value">$${parseFloat(application.monthlyIncome).toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Employer Address:</span>
                                <span class="value">${application.employerAddress || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Previous Landlord</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Landlord Name:</span>
                                <span class="value">${application.previousLandlordName || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Landlord Phone:</span>
                                <span class="value">${application.previousLandlordPhone || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Previous Address:</span>
                                <span class="value">${application.previousAddress || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Reason for Leaving:</span>
                                <span class="value">${application.reasonForLeaving || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>References</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Reference 1:</span>
                                <span class="value">${application.reference1Name || 'N/A'} - ${application.reference1Phone || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Reference 2:</span>
                                <span class="value">${application.reference2Name || 'N/A'} - ${application.reference2Phone || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Additional Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Number of Occupants:</span>
                                <span class="value">${application.numberOfOccupants}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Move-in Date:</span>
                                <span class="value">${application.moveInDate}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Lease Term:</span>
                                <span class="value">${application.leaseTerm || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Emergency Contact:</span>
                                <span class="value">${application.emergencyContact || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Additional Notes:</span>
                                <span class="value">${application.additionalNotes || 'N/A'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Lifestyle Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Smoking:</span>
                                <span class="value">${application.smoking ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Pets:</span>
                                <span class="value">${application.pets ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Pet Details:</span>
                                <span class="value">${application.petDetails || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Waterbed:</span>
                                <span class="value">${application.waterbed ? 'Yes' : 'No'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Aquarium:</span>
                                <span class="value">${application.aquarium ? 'Yes' : 'No'}</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Vehicle Information</h4>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="label">Vehicle:</span>
                                <span class="value">${application.vehicleYear || ''} ${application.vehicleMake || ''} ${application.vehicleModel || ''}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">Color:</span>
                                <span class="value">${application.vehicleColor || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">License Plate:</span>
                                <span class="value">${application.licensePlate || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="label">State:</span>
                                <span class="value">${application.vehicleState || 'N/A'}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            detailsModal.style.display = 'flex';
        }

        // Copy link functionality
        document.addEventListener('DOMContentLoaded', function() {
            const copyLinkBtn = document.getElementById('copyLinkBtn');
            if (copyLinkBtn) {
                copyLinkBtn.addEventListener('click', function() {
                    const applicationLink = document.getElementById('applicationLink');
                    applicationLink.select();
                    applicationLink.setSelectionRange(0, 99999);
                    document.execCommand('copy');
                    commonDependencies.commonShowAlert('Application link copied to clipboard!');
                });
            }
        });

        initializeAuth(pageInit);
    </script>
</body>
</html>