<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="propertiesView">
            <div class="content-header">
                <h2>Properties</h2>
            </div>
            <div class="page-container">
                <div class="data-table-container properties-table-container">
                    <table class="data-table" id="propertiesTable">
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>Type</th>
                                <th>Work Orders (Open/Total)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody">
                        </tbody>
                    </table>
                    <div id="noPropertiesMessage" class="no-data-message" style="display: none;">
                        <div class="icon">üè†</div>
                        <p>No properties added yet.</p>
                        <span>Click the '+' button to add your first one!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="addItemBtn" aria-label="Add new property">
        +
    </button>

    <!-- Modal for Adding/Editing Properties -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="propertyModalTitle">Add New Property</h3>
                <button class="close-btn" data-modal-id="propertyModal">&times;</button>
            </div>
            <form id="propertyForm">
                <input type="hidden" id="propertyIdInput" name="propertyId">
                <div class="form-group">
                    <label for="propertyAddress">Address</label>
                    <input type="text" id="propertyAddress" name="address" required placeholder="e.g., 123 Main St, Anytown, USA">
                </div>
                <div class="form-group">
                    <label for="propertyType">Type</label>
                    <select id="propertyType" name="type">
                        <option value="Single Family Home">Single Family Home</option>
                        <option value="Apartment Unit">Apartment Unit</option>
                        <option value="Multi-Family Building">Multi-Family Building</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Commercial Storefront">Commercial Storefront</option>
                        <option value="Office Space">Office Space</option>
                        <option value="Industrial Warehouse">Industrial Warehouse</option>
                        <option value="Vacant Land">Vacant Land</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="propertyNotes">Notes (Optional)</label>
                    <textarea id="propertyNotes" name="notes" rows="3" placeholder="e.g., Number of units, specific details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" data-modal-id="propertyModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Common Alert and Confirm Modals -->
    <div id="customAlertModal" class="modal">
        <div class="modal-content alert-modal-content">
            <div class="modal-header">
                <h3 id="customAlertTitle">Notification</h3>
                <button class="close-btn" data-modal-id="customAlertModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customAlertMessage">This is an alert message.</p>
            </div>
            <div class="modal-footer">
                <button class="ok-btn" data-modal-id="customAlertModal">OK</button>
            </div>
        </div>
    </div>
    <div id="customConfirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="customConfirmTitle">Confirm Action</h3>
                 <button class="close-btn" data-modal-id="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button>
                <button class="confirm-btn" id="customConfirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Page-specific DOM Elements
        const pageDOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            propertyModal: document.getElementById('propertyModal'),
            propertyModalTitle: document.getElementById('propertyModalTitle'),
            propertyForm: document.getElementById('propertyForm'),
            propertyIdInput: document.getElementById('propertyIdInput'),
            propertyAddress: document.getElementById('propertyAddress'),
            propertyType: document.getElementById('propertyType'),
            propertyNotes: document.getElementById('propertyNotes'),
            propertiesTableBody: document.getElementById('propertiesTableBody'),
            noPropertiesMessage: document.getElementById('noPropertiesMessage')
        };

        let pageCurrentUserId;
        let pageDatabase;
        let commonDependencies = {}; // To store common functions and icons

        function pageInit(userId, db, fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon) {
            pageCurrentUserId = userId;
            pageDatabase = db;
            
            commonDependencies = {
                fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, 
                fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, 
                commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon
            };

            loadProperties();

            if (pageDOMElements.addItemBtn) {
                pageDOMElements.addItemBtn.addEventListener('click', () => {
                    openPropertyModal(); // Open for new property
                });
            }

            if (pageDOMElements.propertyForm) {
                pageDOMElements.propertyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!pageCurrentUserId) {
                        commonDependencies.commonShowAlert('User not authenticated. Please sign in again.', 'Authentication Error');
                        return;
                    }
                    const address = pageDOMElements.propertyAddress.value.trim();
                    const type = pageDOMElements.propertyType.value;
                    const notes = pageDOMElements.propertyNotes.value.trim();
                    const propertyId = pageDOMElements.propertyIdInput.value;

                    if (!address) {
                        commonDependencies.commonShowAlert('Address is required for properties.', 'Validation Error');
                        return;
                    }

                    const propertyData = {
                        address,
                        type,
                        notes,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };

                    try {
                        if (propertyId) {
                            const propertyRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${propertyId}`);
                            const snapshot = await commonDependencies.fbGetDbData(propertyRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(propertyRef, {...existingData, ...propertyData, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Property updated successfully!');
                        } else {
                            propertyData.createdAt = commonDependencies.fbServerTimestamp();
                            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
                            await commonDependencies.fbPush(propertiesRef, propertyData);
                            commonDependencies.commonShowAlert('Property added successfully!');
                        }
                        if(pageDOMElements.propertyModal) pageDOMElements.propertyModal.style.display = 'none';
                    } catch (error) {
                        console.error('Error saving property:', error);
                        commonDependencies.commonShowAlert(`Error saving property: ${error.message}`, 'Save Error');
                    }
                });
            }
        }

        function loadProperties() {
            if (!pageCurrentUserId || !pageDatabase) {
                console.log("PropertiesPage: loadProperties - Aborted, no user or DB.");
                return;
            }
            console.log(`PropertiesPage: loadProperties - Initializing for user ${pageCurrentUserId}`);

            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);

            onValue(commonDependencies.fbQuery(propertiesRef, commonDependencies.fbOrderByChild('address')), async (propSnapshot) => {
                console.log("PropertiesPage: onValue triggered for propertiesRef.");
                const tableBody = pageDOMElements.propertiesTableBody; 
                const noMessage = pageDOMElements.noPropertiesMessage; 
                
                if (!tableBody || !noMessage) {
                    console.error("PropertiesPage: Table body or no message element not found in DOM.");
                    return;
                }
                tableBody.innerHTML = '';

                if (propSnapshot.exists()) {
                    console.log("PropertiesPage: propSnapshot EXISTS. Data:", propSnapshot.val());
                    noMessage.style.display = 'none';
                    let propertyPromises = [];
                    const propertiesData = propSnapshot.val(); 

                    const sortedPropertyKeys = Object.keys(propertiesData).sort((a,b) => {
                        const propA = propertiesData[a];
                        const propB = propertiesData[b];
                        return (propA.address || '').localeCompare(propB.address || '');
                    });

                    for (const key of sortedPropertyKeys) {
                        const prop = propertiesData[key];
                        console.log(`PropertiesPage: Processing property key: ${key}`, prop);
                        
                        if (!prop || !prop.address) {
                            console.warn(`PropertiesPage: Skipping property key: ${key} due to missing data or address.`, prop);
                            continue; 
                        }

                        const workOrderCountPromise = commonDependencies.fbGetDbData(commonDependencies.fbQuery(workOrdersRef, commonDependencies.fbOrderByChild('propertyId'), commonDependencies.fbEqualTo(key)))
                            .then(woSnapshot => {
                                let openCount = 0;
                                let totalCount = 0;
                                if(woSnapshot.exists()){
                                    console.log(`PropertiesPage: Work orders found for property ${key}:`, woSnapshot.val());
                                    woSnapshot.forEach(woChild => {
                                        totalCount++;
                                        if(woChild.val() && woChild.val().status === 'Open') openCount++;
                                    });
                                } else {
                                    console.log(`PropertiesPage: No work orders found for property ${key}`);
                                }
                                return { key, prop, openCount, totalCount };
                            }).catch(err => {
                                console.error(`PropertiesPage: Error fetching work order count for property ${key}:`, err);
                                return { key, prop, openCount: 0, totalCount: 0, error: true }; 
                            });
                        propertyPromises.push(workOrderCountPromise);
                    }

                    console.log(`PropertiesPage: Number of property promises created: ${propertyPromises.length}`);

                    if (propertyPromises.length === 0 && Object.keys(propertiesData).length > 0) {
                        console.warn("PropertiesPage: Snapshot has children, but no promises were created. This might indicate all properties were skipped in forEach.");
                    }

                    Promise.all(propertyPromises).then(resolvedProperties => {
                        console.log("PropertiesPage: All property promises resolved. Data:", resolvedProperties);
                        if (resolvedProperties.length === 0 && Object.keys(propertiesData).length > 0 ) { // Check if original snapshot had data but promises are empty
                             console.log("PropertiesPage: No valid properties to render after promises resolved, though initial data existed.");
                             noMessage.style.display = 'block';
                             tableBody.innerHTML = ''; // Ensure table is clear
                             return;
                        } else if (resolvedProperties.length === 0) {
                            console.log("PropertiesPage: No properties to render after promises resolved (initial data was also empty or all filtered).");
                            noMessage.style.display = 'block';
                            tableBody.innerHTML = ''; // Ensure table is clear
                            return;
                        }
                        
                        tableBody.innerHTML = ''; // Clear before adding new rows
                        noMessage.style.display = 'none'; // Hide no message if we have properties to show

                        resolvedProperties.forEach(({ key, prop, openCount, totalCount, error }) => {
                            if (error) {
                                console.warn(`PropertiesPage: Skipping rendering for property key: ${key} due to an error during WO count.`);
                                return;
                            }
                            if (!prop || !prop.address) { 
                                console.warn(`PropertiesPage: Skipping rendering for property key: ${key} due to missing prop or address in resolved data.`);
                                return; 
                            }
                            
                            console.log(`PropertiesPage: Rendering row for property ${key}:`, prop.address);
                            const row = tableBody.insertRow();
                            row.setAttribute('data-id', key);
                            row.insertCell().textContent = prop.address;
                            row.insertCell().textContent = prop.type || 'N/A';
                            row.insertCell().textContent = `${openCount} / ${totalCount}`;
                            const actionsCell = row.insertCell();
                            actionsCell.classList.add('actions-cell');
                            actionsCell.innerHTML = `<button class="edit-btn" title="Edit">${commonDependencies.commonEditIcon}</button><button class="delete-btn" title="Delete">${commonDependencies.commonDeleteIcon}</button>`;
                            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openPropertyModal(key, prop));
                            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteProperty(key)); 
                        });
                    }).catch(err => {
                        console.error("PropertiesPage: Error in Promise.all for properties:", err);
                        noMessage.style.display = 'block'; 
                        tableBody.innerHTML = '';
                    });

                } else {
                    console.log("PropertiesPage: propSnapshot does NOT exist. No properties found for this user.");
                    noMessage.style.display = 'block';
                    tableBody.innerHTML = '';
                }
            });
        }

        function openPropertyModal(id = null, data = {}) {
            if(!pageDOMElements.propertyForm || !pageDOMElements.propertyModal) return;
            pageDOMElements.propertyForm.reset();
            pageDOMElements.propertyIdInput.value = id || '';
            pageDOMElements.propertyModalTitle.textContent = id ? 'Edit Property' : 'Add New Property';
            pageDOMElements.propertyAddress.value = data.address || '';
            pageDOMElements.propertyType.value = data.type || 'Single Family Home';
            pageDOMElements.propertyNotes.value = data.notes || '';
            pageDOMElements.propertyModal.style.display = 'flex';
        }

        async function handleDeleteProperty(id) {
            if (!pageCurrentUserId || !pageDatabase) {
                console.error("handleDeleteProperty: User ID or DB not available");
                return;
            }
            
            const workOrdersQueryRef = commonDependencies.fbQuery(commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`), commonDependencies.fbOrderByChild('propertyId'), commonDependencies.fbEqualTo(id));
            const linkedWorkOrdersSnapshot = await commonDependencies.fbGetDbData(workOrdersQueryRef);
            let confirmMessage = 'Are you sure you want to delete this property?';
            let numLinked = 0;
            if (linkedWorkOrdersSnapshot.exists()) {
                linkedWorkOrdersSnapshot.forEach(() => numLinked++);
                if (numLinked > 0) {
                    confirmMessage = `This property is linked to ${numLinked} work order(s). Deleting it will unlink them. Are you sure you want to delete this property?`;
                }
            }

            const confirmed = await commonDependencies.commonShowConfirm(confirmMessage, 'Delete Property');
            if (confirmed) {
                try {
                    if (numLinked > 0) {
                        const updates = {};
                        linkedWorkOrdersSnapshot.forEach(woSnapshot => {
                            updates[`workOrders/${pageCurrentUserId}/${woSnapshot.key}/propertyId`] = null;
                        });
                        await commonDependencies.fbUpdateDbData(commonDependencies.fbRef(pageDatabase), updates);
                    }
                    
                    const propertyRefToDelete = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${id}`);
                    await commonDependencies.fbRemove(propertyRefToDelete);
                    commonDependencies.commonShowAlert('Property deleted successfully!');
                } catch (error) {
                    console.error('Error deleting property:', error);
                    commonDependencies.commonShowAlert(`Error deleting property: ${error.message}`, 'Delete Error');
                }
            }
        }

        initializeAuth(pageInit);
    </script>
</body>
</html> 