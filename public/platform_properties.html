<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Properties - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="propertiesView">
            <div class="content-header">
                <h2>Properties</h2>
            </div>
            <div class="page-container">
                <button class="controls-toggle-btn" id="controlsToggleBtnProperties">
                    <span>Filters & Sort</span>
                    <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
                <div class="controls-container">
                    <div class="filter-group">
                        <label for="customFilterPropertyType">Type:</label>
                        <div class="custom-dropdown" id="customFilterPropertyType">
                            <div class="dropdown-selected" tabindex="0">
                                <span class="selected-value">All Types</span>
                                <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option selected" data-value="">All Types</div>
                                <div class="dropdown-option" data-value="Single Family Home">Single Family Home</div>
                                <div class="dropdown-option" data-value="Apartment Unit">Apartment Unit</div>
                                <div class="dropdown-option" data-value="Multi-Family Building">Multi-Family Building</div>
                                <div class="dropdown-option" data-value="Condominium">Condominium</div>
                                <div class="dropdown-option" data-value="Townhouse">Townhouse</div>
                                <div class="dropdown-option" data-value="Commercial Storefront">Commercial Storefront</div>
                                <div class="dropdown-option" data-value="Office Space">Office Space</div>
                                <div class="dropdown-option" data-value="Industrial Warehouse">Industrial Warehouse</div>
                                <div class="dropdown-option" data-value="Vacant Land">Vacant Land</div>
                                <div class="dropdown-option" data-value="Other">Other</div>
                            </div>
                        </div>
                    </div>
                    <div class="sort-group">
                        <label for="customSortPropertiesBy">Sort by:</label>
                        <div class="custom-dropdown" id="customSortPropertiesBy">
                            <div class="dropdown-selected" tabindex="0">
                                <span class="selected-value">Address</span>
                                <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option selected" data-value="address">Address</div>
                                <div class="dropdown-option" data-value="type">Type</div>
                            </div>
                        </div>
                        <div class="custom-dropdown" id="customSortPropertiesOrder">
                            <div class="dropdown-selected" tabindex="0">
                                <span class="selected-value">Ascending</span>
                                <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="dropdown-options">
                                <div class="dropdown-option selected" data-value="asc">Ascending</div>
                                <div class="dropdown-option" data-value="desc">Descending</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="data-table-container properties-table-container">
                    <table class="data-table" id="propertiesTable">
                        <thead>
                            <tr>
                                <th>Address</th>
                                <th>Type</th>
                                <th>Work Orders (Open/Total)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTableBody">
                        </tbody>
                    </table>
                    <div id="noPropertiesMessage" class="no-data-message" style="display: none;">
                        <div class="icon">üè†</div>
                        <p>No properties added yet.</p>
                        <span>Click the '+' button to add your first one!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="addItemBtn" aria-label="Add new property">
        +
    </button>

    <!-- Modal for Adding/Editing Properties -->
    <div id="propertyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="propertyModalTitle">Add New Property</h3>
                <button class="close-btn" data-modal-id="propertyModal">&times;</button>
            </div>
            <form id="propertyForm">
                <input type="hidden" id="propertyIdInput" name="propertyId">
                <div class="form-group">
                    <label for="propertyAddress">Address</label>
                    <input type="text" id="propertyAddress" name="address" required placeholder="e.g., 123 Main St, Anytown, USA">
                </div>
                <div class="form-group">
                    <label for="propertyType">Type</label>
                    <select id="propertyType" name="type">
                        <option value="Single Family Home">Single Family Home</option>
                        <option value="Apartment Unit">Apartment Unit</option>
                        <option value="Multi-Family Building">Multi-Family Building</option>
                        <option value="Condominium">Condominium</option>
                        <option value="Townhouse">Townhouse</option>
                        <option value="Commercial Storefront">Commercial Storefront</option>
                        <option value="Office Space">Office Space</option>
                        <option value="Industrial Warehouse">Industrial Warehouse</option>
                        <option value="Vacant Land">Vacant Land</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="propertyNotes">Notes (Optional)</label>
                    <textarea id="propertyNotes" name="notes" rows="3" placeholder="e.g., Number of units, specific details..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" data-modal-id="propertyModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Custom Alert Toast Structure -->
    <div id="customAlertModal">
        <div class="custom-alert">
            <p>This is an alert message.</p>
        </div>
    </div>

    <!-- Common Confirm Modal -->
    <div id="customConfirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="customConfirmTitle">Confirm Action</h3>
                 <button class="close-btn" data-modal-id="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button>
                <button class="confirm-btn" id="customConfirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // Page-specific DOM Elements
        const pageDOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            propertyModal: document.getElementById('propertyModal'),
            propertyModalTitle: document.getElementById('propertyModalTitle'),
            propertyForm: document.getElementById('propertyForm'),
            propertyIdInput: document.getElementById('propertyIdInput'),
            propertyAddress: document.getElementById('propertyAddress'),
            propertyType: document.getElementById('propertyType'),
            propertyNotes: document.getElementById('propertyNotes'),
            propertiesTableBody: document.getElementById('propertiesTableBody'),
            noPropertiesMessage: document.getElementById('noPropertiesMessage'),
            filterPropertyType: document.getElementById('customFilterPropertyType'),
            sortPropertiesBy: document.getElementById('customSortPropertiesBy'),
            sortPropertiesOrder: document.getElementById('customSortPropertiesOrder'),
            controlsToggleBtn: document.getElementById('controlsToggleBtnProperties'),
            controlsContainer: document.querySelector('#propertiesView .controls-container')
        };

        let pageCurrentUserId;
        let pageDatabase;
        let commonDependencies = {}; // To store common functions and icons

        function pageInit(userId, db, fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon) {
            pageCurrentUserId = userId;
            pageDatabase = db;
            
            commonDependencies = {
                fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, 
                fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, 
                commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon
            };

            loadProperties();

            // Initialize custom dropdowns for properties page
            const propertiesCommonOnChange = () => loadProperties();
            initializeCustomDropdown(pageDOMElements.filterPropertyType, propertiesCommonOnChange);
            initializeCustomDropdown(pageDOMElements.sortPropertiesBy, propertiesCommonOnChange);
            initializeCustomDropdown(pageDOMElements.sortPropertiesOrder, propertiesCommonOnChange);

            // Initialize controls toggle button for Properties page
            if (pageDOMElements.controlsToggleBtn && pageDOMElements.controlsContainer) {
                pageDOMElements.controlsToggleBtn.addEventListener('click', () => {
                    pageDOMElements.controlsContainer.classList.toggle('expanded');
                    pageDOMElements.controlsToggleBtn.classList.toggle('expanded');
                });
            }

            if (pageDOMElements.addItemBtn) {
                pageDOMElements.addItemBtn.addEventListener('click', () => {
                    openPropertyModal(); // Open for new property
                });
            }

            if (pageDOMElements.propertyForm) {
                pageDOMElements.propertyForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!pageCurrentUserId) {
                        commonDependencies.commonShowAlert('User not authenticated. Please sign in again.', 'Authentication Error');
                        return;
                    }
                    const address = pageDOMElements.propertyAddress.value.trim();
                    const type = pageDOMElements.propertyType.value;
                    const notes = pageDOMElements.propertyNotes.value.trim();
                    const propertyId = pageDOMElements.propertyIdInput.value;

                    if (!address) {
                        commonDependencies.commonShowAlert('Address is required for properties.', 'Validation Error');
                        return;
                    }

                    const propertyData = {
                        address,
                        type,
                        notes,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };

                    try {
                        if (propertyId) {
                            const propertyRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${propertyId}`);
                            const snapshot = await commonDependencies.fbGetDbData(propertyRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(propertyRef, {...existingData, ...propertyData, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Property updated successfully!');
                        } else {
                            propertyData.createdAt = commonDependencies.fbServerTimestamp();
                            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
                            await commonDependencies.fbPush(propertiesRef, propertyData);
                            commonDependencies.commonShowAlert('Property added successfully!');
                        }
                        if(pageDOMElements.propertyModal) pageDOMElements.propertyModal.style.display = 'none';
                    } catch (error) {
                        console.error('Error saving property:', error);
                        commonDependencies.commonShowAlert(`Error saving property: ${error.message}`, 'Save Error');
                    }
                });
            }
        }

        function loadProperties() {
            if (!pageCurrentUserId || !pageDatabase) {
                console.log("PropertiesPage: loadProperties - Aborted, no user or DB.");
                return;
            }
            console.log(`PropertiesPage: loadProperties - Initializing for user ${pageCurrentUserId}`);

            // Get filter and sort values
            const filterTypeValue = pageDOMElements.filterPropertyType ? pageDOMElements.filterPropertyType.dataset.value : '';
            const sortByValue = pageDOMElements.sortPropertiesBy ? pageDOMElements.sortPropertiesBy.dataset.value : 'address';
            const sortOrderValue = pageDOMElements.sortPropertiesOrder ? pageDOMElements.sortPropertiesOrder.dataset.value : 'asc';

            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);

            // Note: Firebase Realtime DB doesn't support multiple orderByChild or complex server-side filtering combined with sorting on different fields easily.
            // We will fetch all properties and then filter/sort client-side for simplicity with current structure.
            // For larger datasets, consider denormalizing data or using Firestore for more powerful queries.

            onValue(propertiesRef, async (propSnapshot) => { // Changed from query to just ref to get all for client-side sort/filter
                console.log("PropertiesPage: onValue triggered for propertiesRef.");
                const tableBody = pageDOMElements.propertiesTableBody; 
                const noMessage = pageDOMElements.noPropertiesMessage; 
                
                if (!tableBody || !noMessage) {
                    console.error("PropertiesPage: Table body or no message element not found in DOM.");
                    return;
                }
                tableBody.innerHTML = '';

                let propertiesArray = [];
                if (propSnapshot.exists()) {
                    propSnapshot.forEach(childSnapshot => {
                        propertiesArray.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                }

                // 1. Filter properties client-side
                if (filterTypeValue) {
                    propertiesArray = propertiesArray.filter(p => p.type === filterTypeValue);
                }

                // 2. Fetch work order counts (this part remains asynchronous per property)
                let propertyPromises = propertiesArray.map(prop => {
                    if (!prop || !prop.address) { // Basic sanity check
                        return Promise.resolve({ ...prop, openCount: 0, totalCount: 0, error: true, message: "Missing address" });
                    }
                    return commonDependencies.fbGetDbData(commonDependencies.fbQuery(workOrdersRef, commonDependencies.fbOrderByChild('propertyId'), commonDependencies.fbEqualTo(prop.id)))
                        .then(woSnapshot => {
                            let openCount = 0;
                            let totalCount = 0;
                            if(woSnapshot.exists()){
                                woSnapshot.forEach(woChild => {
                                    totalCount++;
                                    if(woChild.val() && woChild.val().status === 'Open') openCount++;
                                });
                            }
                            return { ...prop, openCount, totalCount };
                        }).catch(err => {
                            console.error(`PropertiesPage: Error fetching work order count for property ${prop.id}:`, err);
                            return { ...prop, openCount: 0, totalCount: 0, error: true, message: err.message }; 
                        });
                });

                Promise.all(propertyPromises).then(resolvedPropertiesWithCounts => {
                    let finalPropertiesToRender = resolvedPropertiesWithCounts.filter(p => !(p.error && p.message === "Missing address")); // Filter out ones that had no address initially

                    // 3. Sort properties client-side (after getting counts, if sorting by counts was needed - not currently an option)
                    finalPropertiesToRender.sort((a, b) => {
                        let valA = a[sortByValue];
                        let valB = b[sortByValue];

                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();

                        let comparison = 0;
                        if (valA > valB) comparison = 1;
                        else if (valA < valB) comparison = -1;
                        
                        return sortOrderValue === 'desc' ? comparison * -1 : comparison;
                    });

                    tableBody.innerHTML = ''; // Clear again before rendering sorted/filtered
                    if (finalPropertiesToRender.length > 0) {
                        noMessage.style.display = 'none';
                        finalPropertiesToRender.forEach(propData => {
                            if (propData.error && propData.message !== "Missing address") { // Log other errors but don't break row rendering
                                console.warn(`PropertiesPage: Skipping rendering for property ID: ${propData.id} due to WO count error: ${propData.message}`);
                                // Optionally render a row with an error message or skip
                            }
                            if (!propData.address) return; // Final check

                            const row = tableBody.insertRow();
                            row.setAttribute('data-id', propData.id);
                            row.insertCell().textContent = propData.address;
                            row.insertCell().textContent = propData.type || 'N/A';
                            row.insertCell().textContent = `${propData.openCount || 0} / ${propData.totalCount || 0}`;
                            const actionsCell = row.insertCell();
                            actionsCell.classList.add('actions-cell');
                            actionsCell.innerHTML = `<button class="edit-btn" title="Edit">${commonDependencies.commonEditIcon}</button><button class="delete-btn" title="Delete">${commonDependencies.commonDeleteIcon}</button>`;
                            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openPropertyModal(propData.id, propData));
                            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteProperty(propData.id)); 
                        });
                    } else {
                        noMessage.style.display = 'block';
                    }
                }).catch(err => {
                    console.error("PropertiesPage: Error in Promise.all for property WO counts:", err);
                    noMessage.style.display = 'block'; 
                    tableBody.innerHTML = '';
                });
            });
        }

        function openPropertyModal(id = null, data = {}) {
            if(!pageDOMElements.propertyForm || !pageDOMElements.propertyModal) return;
            pageDOMElements.propertyForm.reset();
            pageDOMElements.propertyIdInput.value = id || '';
            pageDOMElements.propertyModalTitle.textContent = id ? 'Edit Property' : 'Add New Property';
            pageDOMElements.propertyAddress.value = data.address || '';
            pageDOMElements.propertyType.value = data.type || 'Single Family Home';
            pageDOMElements.propertyNotes.value = data.notes || '';
            pageDOMElements.propertyModal.style.display = 'flex';
        }

        async function handleDeleteProperty(id) {
            if (!pageCurrentUserId || !pageDatabase) {
                console.error("handleDeleteProperty: User ID or DB not available");
                return;
            }
            
            const workOrdersQueryRef = commonDependencies.fbQuery(commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/`));
            const propertyRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}/${id}`);

            const confirmModal = document.getElementById('customConfirmModal');
            const confirmTitle = confirmModal.querySelector('#customConfirmTitle');
            const confirmMessage = confirmModal.querySelector('#customConfirmMessage');
            const confirmCancel = confirmModal.querySelector('#customConfirmCancel');
            const confirmOk = confirmModal.querySelector('#customConfirmOk');

            confirmTitle.textContent = 'Confirm Delete';
            confirmMessage.textContent = 'Are you sure you want to delete this property?';

            confirmCancel.addEventListener('click', () => {
                confirmModal.style.display = 'none';
            });

            confirmOk.addEventListener('click', async () => {
                try {
                    // Delete work orders associated with the property
                    const workOrdersSnapshot = await commonDependencies.fbGetDbData(workOrdersQueryRef);
                    if (workOrdersSnapshot.exists()) {
                        const workOrders = workOrdersSnapshot.val();
                        if (workOrders) {
                            const workOrdersKeys = Object.keys(workOrders);
                            const deletePromises = workOrdersKeys.map(key => {
                                return commonDependencies.fbRemove(commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/${key}`));
                            });
                            await Promise.all(deletePromises);
                        }
                    }

                    // Delete the property
                    await commonDependencies.fbRemove(propertyRef);
                    commonDependencies.commonShowAlert('Property deleted successfully!');

                    // Refresh properties
                    loadProperties();

                    if (confirmModal) confirmModal.style.display = 'none';
                } catch (error) {
                    console.error('Error deleting property:', error);
                    commonDependencies.commonShowAlert(`Error deleting property: ${error.message}`, 'Delete Error');
                }
            });

            confirmModal.style.display = 'flex';
        }
    </script>
</body>
</html>