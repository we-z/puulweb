<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Tab-like navigation for subsections */
        .sub-nav {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .sub-nav-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Align with parent border */
            font-weight: 500;
            color: #555;
            transition: color 0.2s ease, border-bottom-color 0.2s ease;
        }
        .sub-nav-item:hover {
            color: #000;
        }
        .sub-nav-item.active {
            color: #000;
            border-bottom-color: #000; /* Or your primary accent color */
        }
        .subsection-content {
            display: none;
        }
        .subsection-content.active {
            display: block;
        }
        .smart-feature-list {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .smart-feature-item {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1 1 calc(50% - 10px);
            box-sizing: border-box;
            min-width: 300px;
            display: flex;
            flex-direction: column;
        }
        .smart-feature-item h5 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .alert-list, .suggestion-list, .iot-device-list {
            list-style-type: none;
            padding-left: 0;
            margin-top: 10px;
        }
        .alert-list li, .suggestion-list li, .iot-device-list li {
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .alert-list li.critical {
            background-color: #fff0f0;
            border-left: 3px solid #e53e3e;
        }
        .alert-list li.warning {
             background-color: #fffaf0;
            border-left: 3px solid #dd6b20;
        }
        .suggestion-list button {
            margin-left: 10px;
            padding: 2px 8px;
            font-size: 0.8em;
            vertical-align: middle;
        }
        #scorecard-metrics {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            text-align: center;
        }
         #scorecard-metrics .metric {
            padding: 10px;
        }
        #scorecard-metrics .metric .value {
            font-size: 1.8em;
            font-weight: 600;
        }
        #scorecard-metrics .metric .label {
            font-size: 0.9em;
            color: #555;
        }
        #workOrderStatusChartContainer {
            position: relative;
            height: 250px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="maintenanceView">
            <div class="content-header">
                <h2>Maintenance</h2>
            </div>
            <div class="page-container">
                <div class="sub-nav" id="maintenanceSubNav">
                    <div class="sub-nav-item active" data-subsection="workOrders">Work Orders</div>
                    <div class="sub-nav-item" data-subsection="recurringWorkOrders">Recurring Work Orders</div>
                    <div class="sub-nav-item" data-subsection="inspections">Inspections</div>
                    <div class="sub-nav-item" data-subsection="unitTurns">Unit Turns</div>
                    <div class="sub-nav-item" data-subsection="projects">Projects</div>
                    <div class="sub-nav-item" data-subsection="purchaseOrders">Purchase Orders</div>
                    <div class="sub-nav-item" data-subsection="inventory">Inventory</div>
                    <div class="sub-nav-item" data-subsection="fixedAssets">Fixed Assets</div>
                    <div class="sub-nav-item" data-subsection="smartMaintenance">Smart Maintenance</div>
                </div>

                <!-- Work Orders Subsection -->
                <div class="subsection-content active" id="workOrdersContent">
                    <button class="controls-toggle-btn" id="controlsToggleBtn">
                        <span>Filters & Sort</span>
                        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="controls-container" style="margin-bottom: 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div class="filter-group">
                            <label for="filterProperty">Property:</label>
                            <div class="custom-dropdown" id="customFilterProperty">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Properties</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Properties</div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filterPriority">Priority:</label>
                            <div class="custom-dropdown" id="customFilterPriority">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Priorities</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Priorities</div>
                                    <div class="dropdown-option" data-value="Low">Low</div>
                                    <div class="dropdown-option" data-value="Medium">Medium</div>
                                    <div class="dropdown-option" data-value="High">High</div>
                                </div>
                            </div>
                        </div>
                         <div class="filter-group">
                            <label for="filterStatus">Status:</label>
                            <div class="custom-dropdown" id="customFilterStatus">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Statuses</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Statuses</div>
                                    <div class="dropdown-option" data-value="Open">Open</div>
                                    <div class="dropdown-option" data-value="In Progress">In Progress</div>
                                    <div class="dropdown-option" data-value="Closed">Closed</div>
                                </div>
                            </div>
                        </div>
                        <div class="sort-group">
                            <label for="sortBy">Sort by:</label>
                            <div class="custom-dropdown" id="customSortBy">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Date Created</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="createdAt">Date Created</div>
                                    <div class="dropdown-option" data-value="title">Title</div>
                                    <div class="dropdown-option" data-value="status">Status</div>
                                    <div class="dropdown-option" data-value="priority">Priority</div>
                                </div>
                            </div>
                            <div class="custom-dropdown" id="customSortOrder">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Descending</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="desc">Descending</div>
                                    <div class="dropdown-option" data-value="asc">Ascending</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container work-order-table-container">
                        <table class="data-table" id="workOrderTable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Property</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="workOrderTableBody">
                            </tbody>
                        </table>
                        <div id="noWorkOrdersMessage" class="no-data-message" style="display: none;">
                            <div class="icon">📝</div>
                            <p>No work orders yet.</p>
                            <span>Click the '+' button to add your first one!</span>
                        </div>
                    </div>
                </div>

                <!-- Recurring Work Orders Subsection -->
                <div class="subsection-content" id="recurringWorkOrdersContent">
                    <h4>Recurring Work Orders</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="recurringWorkOrderTable">
                            <thead>
                                <tr>
                                    <th>Task Name</th>
                                    <th>Property</th>
                                    <th>Frequency</th>
                                    <th>Next Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recurringWorkOrderTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="noRecurringWorkOrdersMessage" class="no-data-message">
                            <div class="icon">🔄</div>
                            <p>No recurring work orders set up yet.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Inspections Subsection -->
                <div class="subsection-content" id="inspectionsContent">
                    <h4>Inspections</h4>
                     <div class="data-table-container">
                        <table class="data-table" id="inspectionsTable">
                            <thead>
                                <tr>
                                    <th>Inspection Name/ID</th>
                                    <th>Property</th>
                                    <th>Date Scheduled</th>
                                    <th>Inspector</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inspectionsTableBody"></tbody>
                        </table>
                        <div id="noInspectionsMessage" class="no-data-message">
                            <div class="icon">🧐</div>
                            <p>No inspections scheduled or recorded.</p>
                        </div>
                    </div>
                </div>

                <!-- Unit Turns Subsection -->
                <div class="subsection-content" id="unitTurnsContent">
                     <h4>Unit Turns</h4>
                     <div class="data-table-container">
                        <table class="data-table" id="unitTurnsTable">
                            <thead>
                                <tr>
                                    <th>Unit/Property</th>
                                    <th>Move-Out Date</th>
                                    <th>Target Move-In Date</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unitTurnsTableBody"></tbody>
                        </table>
                        <div id="noUnitTurnsMessage" class="no-data-message">
                            <div class="icon">📦</div>
                            <p>No unit turns in progress.</p>
                        </div>
                    </div>
                </div>

                <!-- Projects Subsection -->
                <div class="subsection-content" id="projectsContent">
                    <h4>Projects</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Property</th>
                                    <th>Start Date</th>
                                    <th>End Date (Est.)</th>
                                    <th>Budget</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody"></tbody>
                        </table>
                        <div id="noProjectsMessage" class="no-data-message">
                            <div class="icon">🏗️</div>
                            <p>No projects currently tracked.</p>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders Subsection -->
                <div class="subsection-content" id="purchaseOrdersContent">
                    <h4>Purchase Orders</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="purchaseOrdersTable">
                            <thead>
                                <tr>
                                    <th>PO Number</th>
                                    <th>Vendor</th>
                                    <th>Order Date</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseOrdersTableBody"></tbody>
                        </table>
                        <div id="noPurchaseOrdersMessage" class="no-data-message">
                            <div class="icon">🛒</div>
                            <p>No purchase orders found.</p>
                        </div>
                    </div>
                </div>

                <!-- Inventory Subsection -->
                <div class="subsection-content" id="inventoryContent">
                    <h4>Inventory</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>SKU/ID</th>
                                    <th>Category</th>
                                    <th>Quantity on Hand</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody"></tbody>
                        </table>
                        <div id="noInventoryMessage" class="no-data-message">
                            <div class="icon">🔩</div>
                            <p>No inventory items tracked.</p>
                        </div>
                    </div>
                </div>

                <!-- Fixed Assets Subsection -->
                <div class="subsection-content" id="fixedAssetsContent">
                    <h4>Fixed Assets</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="fixedAssetsTable">
                            <thead>
                                <tr>
                                    <th>Asset Name</th>
                                    <th>Asset ID</th>
                                    <th>Property</th>
                                    <th>Purchase Date</th>
                                    <th>Purchase Cost</th>
                                    <th>Current Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fixedAssetsTableBody"></tbody>
                        </table>
                        <div id="noFixedAssetsMessage" class="no-data-message">
                            <div class="icon">📠</div>
                            <p>No fixed assets recorded.</p>
                        </div>
                    </div>
                </div>

                <!-- Smart Maintenance Subsection -->
                <div class="subsection-content" id="smartMaintenanceContent">
                    <h4>Smart Maintenance Insights</h4>
                    <div class="smart-maintenance-overview">
                        <p>Leverage AI and IoT data for proactive maintenance, cost optimization, and enhanced operational efficiency. This section provides predictive insights and actionable recommendations.</p>
                    </div>
                    <div class="smart-feature-list">
                        <div class="smart-feature-item">
                            <h5>Predictive Maintenance Alerts</h5>
                            <p>Alerts based on sensor data or historical trends predicting potential equipment failures (e.g., HVAC, water heaters).</p>
                            <ul class="alert-list" id="predictiveAlertsList"></ul>
                            <div id="noPredictiveAlerts" style="display: none; text-align: center; padding: 20px; color: #777;">No predictive alerts at this time.</div>
                            <button class="btn-secondary view-smart-details" id="refreshSmartMaintenanceBtn" style="width: 100%; margin-top: 10px;">Refresh Insights</button>
                        </div>
                        <div class="smart-feature-item">
                            <h5>IoT Device Status & Connectivity</h5>
                            <p>Overview of connected smart devices (thermostats, leak detectors, smart locks) and their operational status.</p>
                            <div class="iot-status-summary" id="iotStatusSummary" style="margin-bottom: 15px;"></div>
                            <ul class="iot-device-list" id="iotDeviceList"></ul>
                            <div id="noIotDevices" style="display: none; text-align: center; padding: 20px; color: #777;">No IoT devices are being tracked.</div>
                        </div>
                        <div class="smart-feature-item">
                            <h5>Maintenance Efficiency Scorecards</h5>
                            <p>Analytics on maintenance team performance, work order completion times, and cost-effectiveness.</p>
                            <div id="maintenanceScorecards">
                                 <div id="scorecard-metrics"></div>
                                 <div id="workOrderStatusChartContainer">
                                    <canvas id="workOrderStatusChart"></canvas>
                                 </div>
                            </div>
                            <div id="noMaintenanceDataForScorecard" style="display: none; text-align: center; padding: 20px; color: #777;">Not enough data to generate scorecards.</div>
                        </div>
                        <div class="smart-feature-item">
                            <h5>Automated Work Order Generation (Suggestions)</h5>
                            <p>AI suggests creating work orders based on detected anomalies or scheduled preventive maintenance derived from smart data.</p>
                            <ul class="suggestion-list" id="workOrderSuggestionsList"></ul>
                            <div id="noWorkOrderSuggestions" style="display: none; text-align: center; padding: 20px; color: #777;">No work order suggestions at this time.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="addItemBtn" aria-label="Add new item">
        +
    </button>

    <!-- Modal for Adding/Editing Work Orders -->
    <div id="workOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="workOrderModalTitle">Add New Work Order</h3>
                <button class="close-btn" data-modal-id="workOrderModal">&times;</button>
            </div>
            <form id="workOrderForm">
                <input type="hidden" id="workOrderId" name="workOrderId">
                <div class="form-group">
                    <label for="workOrderTitleInput">Title</label>
                    <input type="text" id="workOrderTitleInput" name="title" required placeholder="e.g., Leaky faucet in master bathroom">
                </div>
                <div class="form-group">
                    <label for="workOrderPropertySelect">Property</label>
                    <select id="workOrderPropertySelect" name="propertyId">
                        <option value="">Select Property (Optional)</option>
                        <!-- Property options will be populated here by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="workOrderDescription">Description</label>
                    <textarea id="workOrderDescription" name="description" rows="3" required placeholder="Details about the work order..."></textarea>
                </div>
                <div class="form-group">
                    <label for="workOrderStatus">Status</label>
                    <select id="workOrderStatus" name="status">
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="workOrderPriority">Priority</label>
                    <select id="workOrderPriority" name="priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" data-modal-id="workOrderModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save Work Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Recurring Work Order Modal -->
    <div id="recurringWorkOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Recurring Work Order</h3><button class="close-btn" data-modal-id="recurringWorkOrderModal">&times;</button></div>
            <form id="recurringWorkOrderForm">
                <input type="hidden" id="recurringWorkOrderId" name="recurringWorkOrderId">
                <div class="form-group"><label>Task Name</label><input type="text" id="recurringTaskName" name="taskName" required></div>
                <div class="form-group"><label>Property</label><select id="recurringPropertyId" name="propertyId"></select></div>
                <div class="form-group"><label>Frequency</label><select id="recurringFrequency" name="frequency"><option value="Daily">Daily</option><option value="Weekly">Weekly</option><option value="Bi-Weekly">Bi-Weekly</option><option value="Monthly">Monthly</option><option value="Quarterly">Quarterly</option><option value="Annually">Annually</option></select></div>
                <div class="form-group"><label>Start Date (for first occurrence)</label><input type="date" id="recurringStartDate" name="startDate" required></div>
                <div class="form-group"><label>Assigned Vendor (Optional)</label><select id="recurringAssignedVendorId" name="assignedVendorId"></select></div>
                <div class="form-group"><label>Status</label><select id="recurringStatus" name="status"><option value="Active">Active</option><option value="Paused">Paused</option></select></div>
                <div class="form-group"><label>Notes</label><textarea id="recurringNotes" name="notes" rows="3"></textarea></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="recurringWorkOrderModal">Cancel</button><button type="submit" class="submit-btn">Save Recurring Task</button></div>
            </form>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div id="inspectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Inspection</h3><button class="close-btn" data-modal-id="inspectionModal">&times;</button></div>
            <form id="inspectionForm">
                <input type="hidden" id="inspectionId" name="inspectionId">
                <div class="form-group"><label>Inspection Name</label><input type="text" id="inspectionName" name="inspectionName" required></div>
                <div class="form-group"><label>Property</label><select id="inspectionPropertyId" name="propertyId"></select></div>
                <div class="form-group"><label>Unit (Optional)</label><input type="text" id="inspectionUnit" name="unit" placeholder="e.g., Apt 101"></div>
                <div class="form-group"><label>Date Scheduled</label><input type="datetime-local" id="inspectionScheduledDate" name="scheduledDate"></div>
                <div class="form-group"><label>Inspector</label><input type="text" id="inspectorName" name="inspector"></div>
                <div class="form-group"><label>Status</label><select id="inspectionStatus" name="status"><option value="Scheduled">Scheduled</option><option value="In Progress">In Progress</option><option value="Completed">Completed</option><option value="Cancelled">Cancelled</option></select></div>
                <div class="form-group"><label>Notes</label><textarea id="inspectionNotes" name="notes" rows="3"></textarea></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="inspectionModal">Cancel</button><button type="submit" class="submit-btn">Save Inspection</button></div>
            </form>
        </div>
    </div>
    
    <!-- Unit Turn Modal -->
    <div id="unitTurnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Unit Turn</h3><button class="close-btn" data-modal-id="unitTurnModal">&times;</button></div>
            <form id="unitTurnForm">
                <input type="hidden" id="unitTurnId" name="unitTurnId">
                <div class="form-group"><label>Unit/Property</label><select id="unitTurnPropertyId" name="propertyId" required></select></div>
                <div class="form-group"><label>Unit Number (if applicable)</label><input type="text" id="unitTurnUnitNumber" name="unitNumber"></div>
                <div class="form-group"><label>Move-Out Date</label><input type="date" id="unitTurnMoveOutDate" name="moveOutDate"></div>
                <div class="form-group"><label>Target Move-In Date</label><input type="date" id="unitTurnTargetMoveInDate" name="targetMoveInDate"></div>
                <div class="form-group"><label>Status</label><select id="unitTurnStatus" name="status"><option value="Pending">Pending</option><option value="Cleaning">Cleaning</option><option value="Repairs">Repairs</option><option value="Ready">Ready</option><option value="Completed">Completed</option></select></div>
                <div class="form-group"><label>Assigned To</label><input type="text" id="unitTurnAssignedTo" name="assignedTo"></div>
                <div class="form-group"><label>Notes</label><textarea id="unitTurnNotes" name="notes" rows="3"></textarea></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="unitTurnModal">Cancel</button><button type="submit" class="submit-btn">Save Unit Turn</button></div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Project</h3><button class="close-btn" data-modal-id="projectModal">&times;</button></div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group"><label>Project Name</label><input type="text" name="projectName" required></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Start Date</label><input type="date" name="startDate"></div>
                <div class="form-group"><label>Estimated End Date</label><input type="date" name="endDate"></div>
                <div class="form-group"><label>Budget ($)</label><input type="number" name="budget" step="0.01"></div>
                <div class="form-group"><label>Status</label><select name="status"><option>Planning</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Cancelled</option></select></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="projectModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- Purchase Order Modal -->
    <div id="purchaseOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Purchase Order</h3><button class="close-btn" data-modal-id="purchaseOrderModal">&times;</button></div>
            <form id="purchaseOrderForm">
                <input type="hidden" id="purchaseOrderId">
                <div class="form-group"><label>PO Number</label><input type="text" name="poNumber" required></div>
                <div class="form-group"><label>Vendor</label><select name="vendorId"></select></div>
                <div class="form-group"><label>Order Date</label><input type="date" name="orderDate"></div>
                <div class="form-group"><label>Total Amount ($)</label><input type="number" name="totalAmount" step="0.01"></div>
                 <div class="form-group"><label>Status</label><select name="status"><option>Draft</option><option>Submitted</option><option>Approved</option><option>Received</option><option>Closed</option></select></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="purchaseOrderModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Inventory Item</h3><button class="close-btn" data-modal-id="inventoryModal">&times;</button></div>
            <form id="inventoryForm">
                <input type="hidden" id="inventoryItemId">
                <div class="form-group"><label>Item Name</label><input type="text" name="itemName" required></div>
                <div class="form-group"><label>SKU/ID</label><input type="text" name="sku"></div>
                <div class="form-group"><label>Category</label><input type="text" name="category"></div>
                <div class="form-group"><label>Quantity on Hand</label><input type="number" name="quantity" step="1"></div>
                <div class="form-group"><label>Location</label><input type="text" name="location"></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="inventoryModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- Fixed Asset Modal -->
    <div id="fixedAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Fixed Asset</h3><button class="close-btn" data-modal-id="fixedAssetModal">&times;</button></div>
            <form id="fixedAssetForm">
                 <input type="hidden" id="fixedAssetId">
                <div class="form-group"><label>Asset Name</label><input type="text" name="assetName" required></div>
                <div class="form-group"><label>Asset ID</label><input type="text" name="assetId"></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Purchase Date</label><input type="date" name="purchaseDate"></div>
                <div class="form-group"><label>Purchase Cost ($)</label><input type="number" name="purchaseCost" step="0.01"></div>
                <div class="form-group"><label>Notes</label><textarea name="notes"></textarea></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="fixedAssetModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>


    <!-- Custom Alert Toast Structure -->
    <div id="customAlertModal">
        <div class="custom-alert">
            <p>This is an alert message.</p>
        </div>
    </div>

    <!-- Common Confirm Modal -->
    <div id="customConfirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="customConfirmTitle">Confirm Action</h3>
                 <button class="close-btn" data-modal-id="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button>
                <button class="confirm-btn" id="customConfirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Global Work Order Filters and Sort ---
        // These must be defined before any function uses them
        let workOrderSort = {
            by: 'createdAt', // default sort by createdAt
            order: 'desc'    // default order descending
        };
        let workOrderFilters = {
            propertyId: '', // default: all properties
            priority: '',   // default: all priorities
            status: ''      // default: all statuses
        };

        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData, initializeCustomDropdown, initializeSimpleDropdown } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let pageCurrentUserId;
        let pageDatabase;
        let localPropertiesMap = {}; // For mapping property IDs to names for this page
        let commonDependencies = {}; // To store common functions, icons, and Firebase utils
        let listenersInitialized = {}; // To track if onValue listeners are set for subsections
        let workOrderStatusChartInstance = null; // To hold the chart instance

        // Cache DOM elements for each subsection for efficiency
        const pageDOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            // Work Orders
            workOrderModal: document.getElementById('workOrderModal'),
            workOrderModalTitle: document.getElementById('workOrderModalTitle'),
            workOrderForm: document.getElementById('workOrderForm'),
            workOrderIdInput: document.getElementById('workOrderId'),
            workOrderTitleInput: document.getElementById('workOrderTitleInput'),
            workOrderPropertySelect: document.getElementById('workOrderPropertySelect'),
            workOrderDescription: document.getElementById('workOrderDescription'), 
            workOrderStatus: document.getElementById('workOrderStatus'),
            workOrderPriority: document.getElementById('workOrderPriority'),
            workOrderTableBody: document.getElementById('workOrderTableBody'),
            noWorkOrdersMessage: document.getElementById('noWorkOrdersMessage'),
            filterProperty: document.getElementById('customFilterProperty'),
            filterPriority: document.getElementById('customFilterPriority'),
            filterStatus: document.getElementById('customFilterStatus'),
            sortBy: document.getElementById('customSortBy'),
            sortOrder: document.getElementById('customSortOrder'),
            controlsToggleBtn: document.getElementById('controlsToggleBtn'),
            controlsContainer: document.querySelector('#workOrdersContent .controls-container'),
            // Other subsections will have their elements added here
            recurringWorkOrderTableBody: document.getElementById('recurringWorkOrderTableBody'),
            noRecurringWorkOrdersMessage: document.getElementById('noRecurringWorkOrdersMessage'),
            recurringWorkOrderModal: document.getElementById('recurringWorkOrderModal'),
            recurringWorkOrderForm: document.getElementById('recurringWorkOrderForm'),

            inspectionsTableBody: document.getElementById('inspectionsTableBody'),
            noInspectionsMessage: document.getElementById('noInspectionsMessage'),
            inspectionModal: document.getElementById('inspectionModal'),
            inspectionForm: document.getElementById('inspectionForm'),

            unitTurnsTableBody: document.getElementById('unitTurnsTableBody'),
            noUnitTurnsMessage: document.getElementById('noUnitTurnsMessage'),
            unitTurnModal: document.getElementById('unitTurnModal'),
            unitTurnForm: document.getElementById('unitTurnForm'),

            projectsTableBody: document.getElementById('projectsTableBody'),
            noProjectsMessage: document.getElementById('noProjectsMessage'),
            projectModal: document.getElementById('projectModal'),
            projectForm: document.getElementById('projectForm'),

            purchaseOrdersTableBody: document.getElementById('purchaseOrdersTableBody'),
            noPurchaseOrdersMessage: document.getElementById('noPurchaseOrdersMessage'),
            purchaseOrderModal: document.getElementById('purchaseOrderModal'),
            purchaseOrderForm: document.getElementById('purchaseOrderForm'),

            inventoryTableBody: document.getElementById('inventoryTableBody'),
            noInventoryMessage: document.getElementById('noInventoryMessage'),
            inventoryModal: document.getElementById('inventoryModal'),
            inventoryForm: document.getElementById('inventoryForm'),

            fixedAssetsTableBody: document.getElementById('fixedAssetsTableBody'),
            noFixedAssetsMessage: document.getElementById('noFixedAssetsMessage'),
            fixedAssetModal: document.getElementById('fixedAssetModal'),
            fixedAssetForm: document.getElementById('fixedAssetForm'),
        };
        
        function pageInit(userId, db, ...allCommonDeps) {
            pageCurrentUserId = userId; pageDatabase = db;
            const [ fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGet, fbGetDbDataExt, fbUpdateDbDataExt, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeCustomDropdown ] = allCommonDeps;
            commonDependencies = { fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGet, fbGetDbData: fbGetDbDataExt, fbUpdateDbData: fbUpdateDbDataExt, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeCustomDropdown };

            initializeSubNav();
            initializePropertiesListener();
            initializeVendorsListener(); 
            initializeMaintenanceFilters(); // Initialize and attach listeners for filters
            
            loadDataForActiveSubsection();
            setupEventListeners();
            setupSmartMaintenanceButtons(); 

            if (pageDOMElements.controlsToggleBtn) {
                pageDOMElements.controlsToggleBtn.addEventListener('click', () => {
                    const controlsContainer = pageDOMElements.controlsToggleBtn.nextElementSibling;
                    const arrowIcon = pageDOMElements.controlsToggleBtn.querySelector('.arrow-icon');
                    if (controlsContainer.style.display === 'none' || controlsContainer.style.display === '') {
                        controlsContainer.style.display = 'flex';
                        arrowIcon.style.transform = 'rotate(0deg)';
                    } else {
                        controlsContainer.style.display = 'none';
                        arrowIcon.style.transform = 'rotate(-90deg)';
                    }
                });
                 // Initially hide filters
                pageDOMElements.controlsToggleBtn.nextElementSibling.style.display = 'none';
                pageDOMElements.controlsToggleBtn.querySelector('.arrow-icon').style.transform = 'rotate(-90deg)';
            }
            
            pageDOMElements.addItemBtn.addEventListener('click', () => {
                const activeSubSection = document.querySelector('#maintenanceSubNav .sub-nav-item.active').dataset.subsection;
                openModalForSubsection(activeSubSection);
            });
        }

        function initializeSubNav() {
            const subNavContainer = document.getElementById('maintenanceSubNav');
            const subsections = document.querySelectorAll('.subsection-content');
            const subNavItems = subNavContainer.querySelectorAll('.sub-nav-item');

            subNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Update active tab
                    subNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update active content
                    const targetSubsectionId = item.dataset.subsection + "Content";
                    subsections.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetSubsectionId) {
                            content.classList.add('active');
                        }
                    });

                    // Load data for the newly activated subsection
                    loadDataForActiveSubsection();

                    // Show/hide FAB based on subsection if needed, or change its context
                    const fab = pageDOMElements.addItemBtn;
                    if (item.dataset.subsection === "smartMaintenance") { // Example: hide FAB for Smart Maintenance
                        fab.style.display = 'none';
                    } else {
                        fab.style.display = 'flex';
                    }
                });
            });
        }

        function openModalForSubsection(subsection, id = null, data = {}) {
            switch (subsection) {
                case 'workOrders':
                    openWorkOrderModal(id, data);
                    break;
                case 'recurringWorkOrders':
                    openRecurringWorkOrderModal(id, data);
                    break;
                case 'inspections':
                    openInspectionModal(id, data);
                    break;
                case 'unitTurns':
                    openUnitTurnModal(id, data);
                    break;
                case 'projects':
                    openProjectModal(id, data);
                    break;
                case 'purchaseOrders':
                    openPurchaseOrderModal(id, data);
                    break;
                case 'inventory':
                    openInventoryModal(id, data);
                    break;
                case 'fixedAssets':
                    openFixedAssetModal(id, data);
                    break;
                // Add other cases as needed
            }
        }

        function loadDataForActiveSubsection() {
            const activeSubSection = document.querySelector('#maintenanceSubNav .sub-nav-item.active').dataset.subsection;
            switch (activeSubSection) {
                case 'workOrders': loadWorkOrders(); break;
                case 'recurringWorkOrders': loadRecurringWorkOrders(); break;
                case 'inspections': loadInspections(); break;
                case 'unitTurns': loadUnitTurns(); break;
                case 'projects': loadProjects(); break;
                case 'purchaseOrders': loadPurchaseOrders(); break;
                case 'inventory': loadInventory(); break;
                case 'fixedAssets': loadFixedAssets(); break;
                case 'smartMaintenance': loadSmartMaintenanceData(); break;
                // Add other cases as needed
            }
        }
        
        function initializePropertiesListener() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(propertiesRef, commonDependencies.fbOrderByChild('address')), (snapshot) => {
                localPropertiesMap = {};
                
                // Populate Work Order Property Select
                if (pageDOMElements.workOrderPropertySelect) {
                    const currentWOPropertyValue = pageDOMElements.workOrderPropertySelect.value;
                    pageDOMElements.workOrderPropertySelect.innerHTML = '<option value="">Select Property (Optional)</option>';
                     snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const prop = childSnapshot.val();
                        if (prop && prop.address) {
                            localPropertiesMap[key] = prop.address;
                            const modalOption = document.createElement('option');
                            modalOption.value = key;
                            modalOption.textContent = prop.address;
                            pageDOMElements.workOrderPropertySelect.appendChild(modalOption);
                        }
                    });
                    pageDOMElements.workOrderPropertySelect.value = currentWOPropertyValue; // Restore selection
                }

                // Populate Filter Property Dropdown (for Work Orders)
                const filterPropertyDropdown = pageDOMElements.filterProperty;
                if (filterPropertyDropdown) {
                    const optionsContainer = filterPropertyDropdown.querySelector('.dropdown-options');
                    const selectedValueSpan = filterPropertyDropdown.querySelector('.selected-value');
                    const currentValue = filterPropertyDropdown.dataset.value; // Current filter value
                    optionsContainer.innerHTML = ''; 

                    const allOptionEl = document.createElement('div');
                    allOptionEl.classList.add('dropdown-option');
                    allOptionEl.dataset.value = '';
                    allOptionEl.textContent = 'All Properties';
                    optionsContainer.appendChild(allOptionEl);

                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const prop = childSnapshot.val();
                        if (prop && prop.address) { // Already mapped in localPropertiesMap
                            const filterOptionEl = document.createElement('div');
                            filterOptionEl.classList.add('dropdown-option');
                            filterOptionEl.dataset.value = key;
                            filterOptionEl.textContent = prop.address;
                            optionsContainer.appendChild(filterOptionEl);
                        }
                    });
                    
                    // Reset selection for the filter dropdown
                    let newSelectedText = 'All Properties';
                    let newSelectedValue = '';
                    let foundCurrent = false;
                    optionsContainer.querySelectorAll('.dropdown-option').forEach(opt => {
                         opt.classList.remove('selected');
                        if (opt.dataset.value === currentValue) {
                            newSelectedText = opt.textContent;
                            newSelectedValue = opt.dataset.value;
                            opt.classList.add('selected');
                            foundCurrent = true;
                        }
                    });
                    if (!foundCurrent) { // If previous selection is no longer valid, default to "All Properties"
                        const defaultOpt = optionsContainer.querySelector('.dropdown-option[data-value=""]');
                        if (defaultOpt) defaultOpt.classList.add('selected');
                    } else {
                         //Ensure the currently selected option is marked, if it still exists
                        const currentOpt = optionsContainer.querySelector(`.dropdown-option[data-value="${currentValue}"]`);
                        if(currentOpt) currentOpt.classList.add('selected');
                    }

                    selectedValueSpan.textContent = newSelectedText;
                    filterPropertyDropdown.dataset.value = newSelectedValue;
                }

                // Populate property dropdowns in other modals
                const propertySelects = [
                    pageDOMElements.recurringWorkOrderForm?.elements.propertyId,
                    pageDOMElements.inspectionForm?.elements.propertyId,
                    pageDOMElements.unitTurnForm?.elements.propertyId,
                    pageDOMElements.projectForm?.elements.propertyId,
                    pageDOMElements.fixedAssetForm?.elements.propertyId
                    // Add other property selects here
                ];

                propertySelects.forEach(select => {
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Select Property</option>';
                         snapshot.forEach(childSnapshot => {
                            const key = childSnapshot.key;
                            const prop = childSnapshot.val();
                            if (prop && prop.address) {
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = prop.address;
                                select.appendChild(option);
                            }
                        });
                        select.value = currentVal; // Restore selection if possible
                    }
                });
            });
        }
        
        // --- Work Orders Section Logic ---
        function setupWorkOrderEventListeners() {
            if (pageDOMElements.workOrderForm) {
                pageDOMElements.workOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!pageCurrentUserId) {
                        showAlert('User not authenticated.', 'Authentication Error');
                        return;
                    }
                    const title = pageDOMElements.workOrderTitleInput.value.trim();
                    const propertyId = pageDOMElements.workOrderPropertySelect.value;
                    const description = pageDOMElements.workOrderDescription.value.trim();
                    const status = pageDOMElements.workOrderStatus.value;
                    const priority = pageDOMElements.workOrderPriority.value;
                    const workOrderId = pageDOMElements.workOrderIdInput.value;

                    if (!title || !description) {
                        showAlert('Title and Description are required.', 'Validation Error');
                        return;
                    }

                    const workOrderData = {
                        title, description, status, priority,
                        userId: pageCurrentUserId,
                        propertyId: propertyId || null,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };

                    try {
                        if (workOrderId) { 
                            const workOrderRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/${workOrderId}`);
                            const snapshot = await commonDependencies.fbGetDbData(workOrderRef);
                            const existingData = snapshot.val() || {};                           
                            await commonDependencies.fbSet(workOrderRef, {...existingData, ...workOrderData, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp() });
                            showAlert('Work order updated successfully!');
                        } else { 
                            workOrderData.createdAt = commonDependencies.fbServerTimestamp();
                            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);
                            await commonDependencies.fbPush(workOrdersRef, workOrderData);
                            showAlert('Work order added successfully!');
                        }
                        if(pageDOMElements.workOrderModal) pageDOMElements.workOrderModal.style.display = 'none';
                        // loadWorkOrders(); // Data will be reloaded by onValue listener
                    } catch (error) {
                        console.error('Error saving work order:', error);
                        showAlert(`Error: ${error.message}`, 'Save Error');
                    }
                });
            }
        }

        function loadWorkOrders() {
            if (!pageCurrentUserId || !pageDatabase || !pageDOMElements.workOrderTableBody) return;
            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);
            
            // Firebase queries are limited. We can order by one child. 
            // For more complex sorting/filtering, retrieve all and process client-side, or use Firestore.
            // For now, let's sort by the chosen field (default createdAt) and do filtering client-side.
            let queryRef = commonDependencies.fbQuery(workOrdersRef, commonDependencies.fbOrderByChild(workOrderSort.by));

            onValue(queryRef, (snapshot) => {
                pageDOMElements.workOrderTableBody.innerHTML = '';
                let hasData = false;
                let workOrdersArray = [];
                snapshot.forEach(childSnapshot => {
                    workOrdersArray.push({ id: childSnapshot.key, ...childSnapshot.val() });
                });

                // Client-side filtering
                const filteredWorkOrders = workOrdersArray.filter(wo => {
                    const matchesProperty = !workOrderFilters.propertyId || wo.propertyId === workOrderFilters.propertyId;
                    const matchesPriority = !workOrderFilters.priority || wo.priority === workOrderFilters.priority;
                    const matchesStatus = !workOrderFilters.status || wo.status === workOrderFilters.status;
                    return matchesProperty && matchesPriority && matchesStatus;
                });

                // Client-side sorting if not handled by Firebase query (or secondary sort)
                if (workOrderSort.order === 'desc') {
                    if(workOrderSort.by !== 'createdAt') { // Firebase sorts asc by default for strings, desc for numbers. Assume createdAt is timestamp (number).
                         filteredWorkOrders.sort((a, b) => (b[workOrderSort.by] > a[workOrderSort.by]) ? 1 : ((a[workOrderSort.by] > b[workOrderSort.by]) ? -1 : 0));
                    } else {
                        filteredWorkOrders.reverse(); // if ordered by createdAt (timestamp) via Firebase, reverse for desc.
                    }
                } else if (workOrderSort.by !== 'createdAt') { // asc and not timestamp
                     filteredWorkOrders.sort((a, b) => (a[workOrderSort.by] > b[workOrderSort.by]) ? 1 : ((b[workOrderSort.by] > a[workOrderSort.by]) ? -1 : 0));
                }
                // If by createdAt and asc, Firebase already handles it.

                filteredWorkOrders.forEach(wo => {
                    hasData = true;
                    populateWorkOrderRow(wo);
                });
                pageDOMElements.noWorkOrdersMessage.style.display = hasData ? 'none' : 'flex';
            }, { onlyOnce: false }); // Keep listening for real-time updates
        }
        
        function populateWorkOrderRow(wo) {
            if(!pageDOMElements.workOrderTableBody) return;
            const row = pageDOMElements.workOrderTableBody.insertRow();
            row.setAttribute('data-id', wo.id);

            row.insertCell().textContent = wo.title || 'N/A';
            row.insertCell().textContent = wo.propertyId ? (localPropertiesMap[wo.propertyId] || 'Unknown Property') : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(wo.status || 'N/A').toLowerCase().replace(' ', '-')}">${wo.status || 'N/A'}</span>`;
            row.insertCell().innerHTML = `<span class="priority-badge priority-${(wo.priority || 'N/A').toLowerCase()}">${wo.priority || 'N/A'}</span>`;
            row.insertCell().textContent = wo.createdAt ? new Date(wo.createdAt).toLocaleDateString() : 'N/A';

            const actionsCell = row.insertCell();
            actionsCell.classList.add('actions-cell');
            actionsCell.innerHTML = `<button class="edit-btn" title="Edit">${editIconSVG}</button><button class="delete-btn" title="Delete">${deleteIconSVG}</button>`;
            
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openWorkOrderModal(wo.id, wo); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteWorkOrder(wo.id); });
            row.addEventListener('click', () => openWorkOrderModal(wo.id, wo));
        }

        function openWorkOrderModal(id = null, data = {}) {
            if(!pageDOMElements.workOrderForm || !pageDOMElements.workOrderModal) return;
            pageDOMElements.workOrderForm.reset();
            pageDOMElements.workOrderIdInput.value = id || '';
            pageDOMElements.workOrderModalTitle.textContent = id ? 'Edit Work Order' : 'Add New Work Order';
            pageDOMElements.workOrderTitleInput.value = data.title || '';
            pageDOMElements.workOrderPropertySelect.value = data.propertyId || '';
            pageDOMElements.workOrderDescription.value = data.description || '';
            pageDOMElements.workOrderStatus.value = data.status || 'Open';
            pageDOMElements.workOrderPriority.value = data.priority || 'Medium';
            pageDOMElements.workOrderModal.style.display = 'flex';
        }

        async function handleDeleteWorkOrder(id) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await showConfirm('Are you sure you want to delete this work order?', 'Delete Work Order');
            if (confirmed) {
                try {
                    const workOrderRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/${id}`);
                    await commonDependencies.fbRemove(workOrderRef);
                    showAlert('Work order deleted successfully!');
                } catch (error) {
                    console.error('Error deleting work order:', error);
                    showAlert(`Error: ${error.message}`, 'Delete Error');
                }
            }
        }

        // --- Recurring Work Orders Section Logic ---
        function setupRecurringWorkOrderEventListeners() {
            if (pageDOMElements.recurringWorkOrderForm) {
                pageDOMElements.recurringWorkOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.recurringWorkOrderId.value;
                    const data = {
                        taskName: form.taskName.value,
                        propertyId: form.propertyId.value,
                        frequency: form.frequency.value,
                        startDate: form.startDate.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.taskName || !data.propertyId || !data.frequency) {
                        showAlert('Task Name, Property, and Frequency are required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `recurringWorkOrders/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert('Recurring Work Order updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            showAlert('Recurring Work Order added.');
                        }
                        pageDOMElements.recurringWorkOrderModal.style.display = 'none';
                    } catch (error) { showAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadRecurringWorkOrders() {
            if (!pageCurrentUserId || !pageDatabase || listenersInitialized.recurringWorkOrders) return;
            listenersInitialized.recurringWorkOrders = true;

            const dataRef = commonDependencies.fbRef(pageDatabase, `recurringWorkOrders/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.recurringWorkOrderTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateRecurringWorkOrderRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noRecurringWorkOrdersMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateRecurringWorkOrderRow(data) {
            if (!pageDOMElements.recurringWorkOrderTableBody) return;
            const row = pageDOMElements.recurringWorkOrderTableBody.insertRow();
            row.insertCell().textContent = data.taskName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.frequency;
            
            // Calculate Next Due Date
            let nextDueDateStr = 'N/A';
            if (data.startDate && data.frequency && data.status === 'Active') {
                try {
                    const startDate = new Date(data.startDate + 'T00:00:00'); // Ensure parsing as local date
                    const today = new Date(); today.setHours(0,0,0,0);
                    let nextDueDate = new Date(startDate);

                    if (isNaN(nextDueDate.getTime())) {
                        console.error("Invalid start date for recurring work order:", data.startDate, data.id);
                        nextDueDateStr = 'Invalid Date';
                    } else {
                        while (nextDueDate < today) {
                            switch (data.frequency) {
                                case 'Daily': nextDueDate.setDate(nextDueDate.getDate() + 1); break;
                                case 'Weekly': nextDueDate.setDate(nextDueDate.getDate() + 7); break;
                                case 'Bi-Weekly': nextDueDate.setDate(nextDueDate.getDate() + 14); break;
                                case 'Monthly': nextDueDate.setMonth(nextDueDate.getMonth() + 1); break;
                                case 'Quarterly': nextDueDate.setMonth(nextDueDate.getMonth() + 3); break;
                                case 'Annually': nextDueDate.setFullYear(nextDueDate.getFullYear() + 1); break;
                                default: nextDueDate = new Date(today.getTime() + 100*365*24*60*60*1000); break; // Far future if frequency is unknown
                            }
                            if (nextDueDate > new Date(today.getTime() + 5*365*24*60*60*1000)) { // Safety break for >5 years in future
                                console.warn("Next due date calculation seems too far in future, breaking loop.", data.id);
                                break;
                            }
                        }
                        nextDueDateStr = nextDueDate.toLocaleDateString();
                    }
                } catch (e) {
                    console.error("Error calculating next due date:", e, data.id);
                    nextDueDateStr = 'Calc Error';
                }
            } else if (data.status === 'Paused') {
                nextDueDateStr = 'Paused';
            }
            row.insertCell().textContent = nextDueDateStr;
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Paused').toLowerCase()}">${data.status || 'Paused'}</span>`;

            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openModalForSubsection('recurringWorkOrders', data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('recurringWorkOrders', data.id, 'Recurring Work Order'));
            row.addEventListener('click', (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('button')) openModalForSubsection('recurringWorkOrders', data.id, data); });
        }
        
        function openRecurringWorkOrderModal(id = null, data = {}) {
            if (!pageDOMElements.recurringWorkOrderForm || !pageDOMElements.recurringWorkOrderModal) return;
            pageDOMElements.recurringWorkOrderForm.reset();
            // Ensure all form elements are correctly targeted using .elements
            pageDOMElements.recurringWorkOrderForm.elements.recurringWorkOrderId.value = id || '';
            pageDOMElements.recurringWorkOrderForm.elements.taskName.value = data.taskName || '';
            pageDOMElements.recurringWorkOrderForm.elements.propertyId.value = data.propertyId || '';
            pageDOMElements.recurringWorkOrderForm.elements.frequency.value = data.frequency || 'Monthly';
            pageDOMElements.recurringWorkOrderForm.elements.startDate.value = data.startDate || '';
            pageDOMElements.recurringWorkOrderForm.elements.assignedVendorId.value = data.assignedVendorId || '';
            pageDOMElements.recurringWorkOrderForm.elements.status.value = data.status || 'Active';
            pageDOMElements.recurringWorkOrderForm.elements.notes.value = data.notes || '';
            pageDOMElements.recurringWorkOrderModal.style.display = 'flex';
        }

        // --- Inspections Section Logic ---
        function setupInspectionEventListeners() {
            if (pageDOMElements.inspectionForm) {
                pageDOMElements.inspectionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.elements.inspectionId.value;
                    const dataToSave = {
                        inspectionName: form.elements.inspectionName.value,
                        propertyId: form.elements.propertyId.value,
                        unit: form.elements.unit.value,
                        scheduledDate: form.elements.scheduledDate.value,
                        inspector: form.elements.inspector.value,
                        status: form.elements.status.value,
                        notes: form.elements.notes.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!dataToSave.inspectionName || !dataToSave.propertyId || !dataToSave.scheduledDate) {
                         showAlert('Name, Property, and Scheduled Date are required.', 'Validation Error');
                        return;
                    }
                    // Using handleGenericFormSubmit structure for consistency
                    const firebasePath = 'inspections';
                    const itemName = 'Inspection';
                    const modalId = 'inspectionModal';
                    try {
                        const path = `${firebasePath}/${pageCurrentUserId}`;
                        if (id) {
                             const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...dataToSave, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert(`${itemName} updated.`);
                        } else {
                            dataToSave.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), dataToSave);
                            showAlert(`${itemName} added.`);
                        }
                        if (pageDOMElements.inspectionModal) pageDOMElements.inspectionModal.style.display = 'none';
                    } catch (error) { showAlert(`Error saving ${itemName}: ${error.message}`); }
                });
            }
        }

        function loadInspections() {
            if (!pageCurrentUserId || !pageDatabase || !pageDOMElements.inspectionsTableBody || listenersInitialized.inspections) return;
            listenersInitialized.inspections = true;

            const inspectionsRef = commonDependencies.fbRef(pageDatabase, `inspections/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(inspectionsRef, commonDependencies.fbOrderByChild('scheduledDate')), (snapshot) => {
                pageDOMElements.inspectionsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(childSnapshot => {
                    hasData = true;
                    populateInspectionRow({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                pageDOMElements.noInspectionsMessage.style.display = hasData ? 'none' : 'flex';
            });
        }

        function populateInspectionRow(data) {
            if (!pageDOMElements.inspectionsTableBody) return;
            const row = pageDOMElements.inspectionsTableBody.insertRow();
            row.insertCell().textContent = data.inspectionName || 'N/A';
            
            let propertyDisplay = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            if (data.unit) {
                propertyDisplay += ` - ${data.unit}`;
            }
            row.insertCell().textContent = propertyDisplay;

            let formattedDate = 'N/A';
            if (data.scheduledDate) {
                try {
                    const dateObj = new Date(data.scheduledDate);
                    if (!isNaN(dateObj.getTime())) {
                        formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    } else {
                        formattedDate = 'Invalid Date';
                    }
                } catch (e) {
                    formattedDate = 'Date Error'; 
                }
            }
            row.insertCell().textContent = formattedDate;
            row.insertCell().textContent = data.inspector || 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Scheduled').toLowerCase().replace(/\s+/g, '-')}">${data.status || 'Scheduled'}</span>`;

            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            // Corrected event listeners
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('inspections', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('inspections', data.id, 'Inspection'); });
            row.addEventListener('click', (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('button')) openModalForSubsection('inspections', data.id, data); });
        }

        function openInspectionModal(id = null, data = {}) {
            if (!pageDOMElements.inspectionForm || !pageDOMElements.inspectionModal) return;
            pageDOMElements.inspectionForm.reset();
            const formElements = pageDOMElements.inspectionForm.elements;
            formElements.inspectionId.value = id || '';
            formElements.inspectionName.value = data.inspectionName || '';
            formElements.propertyId.value = data.propertyId || '';
            formElements.unit.value = data.unit || '';
            formElements.scheduledDate.value = data.scheduledDate || '';
            formElements.inspector.value = data.inspector || '';
            formElements.status.value = data.status || 'Scheduled';
            formElements.notes.value = data.notes || '';
            pageDOMElements.inspectionModal.style.display = 'flex';
        }

        // --- Unit Turns Section Logic ---
        function setupUnitTurnEventListeners() {
            if (pageDOMElements.unitTurnForm) {
                pageDOMElements.unitTurnForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.elements.unitTurnId.value;
                    const dataToSave = {
                        propertyId: form.elements.propertyId.value,
                        unitNumber: form.elements.unitNumber.value,
                        moveOutDate: form.elements.moveOutDate.value,
                        targetMoveInDate: form.elements.targetMoveInDate.value,
                        status: form.elements.status.value,
                        assignedTo: form.elements.assignedTo.value,
                        notes: form.elements.notes.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!dataToSave.propertyId) {
                        showAlert('Property is required for Unit Turn.', 'Validation Error');
                        return;
                    }
                    // Using handleGenericFormSubmit structure for consistency
                    const firebasePath = 'unitTurns';
                    const itemName = 'Unit Turn';
                    const modalId = 'unitTurnModal';
                    try {
                        const path = `${firebasePath}/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...dataToSave, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert(`${itemName} updated.`);
                        } else {
                            dataToSave.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), dataToSave);
                            showAlert(`${itemName} added.`);
                        }
                        if (pageDOMElements.unitTurnModal) pageDOMElements.unitTurnModal.style.display = 'none';
                    } catch (error) { showAlert(`Error saving ${itemName}: ${error.message}`); }
                });
            }
        }

        function loadUnitTurns() {
            if (!pageCurrentUserId || !pageDatabase || !pageDOMElements.unitTurnsTableBody || listenersInitialized.unitTurns) return;
            listenersInitialized.unitTurns = true;

            const unitTurnsRef = commonDependencies.fbRef(pageDatabase, `unitTurns/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(unitTurnsRef, commonDependencies.fbOrderByChild('targetMoveInDate')), (snapshot) => {
                pageDOMElements.unitTurnsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(childSnapshot => {
                    hasData = true;
                    populateUnitTurnRow({ id: childSnapshot.key, ...childSnapshot.val() });
                });
                pageDOMElements.noUnitTurnsMessage.style.display = hasData ? 'none' : 'flex';
            });
        }

        function populateUnitTurnRow(data) {
            if (!pageDOMElements.unitTurnsTableBody) return;
            const row = pageDOMElements.unitTurnsTableBody.insertRow();
            let propertyDisplay = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            if (data.unitNumber) {
                propertyDisplay += ` - ${data.unitNumber}`;
            }
            row.insertCell().textContent = propertyDisplay;
            row.insertCell().textContent = data.moveOutDate ? new Date(data.moveOutDate + 'T00:00:00').toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.targetMoveInDate ? new Date(data.targetMoveInDate + 'T00:00:00').toLocaleDateString() : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(data.status || 'Pending').toLowerCase().replace(/\s+/g, '-')}">${data.status || 'Pending'}</span>`;
            row.insertCell().textContent = data.assignedTo || 'N/A';
            
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openModalForSubsection('unitTurns', data.id, data); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteGeneric('unitTurns', data.id, 'Unit Turn'); });
            row.addEventListener('click', (e) => { if(e.target.tagName !== 'BUTTON' && !e.target.closest('button')) openModalForSubsection('unitTurns', data.id, data); });
        }
        
        function openUnitTurnModal(id = null, data = {}) {
            if (!pageDOMElements.unitTurnForm || !pageDOMElements.unitTurnModal) return;
            pageDOMElements.unitTurnForm.reset();
            const formElements = pageDOMElements.unitTurnForm.elements;
            formElements.unitTurnId.value = id || '';
            formElements.propertyId.value = data.propertyId || '';
            formElements.unitNumber.value = data.unitNumber || '';
            formElements.moveOutDate.value = data.moveOutDate || '';
            formElements.targetMoveInDate.value = data.targetMoveInDate || '';
            formElements.status.value = data.status || 'Pending';
            formElements.assignedTo.value = data.assignedTo || '';
            formElements.notes.value = data.notes || '';
            pageDOMElements.unitTurnModal.style.display = 'flex';
        }

        // --- Projects Section Logic ---
        function setupProjectEventListeners() {
             if (pageDOMElements.projectForm) {
                pageDOMElements.projectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.projectId.value;
                    const data = {
                        projectName: form.projectName.value,
                        propertyId: form.propertyId.value,
                        startDate: form.startDate.value,
                        endDate: form.endDate.value,
                        budget: parseFloat(form.budget.value) || 0,
                        status: form.status.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.projectName) {
                         showAlert('Project Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `projects/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert('Project updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            showAlert('Project added.');
                        }
                        pageDOMElements.projectModal.style.display = 'none';
                    } catch (error) { showAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadProjects() {
            if (!pageCurrentUserId || !pageDatabase || listenersInitialized.projects) return;
            listenersInitialized.projects = true;

            const dataRef = commonDependencies.fbRef(pageDatabase, `projects/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.projectsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateProjectRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noProjectsMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateProjectRow(data) {
            const row = pageDOMElements.projectsTableBody.insertRow();
            row.insertCell().textContent = data.projectName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.startDate ? new Date(data.startDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.endDate ? new Date(data.endDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.budget ? `$${data.budget.toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openProjectModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('projects', data.id, 'Project'));
            row.addEventListener('click', () => openProjectModal(data.id, data));
        }

        function openProjectModal(id = null, data = {}) {
            pageDOMElements.projectForm.reset();
            pageDOMElements.projectForm.projectId.value = id || '';
            pageDOMElements.projectForm.projectName.value = data.projectName || '';
            pageDOMElements.projectForm.propertyId.value = data.propertyId || '';
            pageDOMElements.projectForm.startDate.value = data.startDate || '';
            pageDOMElements.projectForm.endDate.value = data.endDate || '';
            pageDOMElements.projectForm.budget.value = data.budget || '';
            pageDOMElements.projectForm.status.value = data.status || 'Planning';
            pageDOMElements.projectModal.style.display = 'flex';
        }

        // --- Purchase Orders Section Logic ---
        function setupPurchaseOrderEventListeners() {
            if (pageDOMElements.purchaseOrderForm) {
                pageDOMElements.purchaseOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.purchaseOrderId.value;
                    const data = {
                        poNumber: form.poNumber.value,
                        vendorId: form.vendorId.value, // Assuming you'll have vendor management later
                        orderDate: form.orderDate.value,
                        totalAmount: parseFloat(form.totalAmount.value) || 0,
                        status: form.status.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                     if (!data.poNumber || !data.vendorId) {
                         showAlert('PO Number and Vendor are required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `purchaseOrders/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert('Purchase Order updated.');
                        } else {
                             data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            showAlert('Purchase Order added.');
                        }
                        pageDOMElements.purchaseOrderModal.style.display = 'none';
                    } catch (error) { showAlert(`Error: ${error.message}`); }
                });
            }
        }
        
        function loadPurchaseOrders() {
            if (!pageCurrentUserId || !pageDatabase || listenersInitialized.purchaseOrders) return;
            listenersInitialized.purchaseOrders = true;

            const dataRef = commonDependencies.fbRef(pageDatabase, `purchaseOrders/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.purchaseOrdersTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populatePurchaseOrderRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noPurchaseOrdersMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populatePurchaseOrderRow(data) {
            const row = pageDOMElements.purchaseOrdersTableBody.insertRow();
            row.insertCell().textContent = data.poNumber;
            row.insertCell().textContent = data.vendorId || 'N/A'; // Replace with vendor name when available
            row.insertCell().textContent = data.orderDate ? new Date(data.orderDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.totalAmount ? `$${data.totalAmount.toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openPurchaseOrderModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('purchaseOrders', data.id, 'Purchase Order'));
            row.addEventListener('click', () => openPurchaseOrderModal(data.id, data));
        }

        function openPurchaseOrderModal(id = null, data = {}) {
            pageDOMElements.purchaseOrderForm.reset();
            pageDOMElements.purchaseOrderForm.purchaseOrderId.value = id || '';
            pageDOMElements.purchaseOrderForm.poNumber.value = data.poNumber || '';
            pageDOMElements.purchaseOrderForm.vendorId.value = data.vendorId || '';
            pageDOMElements.purchaseOrderForm.orderDate.value = data.orderDate || '';
            pageDOMElements.purchaseOrderForm.totalAmount.value = data.totalAmount || '';
            pageDOMElements.purchaseOrderForm.status.value = data.status || 'Draft';
            pageDOMElements.purchaseOrderModal.style.display = 'flex';
        }

        // --- Inventory Section Logic ---
        function setupInventoryEventListeners() {
            if (pageDOMElements.inventoryForm) {
                pageDOMElements.inventoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.inventoryItemId.value;
                    const data = {
                        itemName: form.itemName.value,
                        sku: form.sku.value,
                        category: form.category.value,
                        quantity: parseInt(form.quantity.value) || 0,
                        location: form.location.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.itemName) {
                         showAlert('Item Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `inventory/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert('Inventory Item updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            showAlert('Inventory Item added.');
                        }
                        pageDOMElements.inventoryModal.style.display = 'none';
                    } catch (error) { showAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadInventory() {
             if (!pageCurrentUserId || !pageDatabase || listenersInitialized.inventory) return;
             listenersInitialized.inventory = true;

            const dataRef = commonDependencies.fbRef(pageDatabase, `inventory/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.inventoryTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateInventoryRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noInventoryMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateInventoryRow(data) {
            const row = pageDOMElements.inventoryTableBody.insertRow();
            row.insertCell().textContent = data.itemName;
            row.insertCell().textContent = data.sku || 'N/A';
            row.insertCell().textContent = data.category || 'N/A';
            row.insertCell().textContent = data.quantity;
            row.insertCell().textContent = data.location || 'N/A';
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openInventoryModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('inventory', data.id, 'Inventory Item'));
            row.addEventListener('click', () => openInventoryModal(data.id, data));
        }

        function openInventoryModal(id = null, data = {}) {
            pageDOMElements.inventoryForm.reset();
            pageDOMElements.inventoryForm.inventoryItemId.value = id || '';
            pageDOMElements.inventoryForm.itemName.value = data.itemName || '';
            pageDOMElements.inventoryForm.sku.value = data.sku || '';
            pageDOMElements.inventoryForm.category.value = data.category || '';
            pageDOMElements.inventoryForm.quantity.value = data.quantity || 0;
            pageDOMElements.inventoryForm.location.value = data.location || '';
            pageDOMElements.inventoryModal.style.display = 'flex';
        }


        // --- Fixed Assets Section Logic ---
        function setupFixedAssetEventListeners() {
            if (pageDOMElements.fixedAssetForm) {
                pageDOMElements.fixedAssetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.fixedAssetId.value;
                    const data = {
                        assetName: form.assetName.value,
                        assetId: form.assetId.value,
                        propertyId: form.propertyId.value,
                        purchaseDate: form.purchaseDate.value,
                        purchaseCost: parseFloat(form.purchaseCost.value) || 0,
                        notes: form.notes.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.assetName) {
                        showAlert('Asset Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `fixedAssets/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            showAlert('Fixed Asset updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            showAlert('Fixed Asset added.');
                        }
                        pageDOMElements.fixedAssetModal.style.display = 'none';
                    } catch (error) { showAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadFixedAssets() {
            if (!pageCurrentUserId || !pageDatabase || listenersInitialized.fixedAssets) return;
            listenersInitialized.fixedAssets = true;

            const dataRef = commonDependencies.fbRef(pageDatabase, `fixedAssets/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.fixedAssetsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateFixedAssetRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noFixedAssetsMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateFixedAssetRow(data) {
            const row = pageDOMElements.fixedAssetsTableBody.insertRow();
            row.insertCell().textContent = data.assetName;
            row.insertCell().textContent = data.assetId || 'N/A';
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.purchaseDate ? new Date(data.purchaseDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.purchaseCost ? `$${data.purchaseCost.toFixed(2)}` : 'N/A';
            row.insertCell().textContent = 'N/A'; // Placeholder for current value
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${editIconSVG}</button><button class="delete-btn">${deleteIconSVG}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openFixedAssetModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('fixedAssets', data.id, 'Fixed Asset'));
            row.addEventListener('click', () => openFixedAssetModal(data.id, data));
        }

        function openFixedAssetModal(id = null, data = {}) {
            pageDOMElements.fixedAssetForm.reset();
            pageDOMElements.fixedAssetForm.fixedAssetId.value = id || '';
            pageDOMElements.fixedAssetForm.assetName.value = data.assetName || '';
            pageDOMElements.fixedAssetForm.assetId.value = data.assetId || '';
            pageDOMElements.fixedAssetForm.propertyId.value = data.propertyId || '';
            pageDOMElements.fixedAssetForm.purchaseDate.value = data.purchaseDate || '';
            pageDOMElements.fixedAssetForm.purchaseCost.value = data.purchaseCost || '';
            pageDOMElements.fixedAssetForm.notes.value = data.notes || '';
            pageDOMElements.fixedAssetModal.style.display = 'flex';
        }

        // --- Generic Delete Function ---
        async function handleDeleteGeneric(sectionPath, itemId, itemNameSingular) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await showConfirm(`Are you sure you want to delete this ${itemNameSingular}?`, `Delete ${itemNameSingular}`);
            if (confirmed) {
                try {
                    const itemRef = commonDependencies.fbRef(pageDatabase, `${sectionPath}/${pageCurrentUserId}/${itemId}`);
                    await commonDependencies.fbRemove(itemRef);
                    showAlert(`${itemNameSingular} deleted successfully!`);
                } catch (error) {
                    console.error(`Error deleting ${itemNameSingular}:`, error);
                    showAlert(`Error: ${error.message}`, `Delete Error`);
                }
            }
        }
        
        initializeAuth(pageInit);

        function setupSmartMaintenanceButtons() {
            const refreshBtn = document.getElementById('refreshSmartMaintenanceBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadSmartMaintenanceData);
            }
        }

        // --- Smart Maintenance Section ---
        async function loadSmartMaintenanceData() {
            if (!pageCurrentUserId || !pageDatabase) return;
            // The refresh button can also call this function
            const refreshBtn = document.getElementById('refreshSmartMaintenanceBtn');
            if(refreshBtn) refreshBtn.disabled = true;

            // Clear old data
            document.getElementById('predictiveAlertsList').innerHTML = '<li>Loading alerts...</li>';
            document.getElementById('iotStatusSummary').innerHTML = 'Loading device status...';
            document.getElementById('iotDeviceList').innerHTML = '';
            document.getElementById('workOrderSuggestionsList').innerHTML = '<li>Loading suggestions...</li>';
            document.getElementById('scorecard-metrics').innerHTML = 'Loading metrics...';
            
            if (workOrderStatusChartInstance) {
                workOrderStatusChartInstance.destroy();
                workOrderStatusChartInstance = null;
            }

            try {
                // Run all data loading in parallel for speed
                const [alerts, suggestions] = await generatePredictiveAlertsAndSuggestions();
                const [iotSummary, iotDevices] = await loadIotDeviceData();
                const [metrics, chartData] = await generateMaintenanceScorecards();

                // Update UI once all data is fetched and processed
                updatePredictiveAlertsUI(alerts);
                updateWorkOrderSuggestionsUI(suggestions);
                updateIotStatusUI(iotSummary, iotDevices);
                updateScorecardsUI(metrics, chartData);

            } catch (error) {
                console.error("Error loading Smart Maintenance data:", error);
                showAlert("Could not load Smart Maintenance insights. Please try again.", "Error");
            } finally {
                 if(refreshBtn) refreshBtn.disabled = false;
            }
        }
        
        function updatePredictiveAlertsUI(alerts) {
            const alertsList = document.getElementById('predictiveAlertsList');
            const noAlertsMsg = document.getElementById('noPredictiveAlerts');
            alertsList.innerHTML = '';
            if (alerts && alerts.length > 0) {
                alerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.className = alert.type; // 'critical' or 'warning'
                    li.innerHTML = `<strong>${alert.title}:</strong> ${alert.message}`;
                    alertsList.appendChild(li);
                });
                noAlertsMsg.style.display = 'none';
            } else {
                noAlertsMsg.style.display = 'block';
            }
        }

        function updateWorkOrderSuggestionsUI(suggestions) {
            const suggestionsList = document.getElementById('workOrderSuggestionsList');
            const noSuggestionsMsg = document.getElementById('noWorkOrderSuggestions');
            suggestionsList.innerHTML = '';
            if (suggestions && suggestions.length > 0) {
                 suggestions.forEach(suggestion => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${suggestion.text}</span>`;
                    const createBtn = document.createElement('button');
                    createBtn.className = 'btn-secondary';
                    createBtn.textContent = 'Create Work Order';
                    createBtn.onclick = () => {
                        openWorkOrderModal(null, {
                            title: suggestion.wo.title,
                            propertyId: suggestion.wo.propertyId,
                            description: suggestion.wo.description,
                            priority: 'High'
                        });
                    };
                    li.appendChild(createBtn);
                    suggestionsList.appendChild(li);
                });
                noSuggestionsMsg.style.display = 'none';
            } else {
                noSuggestionsMsg.style.display = 'block';
            }
        }

        function updateIotStatusUI(summary, devices) {
            const summaryContainer = document.getElementById('iotStatusSummary');
            const deviceList = document.getElementById('iotDeviceList');
            const noDevicesMsg = document.getElementById('noIotDevices');
            summaryContainer.innerHTML = '';
            deviceList.innerHTML = '';

            if (devices && devices.length > 0) {
                 summaryContainer.innerHTML = `<strong>Connected Devices:</strong> ${summary.online}/${summary.total} | <strong>Offline:</strong> ${summary.offline} | <strong>Low Battery:</strong> ${summary.lowBattery}`;
                 devices.forEach(device => {
                    const li = document.createElement('li');
                    const statusColor = device.status === 'online' ? 'green' : 'red';
                    const batteryInfo = device.battery !== null ? ` | Battery: ${device.battery}% ${device.battery < 20 ? '⚠️' : ''}` : '';
                    li.innerHTML = `<span style="color:${statusColor}">●</span> <strong>${device.name}</strong> (${localPropertiesMap[device.propertyId] || 'N/A'}) - <em>${device.type}</em>${batteryInfo}`;
                    deviceList.appendChild(li);
                });
                noDevicesMsg.style.display = 'none';
            } else {
                noDevicesMsg.style.display = 'block';
                 summaryContainer.innerHTML = '';
            }
        }

        function updateScorecardsUI(metrics, chartData) {
            const metricsContainer = document.getElementById('scorecard-metrics');
            const noDataMsg = document.getElementById('noMaintenanceDataForScorecard');
            const chartContainer = document.getElementById('workOrderStatusChartContainer');
            const chartCanvas = document.getElementById('workOrderStatusChart');
            metricsContainer.innerHTML = '';
            
            if (workOrderStatusChartInstance) {
                workOrderStatusChartInstance.destroy();
                workOrderStatusChartInstance = null;
            }

            if (chartData) {
                metricsContainer.innerHTML = `
                    <div class="metric"><div class="value">${metrics.open}</div><div class="label">Open</div></div>
                    <div class="metric"><div class="value">${metrics.inProgress}</div><div class="label">In Progress</div></div>
                    <div class="metric"><div class="value">${metrics.closed}</div><div class="label">Closed</div></div>
                    <div class="metric"><div class="value">${metrics.avgCompletionTime}</div><div class="label">Avg. Close Time</div></div>
                `;
                
                workOrderStatusChartInstance = new Chart(chartCanvas, {
                    type: 'doughnut',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'top' } }
                    }
                });
                noDataMsg.style.display = 'none';
                chartContainer.style.display = 'block';
            } else {
                noDataMsg.style.display = 'block';
                chartContainer.style.display = 'none';
            }
        }

        async function generatePredictiveAlertsAndSuggestions() {
            const assetsRef = commonDependencies.fbRef(pageDatabase, `fixedAssets/${pageCurrentUserId}`);
            const snapshot = await commonDependencies.fbGet(assetsRef);
            const assets = snapshot.val();
            
            let alerts = [];
            let suggestions = [];

            if (assets) {
                for (const assetId in assets) {
                    const asset = assets[assetId];
                    if(!asset.purchaseDate || !asset.assetName) continue;

                    const purchaseDate = new Date(asset.purchaseDate);
                    const ageInYears = (new Date() - purchaseDate) / (1000 * 60 * 60 * 24 * 365.25);
                    const propertyName = localPropertiesMap[asset.propertyId] || 'Unknown Property';

                    let alertMessage = null;
                    let alertType = 'warning';
                    
                    if (asset.assetName.toLowerCase().includes('hvac') && ageInYears > 5) {
                        alertMessage = `HVAC unit "${asset.assetName}" at ${propertyName} is over 5 years old. Recommend inspection.`;
                    } else if (asset.assetName.toLowerCase().includes('water heater') && ageInYears > 8) {
                        alertMessage = `Water heater "${asset.assetName}" at ${propertyName} is over 8 years old. High risk of failure.`;
                        alertType = 'critical';
                    } else if (asset.assetName.toLowerCase().includes('roof') && ageInYears > 15) {
                         alertMessage = `Roof "${asset.assetName}" at ${propertyName} is over 15 years old. Recommend professional inspection.`;
                         alertType = 'critical';
                    }
                    
                    if (alertMessage) {
                        const alertTitle = assetTypeToTitle(asset.assetName);
                        alerts.push({ title: alertTitle, message: alertMessage, type: alertType });
                        suggestions.push({
                            text: `Preventive maintenance for ${asset.assetName} at ${propertyName}.`,
                            wo: {
                                title: `Preventive Check: ${asset.assetName}`,
                                propertyId: asset.propertyId,
                                description: `Generated from smart alert: ${alertMessage}`
                            }
                        });
                    }
                }
            }
            return [alerts, suggestions];
        }

        function assetTypeToTitle(assetName) {
            const name = assetName.toLowerCase();
            if (name.includes('hvac')) return 'HVAC System Alert';
            if (name.includes('water heater')) return 'Water Heater Alert';
            if (name.includes('roof')) return 'Roofing Alert';
            return 'Asset Maintenance Alert';
        }

        async function loadIotDeviceData() {
            const iotDevicesRef = commonDependencies.fbRef(pageDatabase, `iotDevices/${pageCurrentUserId}`);
            const snapshot = await commonDependencies.fbGet(iotDevicesRef);
            const iotData = snapshot.val();
            
            let devices = [];
            if (iotData) {
                devices = Object.keys(iotData).map(key => ({ id: key, ...iotData[key] }));
            }

            let online = 0, offline = 0, lowBattery = 0;
            devices.forEach(d => {
                if (d.status === 'online') {
                    online++;
                } else {
                    offline++;
                }
                if (d.battery !== null && typeof d.battery === 'number' && d.battery < 20) {
                    lowBattery++;
                }
            });

            const summary = { total: devices.length, online, offline, lowBattery };
            return [summary, devices];
        }

        async function generateMaintenanceScorecards() {
            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);
            const snapshot = await commonDependencies.fbGet(workOrdersRef);
            const workOrders = snapshot.val();
            
            if (!workOrders || Object.keys(workOrders).length === 0) {
                return [null, null];
            }

            let statusCounts = { 'Open': 0, 'In Progress': 0, 'Closed': 0 };
            let totalCompletionTime = 0;
            let closedCount = 0;

            for (const id in workOrders) {
                const wo = workOrders[id];
                if (statusCounts.hasOwnProperty(wo.status)) {
                    statusCounts[wo.status]++;
                }
                if (wo.status === 'Closed' && wo.createdAt && wo.updatedAt) {
                    const completionTime = wo.updatedAt - wo.createdAt;
                    if (completionTime > 0) {
                        totalCompletionTime += completionTime;
                        closedCount++;
                    }
                }
            }

            let avgCompletionDays = 'N/A';
            if (closedCount > 0) {
                const avgMs = totalCompletionTime / closedCount;
                const days = avgMs / (1000 * 60 * 60 * 24);
                avgCompletionDays = days > 1 ? `${days.toFixed(1)}d` : `${(days * 24).toFixed(1)}h`;
            }

            const metrics = {
                open: statusCounts['Open'],
                inProgress: statusCounts['In Progress'],
                closed: statusCounts['Closed'],
                avgCompletionTime: avgCompletionDays
            };
            
            const chartData = {
                labels: ['Open', 'In Progress', 'Closed'],
                datasets: [{
                    label: 'Work Order Statuses',
                    data: [statusCounts['Open'], statusCounts['In Progress'], statusCounts['Closed']],
                    backgroundColor: ['#f6ad55', '#4299e1', '#68d391'],
                    hoverOffset: 4
                }]
            };

            return [metrics, chartData];
        }


        // --- Vendors Listener ---
        function initializeVendorsListener() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const vendorsRef = commonDependencies.fbRef(pageDatabase, `vendors/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(vendorsRef, commonDependencies.fbOrderByChild('companyName')), (snapshot) => {
                // Purchase Order Modal Vendor Dropdown
                const poVendorSelect = pageDOMElements.purchaseOrderForm?.elements.vendorId;
                if (poVendorSelect) {
                    const currentVal = poVendorSelect.value;
                    poVendorSelect.innerHTML = '<option value="">Select Vendor</option>';
                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const vendor = childSnapshot.val();
                        if (vendor && vendor.companyName) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = vendor.companyName;
                            poVendorSelect.appendChild(option);
                        }
                    });
                    poVendorSelect.value = currentVal; // Restore selection if possible
                }
                // Recurring Work Order Modal Assigned Vendor Dropdown
                const recurringVendorSelect = pageDOMElements.recurringWorkOrderForm?.elements.assignedVendorId;
                if (recurringVendorSelect) {
                    const currentVal = recurringVendorSelect.value;
                    recurringVendorSelect.innerHTML = '<option value="">Select Vendor (Optional)</option>';
                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const vendor = childSnapshot.val();
                        if (vendor && vendor.companyName) {
                            const option = document.createElement('option');
                            option.value = key;
                            option.textContent = vendor.companyName;
                            recurringVendorSelect.appendChild(option);
                        }
                    });
                    recurringVendorSelect.value = currentVal;
                }
            });
        }

        // --- Maintenance Filters Listener ---
        function initializeMaintenanceFilters() {
            // Set up filter and sort dropdowns for Work Orders
            const filterPropertyDropdown = pageDOMElements.filterProperty;
            const filterPriorityDropdown = pageDOMElements.filterPriority;
            const filterStatusDropdown = pageDOMElements.filterStatus;
            const sortByDropdown = pageDOMElements.sortBy;
            const sortOrderDropdown = pageDOMElements.sortOrder;

            // Helper to reload work orders with new filters
            function reloadWorkOrdersWithFilters() {
                // Update global filter/sort variables if they exist
                if (typeof workOrderFilters !== 'undefined') {
                    workOrderFilters.propertyId = filterPropertyDropdown?.dataset.value || '';
                    workOrderFilters.priority = filterPriorityDropdown?.dataset.value || '';
                    workOrderFilters.status = filterStatusDropdown?.dataset.value || '';
                }
                if (typeof workOrderSort !== 'undefined') {
                    workOrderSort.by = sortByDropdown?.dataset.value || 'createdAt';
                    workOrderSort.order = sortOrderDropdown?.dataset.value || 'desc';
                }
                if (typeof loadWorkOrders === 'function') loadWorkOrders();
            }

            // Initialize dropdowns with custom handler
            if (filterPropertyDropdown) initializeSimpleDropdown(filterPropertyDropdown, reloadWorkOrdersWithFilters);
            if (filterPriorityDropdown) initializeSimpleDropdown(filterPriorityDropdown, reloadWorkOrdersWithFilters);
            if (filterStatusDropdown) initializeSimpleDropdown(filterStatusDropdown, reloadWorkOrdersWithFilters);
            if (sortByDropdown) initializeSimpleDropdown(sortByDropdown, reloadWorkOrdersWithFilters);
            if (sortOrderDropdown) initializeSimpleDropdown(sortOrderDropdown, reloadWorkOrdersWithFilters);
        }

        // --- Setup All Event Listeners ---
        function setupEventListeners() {
            setupWorkOrderEventListeners();
            setupRecurringWorkOrderEventListeners();
            setupInspectionEventListeners();
            setupUnitTurnEventListeners();
            setupProjectEventListeners();
            setupPurchaseOrderEventListeners();
            setupInventoryEventListeners();
            setupFixedAssetEventListeners();
        }
    </script>
</body>
</html> 