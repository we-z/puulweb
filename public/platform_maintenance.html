<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maintenance - Puul Platform</title>
    <link rel="stylesheet" href="/css/platform_common.css">
    <style>
        /* Tab-like navigation for subsections */
        .sub-nav {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }
        .sub-nav-item {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px; /* Align with parent border */
            font-weight: 500;
            color: #555;
            transition: color 0.2s ease, border-bottom-color 0.2s ease;
        }
        .sub-nav-item:hover {
            color: #000;
        }
        .sub-nav-item.active {
            color: #000;
            border-bottom-color: #000; /* Or your primary accent color */
        }
        .subsection-content {
            display: none;
        }
        .subsection-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="sidebar-container"></div>

    <div class="main-content">
        <div id="maintenanceView">
            <div class="content-header">
                <h2>Maintenance</h2>
            </div>
            <div class="page-container">
                <div class="sub-nav" id="maintenanceSubNav">
                    <div class="sub-nav-item active" data-subsection="workOrders">Work Orders</div>
                    <div class="sub-nav-item" data-subsection="recurringWorkOrders">Recurring Work Orders</div>
                    <div class="sub-nav-item" data-subsection="inspections">Inspections</div>
                    <div class="sub-nav-item" data-subsection="unitTurns">Unit Turns</div>
                    <div class="sub-nav-item" data-subsection="projects">Projects</div>
                    <div class="sub-nav-item" data-subsection="purchaseOrders">Purchase Orders</div>
                    <div class="sub-nav-item" data-subsection="inventory">Inventory</div>
                    <div class="sub-nav-item" data-subsection="fixedAssets">Fixed Assets</div>
                    <div class="sub-nav-item" data-subsection="smartMaintenance">Smart Maintenance</div>
                </div>

                <!-- Work Orders Subsection -->
                <div class="subsection-content active" id="workOrdersContent">
                    <button class="controls-toggle-btn" id="controlsToggleBtn">
                        <span>Filters & Sort</span>
                        <svg class="arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="controls-container" style="margin-bottom: 20px; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                        <div class="filter-group">
                            <label for="filterProperty">Property:</label>
                            <div class="custom-dropdown" id="customFilterProperty">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Properties</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Properties</div>
                                </div>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label for="filterPriority">Priority:</label>
                            <div class="custom-dropdown" id="customFilterPriority">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Priorities</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Priorities</div>
                                    <div class="dropdown-option" data-value="Low">Low</div>
                                    <div class="dropdown-option" data-value="Medium">Medium</div>
                                    <div class="dropdown-option" data-value="High">High</div>
                                </div>
                            </div>
                        </div>
                         <div class="filter-group">
                            <label for="filterStatus">Status:</label>
                            <div class="custom-dropdown" id="customFilterStatus">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">All Statuses</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option" data-value="">All Statuses</div>
                                    <div class="dropdown-option" data-value="Open">Open</div>
                                    <div class="dropdown-option" data-value="In Progress">In Progress</div>
                                    <div class="dropdown-option" data-value="Closed">Closed</div>
                                </div>
                            </div>
                        </div>
                        <div class="sort-group">
                            <label for="sortBy">Sort by:</label>
                            <div class="custom-dropdown" id="customSortBy">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Date Created</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="createdAt">Date Created</div>
                                    <div class="dropdown-option" data-value="title">Title</div>
                                    <div class="dropdown-option" data-value="status">Status</div>
                                    <div class="dropdown-option" data-value="priority">Priority</div>
                                </div>
                            </div>
                            <div class="custom-dropdown" id="customSortOrder">
                                <div class="dropdown-selected" tabindex="0">
                                    <span class="selected-value">Descending</span>
                                    <svg class="dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                </div>
                                <div class="dropdown-options">
                                    <div class="dropdown-option selected" data-value="desc">Descending</div>
                                    <div class="dropdown-option" data-value="asc">Ascending</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="data-table-container work-order-table-container">
                        <table class="data-table" id="workOrderTable">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Property</th>
                                    <th>Status</th>
                                    <th>Priority</th>
                                    <th>Created At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="workOrderTableBody">
                            </tbody>
                        </table>
                        <div id="noWorkOrdersMessage" class="no-data-message" style="display: none;">
                            <div class="icon">üìù</div>
                            <p>No work orders yet.</p>
                            <span>Click the '+' button to add your first one!</span>
                        </div>
                    </div>
                </div>

                <!-- Recurring Work Orders Subsection -->
                <div class="subsection-content" id="recurringWorkOrdersContent">
                    <h4>Recurring Work Orders</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="recurringWorkOrderTable">
                            <thead>
                                <tr>
                                    <th>Task Name</th>
                                    <th>Property</th>
                                    <th>Frequency</th>
                                    <th>Next Due Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recurringWorkOrderTableBody">
                                <!-- Rows will be populated by JS -->
                            </tbody>
                        </table>
                        <div id="noRecurringWorkOrdersMessage" class="no-data-message">
                            <div class="icon">üîÑ</div>
                            <p>No recurring work orders set up yet.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Inspections Subsection -->
                <div class="subsection-content" id="inspectionsContent">
                    <h4>Inspections</h4>
                     <div class="data-table-container">
                        <table class="data-table" id="inspectionsTable">
                            <thead>
                                <tr>
                                    <th>Inspection Name/ID</th>
                                    <th>Property</th>
                                    <th>Date Scheduled</th>
                                    <th>Inspector</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inspectionsTableBody"></tbody>
                        </table>
                        <div id="noInspectionsMessage" class="no-data-message">
                            <div class="icon">üßê</div>
                            <p>No inspections scheduled or recorded.</p>
                        </div>
                    </div>
                </div>

                <!-- Unit Turns Subsection -->
                <div class="subsection-content" id="unitTurnsContent">
                     <h4>Unit Turns</h4>
                     <div class="data-table-container">
                        <table class="data-table" id="unitTurnsTable">
                            <thead>
                                <tr>
                                    <th>Unit/Property</th>
                                    <th>Move-Out Date</th>
                                    <th>Target Move-In Date</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unitTurnsTableBody"></tbody>
                        </table>
                        <div id="noUnitTurnsMessage" class="no-data-message">
                            <div class="icon">üì¶</div>
                            <p>No unit turns in progress.</p>
                        </div>
                    </div>
                </div>

                <!-- Projects Subsection -->
                <div class="subsection-content" id="projectsContent">
                    <h4>Projects</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="projectsTable">
                            <thead>
                                <tr>
                                    <th>Project Name</th>
                                    <th>Property</th>
                                    <th>Start Date</th>
                                    <th>End Date (Est.)</th>
                                    <th>Budget</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="projectsTableBody"></tbody>
                        </table>
                        <div id="noProjectsMessage" class="no-data-message">
                            <div class="icon">üèóÔ∏è</div>
                            <p>No projects currently tracked.</p>
                        </div>
                    </div>
                </div>

                <!-- Purchase Orders Subsection -->
                <div class="subsection-content" id="purchaseOrdersContent">
                    <h4>Purchase Orders</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="purchaseOrdersTable">
                            <thead>
                                <tr>
                                    <th>PO Number</th>
                                    <th>Vendor</th>
                                    <th>Order Date</th>
                                    <th>Total Amount</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="purchaseOrdersTableBody"></tbody>
                        </table>
                        <div id="noPurchaseOrdersMessage" class="no-data-message">
                            <div class="icon">üõí</div>
                            <p>No purchase orders found.</p>
                        </div>
                    </div>
                </div>

                <!-- Inventory Subsection -->
                <div class="subsection-content" id="inventoryContent">
                    <h4>Inventory</h4>
                    <div class="data-table-container">
                        <table class="data-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>SKU/ID</th>
                                    <th>Category</th>
                                    <th>Quantity on Hand</th>
                                    <th>Location</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody"></tbody>
                        </table>
                        <div id="noInventoryMessage" class="no-data-message">
                            <div class="icon">üî©</div>
                            <p>No inventory items tracked.</p>
                        </div>
                    </div>
                </div>

                <!-- Fixed Assets Subsection -->
                <div class="subsection-content" id="fixedAssetsContent">
                    <h4>Fixed Assets</h4>
                     <div class="data-table-container">
                        <table class="data-table" id="fixedAssetsTable">
                            <thead>
                                <tr>
                                    <th>Asset Name</th>
                                    <th>Asset ID</th>
                                    <th>Property</th>
                                    <th>Purchase Date</th>
                                    <th>Purchase Cost</th>
                                    <th>Current Value</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fixedAssetsTableBody"></tbody>
                        </table>
                        <div id="noFixedAssetsMessage" class="no-data-message">
                            <div class="icon">üì†</div>
                            <p>No fixed assets recorded.</p>
                        </div>
                    </div>
                </div>

                <!-- Smart Maintenance Subsection -->
                <div class="subsection-content" id="smartMaintenanceContent">
                    <h4>Smart Maintenance</h4>
                    <div class="no-data-message"> <!-- Using no-data-message for placeholder -->
                        <div class="icon">üí°</div>
                        <p>Smart Maintenance features coming soon.</p>
                        <span>This section will provide AI-driven insights and proactive maintenance suggestions.</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab" id="addItemBtn" aria-label="Add new item">
        +
    </button>

    <!-- Modal for Adding/Editing Work Orders -->
    <div id="workOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="workOrderModalTitle">Add New Work Order</h3>
                <button class="close-btn" data-modal-id="workOrderModal">&times;</button>
            </div>
            <form id="workOrderForm">
                <input type="hidden" id="workOrderId" name="workOrderId">
                <div class="form-group">
                    <label for="workOrderTitleInput">Title</label>
                    <input type="text" id="workOrderTitleInput" name="title" required placeholder="e.g., Leaky faucet in master bathroom">
                </div>
                <div class="form-group">
                    <label for="workOrderPropertySelect">Property</label>
                    <select id="workOrderPropertySelect" name="propertyId">
                        <option value="">Select Property (Optional)</option>
                        <!-- Property options will be populated here by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="workOrderDescription">Description</label>
                    <textarea id="workOrderDescription" name="description" rows="3" required placeholder="Details about the work order..."></textarea>
                </div>
                <div class="form-group">
                    <label for="workOrderStatus">Status</label>
                    <select id="workOrderStatus" name="status">
                        <option value="Open">Open</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="workOrderPriority">Priority</label>
                    <select id="workOrderPriority" name="priority">
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="cancel-btn" data-modal-id="workOrderModal">Cancel</button>
                    <button type="submit" class="submit-btn">Save Work Order</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Placeholder Modals for other subsections (simplified) -->
    <!-- Recurring Work Order Modal -->
    <div id="recurringWorkOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Recurring Work Order</h3><button class="close-btn" data-modal-id="recurringWorkOrderModal">&times;</button></div>
            <form id="recurringWorkOrderForm">
                <input type="hidden" id="recurringWorkOrderId">
                <div class="form-group"><label>Task Name</label><input type="text" name="taskName" required></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Frequency</label><select name="frequency"><option>Daily</option><option>Weekly</option><option>Monthly</option><option>Annually</option></select></div>
                <div class="form-group"><label>Start Date</label><input type="date" name="startDate"></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="recurringWorkOrderModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>

    <!-- Inspection Modal -->
    <div id="inspectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Inspection</h3><button class="close-btn" data-modal-id="inspectionModal">&times;</button></div>
            <form id="inspectionForm">
                 <input type="hidden" id="inspectionId">
                <div class="form-group"><label>Inspection Name</label><input type="text" name="inspectionName" required></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Date Scheduled</label><input type="datetime-local" name="scheduledDate"></div>
                <div class="form-group"><label>Inspector</label><input type="text" name="inspector"></div>
                <div class="form-group"><label>Status</label><select name="status"><option>Scheduled</option><option>In Progress</option><option>Completed</option><option>Cancelled</option></select></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="inspectionModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- Unit Turn Modal -->
    <div id="unitTurnModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Unit Turn</h3><button class="close-btn" data-modal-id="unitTurnModal">&times;</button></div>
            <form id="unitTurnForm">
                <input type="hidden" id="unitTurnId">
                <div class="form-group"><label>Unit/Property</label><select name="propertyId" required></select></div>
                <div class="form-group"><label>Move-Out Date</label><input type="date" name="moveOutDate"></div>
                <div class="form-group"><label>Target Move-In Date</label><input type="date" name="targetMoveInDate"></div>
                <div class="form-group"><label>Status</label><select name="status"><option>Pending</option><option>Cleaning</option><option>Repairs</option><option>Ready</option><option>Completed</option></select></div>
                <div class="form-group"><label>Assigned To</label><input type="text" name="assignedTo"></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="unitTurnModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Project</h3><button class="close-btn" data-modal-id="projectModal">&times;</button></div>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group"><label>Project Name</label><input type="text" name="projectName" required></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Start Date</label><input type="date" name="startDate"></div>
                <div class="form-group"><label>Estimated End Date</label><input type="date" name="endDate"></div>
                <div class="form-group"><label>Budget ($)</label><input type="number" name="budget" step="0.01"></div>
                <div class="form-group"><label>Status</label><select name="status"><option>Planning</option><option>In Progress</option><option>On Hold</option><option>Completed</option><option>Cancelled</option></select></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="projectModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- Purchase Order Modal -->
    <div id="purchaseOrderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Purchase Order</h3><button class="close-btn" data-modal-id="purchaseOrderModal">&times;</button></div>
            <form id="purchaseOrderForm">
                <input type="hidden" id="purchaseOrderId">
                <div class="form-group"><label>PO Number</label><input type="text" name="poNumber" required></div>
                <div class="form-group"><label>Vendor</label><select name="vendorId"></select></div>
                <div class="form-group"><label>Order Date</label><input type="date" name="orderDate"></div>
                <div class="form-group"><label>Total Amount ($)</label><input type="number" name="totalAmount" step="0.01"></div>
                 <div class="form-group"><label>Status</label><select name="status"><option>Draft</option><option>Submitted</option><option>Approved</option><option>Received</option><option>Closed</option></select></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="purchaseOrderModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Inventory Item</h3><button class="close-btn" data-modal-id="inventoryModal">&times;</button></div>
            <form id="inventoryForm">
                <input type="hidden" id="inventoryItemId">
                <div class="form-group"><label>Item Name</label><input type="text" name="itemName" required></div>
                <div class="form-group"><label>SKU/ID</label><input type="text" name="sku"></div>
                <div class="form-group"><label>Category</label><input type="text" name="category"></div>
                <div class="form-group"><label>Quantity on Hand</label><input type="number" name="quantity" step="1"></div>
                <div class="form-group"><label>Location</label><input type="text" name="location"></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="inventoryModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>
    
    <!-- Fixed Asset Modal -->
    <div id="fixedAssetModal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><h3>Add/Edit Fixed Asset</h3><button class="close-btn" data-modal-id="fixedAssetModal">&times;</button></div>
            <form id="fixedAssetForm">
                 <input type="hidden" id="fixedAssetId">
                <div class="form-group"><label>Asset Name</label><input type="text" name="assetName" required></div>
                <div class="form-group"><label>Asset ID</label><input type="text" name="assetId"></div>
                <div class="form-group"><label>Property</label><select name="propertyId"></select></div>
                <div class="form-group"><label>Purchase Date</label><input type="date" name="purchaseDate"></div>
                <div class="form-group"><label>Purchase Cost ($)</label><input type="number" name="purchaseCost" step="0.01"></div>
                <div class="form-group"><label>Notes</label><textarea name="notes"></textarea></div>
                <div class="form-actions"><button type="button" class="cancel-btn" data-modal-id="fixedAssetModal">Cancel</button><button type="submit" class="submit-btn">Save</button></div>
            </form>
        </div>
    </div>


    <!-- Custom Alert Toast Structure -->
    <div id="customAlertModal">
        <div class="custom-alert">
            <p>This is an alert message.</p>
        </div>
    </div>

    <!-- Common Confirm Modal -->
    <div id="customConfirmModal" class="modal">
        <div class="modal-content confirm-modal-content">
            <div class="modal-header">
                <h3 id="customConfirmTitle">Confirm Action</h3>
                 <button class="close-btn" data-modal-id="customConfirmModal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="customConfirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="cancel-btn-confirm" id="customConfirmCancel">Cancel</button>
                <button class="confirm-btn" id="customConfirmOk">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeAuth, showAlert, showConfirm, editIconSVG, deleteIconSVG, getDbData, updateDbData, initializeCustomDropdown } from './js/platform_common.js';
        import { getDatabase, ref, push, onValue, set, remove, serverTimestamp, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        let pageCurrentUserId;
        let pageDatabase;
        let localPropertiesMap = {}; // For mapping property IDs to names for this page
        let commonDependencies = {}; // To store common functions, icons, and Firebase utils

        // Cache DOM elements for each subsection for efficiency
        const pageDOMElements = {
            addItemBtn: document.getElementById('addItemBtn'),
            // Work Orders
            workOrderModal: document.getElementById('workOrderModal'),
            workOrderModalTitle: document.getElementById('workOrderModalTitle'),
            workOrderForm: document.getElementById('workOrderForm'),
            workOrderIdInput: document.getElementById('workOrderId'),
            workOrderTitleInput: document.getElementById('workOrderTitleInput'),
            workOrderPropertySelect: document.getElementById('workOrderPropertySelect'),
            workOrderDescription: document.getElementById('workOrderDescription'), 
            workOrderStatus: document.getElementById('workOrderStatus'),
            workOrderPriority: document.getElementById('workOrderPriority'),
            workOrderTableBody: document.getElementById('workOrderTableBody'),
            noWorkOrdersMessage: document.getElementById('noWorkOrdersMessage'),
            filterProperty: document.getElementById('customFilterProperty'),
            filterPriority: document.getElementById('customFilterPriority'),
            filterStatus: document.getElementById('customFilterStatus'),
            sortBy: document.getElementById('customSortBy'),
            sortOrder: document.getElementById('customSortOrder'),
            controlsToggleBtn: document.getElementById('controlsToggleBtn'),
            controlsContainer: document.querySelector('#workOrdersContent .controls-container'),
            // Other subsections will have their elements added here
            recurringWorkOrderTableBody: document.getElementById('recurringWorkOrderTableBody'),
            noRecurringWorkOrdersMessage: document.getElementById('noRecurringWorkOrdersMessage'),
            recurringWorkOrderModal: document.getElementById('recurringWorkOrderModal'),
            recurringWorkOrderForm: document.getElementById('recurringWorkOrderForm'),

            inspectionsTableBody: document.getElementById('inspectionsTableBody'),
            noInspectionsMessage: document.getElementById('noInspectionsMessage'),
            inspectionModal: document.getElementById('inspectionModal'),
            inspectionForm: document.getElementById('inspectionForm'),

            unitTurnsTableBody: document.getElementById('unitTurnsTableBody'),
            noUnitTurnsMessage: document.getElementById('noUnitTurnsMessage'),
            unitTurnModal: document.getElementById('unitTurnModal'),
            unitTurnForm: document.getElementById('unitTurnForm'),

            projectsTableBody: document.getElementById('projectsTableBody'),
            noProjectsMessage: document.getElementById('noProjectsMessage'),
            projectModal: document.getElementById('projectModal'),
            projectForm: document.getElementById('projectForm'),

            purchaseOrdersTableBody: document.getElementById('purchaseOrdersTableBody'),
            noPurchaseOrdersMessage: document.getElementById('noPurchaseOrdersMessage'),
            purchaseOrderModal: document.getElementById('purchaseOrderModal'),
            purchaseOrderForm: document.getElementById('purchaseOrderForm'),

            inventoryTableBody: document.getElementById('inventoryTableBody'),
            noInventoryMessage: document.getElementById('noInventoryMessage'),
            inventoryModal: document.getElementById('inventoryModal'),
            inventoryForm: document.getElementById('inventoryForm'),

            fixedAssetsTableBody: document.getElementById('fixedAssetsTableBody'),
            noFixedAssetsMessage: document.getElementById('noFixedAssetsMessage'),
            fixedAssetModal: document.getElementById('fixedAssetModal'),
            fixedAssetForm: document.getElementById('fixedAssetForm'),
        };
        
        function pageInit(userId, db, fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon, commonInitializeCustomDropdown) {
            pageCurrentUserId = userId;
            pageDatabase = db;
             commonDependencies = {
                fbRef, fbPush, fbSet, fbRemove, fbServerTimestamp, fbQuery, 
                fbOrderByChild, fbEqualTo, fbGetDbData, fbUpdateDbData, 
                commonShowAlert, commonShowConfirm, commonEditIcon, commonDeleteIcon,
                initializeCustomDropdown: commonInitializeCustomDropdown
            };

            initializeSubNav();
            initializePropertiesListener(); // For dropdowns in modals/filters
            
            // Initialize Work Orders section (active by default)
            loadWorkOrders(); 
            setupWorkOrderEventListeners();
            commonDependencies.initializeCustomDropdown(pageDOMElements.filterProperty, loadWorkOrders, true); // true for dynamic options
            commonDependencies.initializeCustomDropdown(pageDOMElements.filterPriority, loadWorkOrders);
            commonDependencies.initializeCustomDropdown(pageDOMElements.filterStatus, loadWorkOrders);
            commonDependencies.initializeCustomDropdown(pageDOMElements.sortBy, loadWorkOrders);
            commonDependencies.initializeCustomDropdown(pageDOMElements.sortOrder, loadWorkOrders);
            if (pageDOMElements.controlsToggleBtn && pageDOMElements.controlsContainer) {
                pageDOMElements.controlsToggleBtn.addEventListener('click', () => {
                    pageDOMElements.controlsContainer.classList.toggle('expanded');
                    pageDOMElements.controlsToggleBtn.classList.toggle('expanded');
                });
            }
            
            // Load other subsections (they are hidden by default)
            loadRecurringWorkOrders();
            setupRecurringWorkOrderEventListeners();
            loadInspections();
            setupInspectionEventListeners();
            loadUnitTurns();
            setupUnitTurnEventListeners();
            loadProjects();
            setupProjectEventListeners();
            loadPurchaseOrders();
            setupPurchaseOrderEventListeners();
            loadInventory();
            setupInventoryEventListeners();
            loadFixedAssets();
            setupFixedAssetEventListeners();


            // Central FAB click handler
            if (pageDOMElements.addItemBtn) {
                pageDOMElements.addItemBtn.addEventListener('click', () => {
                    const activeSubSection = document.querySelector('.sub-nav-item.active').dataset.subsection;
                    openModalForSubsection(activeSubSection);
                });
            }
        }

        function initializeSubNav() {
            const subNavContainer = document.getElementById('maintenanceSubNav');
            const subsections = document.querySelectorAll('.subsection-content');
            const subNavItems = subNavContainer.querySelectorAll('.sub-nav-item');

            subNavItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Update active tab
                    subNavItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');

                    // Update active content
                    const targetSubsectionId = item.dataset.subsection + "Content";
                    subsections.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === targetSubsectionId) {
                            content.classList.add('active');
                        }
                    });
                    // Show/hide FAB based on subsection if needed, or change its context
                    const fab = pageDOMElements.addItemBtn;
                    if (item.dataset.subsection === "smartMaintenance") { // Example: hide FAB for Smart Maintenance
                        fab.style.display = 'none';
                    } else {
                        fab.style.display = 'flex';
                    }
                });
            });
        }

        function openModalForSubsection(subsection, id = null, data = {}) {
            switch (subsection) {
                case 'workOrders':
                    openWorkOrderModal(id, data);
                    break;
                case 'recurringWorkOrders':
                    openRecurringWorkOrderModal(id, data);
                    break;
                case 'inspections':
                    openInspectionModal(id,data);
                    break;
                case 'unitTurns':
                    openUnitTurnModal(id, data);
                    break;
                case 'projects':
                    openProjectModal(id, data);
                    break;
                case 'purchaseOrders':
                    openPurchaseOrderModal(id,data);
                    break;
                case 'inventory':
                    openInventoryModal(id,data);
                    break;
                case 'fixedAssets':
                    openFixedAssetModal(id,data);
                    break;
                // Add other cases as needed
            }
        }
        
        function initializePropertiesListener() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const propertiesRef = commonDependencies.fbRef(pageDatabase, `properties/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(propertiesRef, commonDependencies.fbOrderByChild('address')), (snapshot) => {
                localPropertiesMap = {};
                
                // Populate Work Order Property Select
                if (pageDOMElements.workOrderPropertySelect) {
                    const currentWOPropertyValue = pageDOMElements.workOrderPropertySelect.value;
                    pageDOMElements.workOrderPropertySelect.innerHTML = '<option value="">Select Property (Optional)</option>';
                     snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const prop = childSnapshot.val();
                        if (prop && prop.address) {
                            localPropertiesMap[key] = prop.address;
                            const modalOption = document.createElement('option');
                            modalOption.value = key;
                            modalOption.textContent = prop.address;
                            pageDOMElements.workOrderPropertySelect.appendChild(modalOption);
                        }
                    });
                    pageDOMElements.workOrderPropertySelect.value = currentWOPropertyValue; // Restore selection
                }

                // Populate Filter Property Dropdown (for Work Orders)
                const filterPropertyDropdown = pageDOMElements.filterProperty;
                if (filterPropertyDropdown) {
                    const optionsContainer = filterPropertyDropdown.querySelector('.dropdown-options');
                    const selectedValueSpan = filterPropertyDropdown.querySelector('.selected-value');
                    const currentValue = filterPropertyDropdown.dataset.value; // Current filter value
                    optionsContainer.innerHTML = ''; 

                    const allOptionEl = document.createElement('div');
                    allOptionEl.classList.add('dropdown-option');
                    allOptionEl.dataset.value = '';
                    allOptionEl.textContent = 'All Properties';
                    optionsContainer.appendChild(allOptionEl);

                    snapshot.forEach(childSnapshot => {
                        const key = childSnapshot.key;
                        const prop = childSnapshot.val();
                        if (prop && prop.address) { // Already mapped in localPropertiesMap
                            const filterOptionEl = document.createElement('div');
                            filterOptionEl.classList.add('dropdown-option');
                            filterOptionEl.dataset.value = key;
                            filterOptionEl.textContent = prop.address;
                            optionsContainer.appendChild(filterOptionEl);
                        }
                    });
                    
                    // Reset selection for the filter dropdown
                    let newSelectedText = 'All Properties';
                    let newSelectedValue = '';
                    let foundCurrent = false;
                    optionsContainer.querySelectorAll('.dropdown-option').forEach(opt => {
                         opt.classList.remove('selected');
                        if (opt.dataset.value === currentValue) {
                            newSelectedText = opt.textContent;
                            newSelectedValue = opt.dataset.value;
                            opt.classList.add('selected');
                            foundCurrent = true;
                        }
                    });
                    if (!foundCurrent) { // If previous selection is no longer valid, default to "All Properties"
                        const defaultOpt = optionsContainer.querySelector('.dropdown-option[data-value=""]');
                        if (defaultOpt) defaultOpt.classList.add('selected');
                    } else {
                         //Ensure the currently selected option is marked, if it still exists
                        const currentOpt = optionsContainer.querySelector(`.dropdown-option[data-value="${currentValue}"]`);
                        if(currentOpt) currentOpt.classList.add('selected');
                    }

                    selectedValueSpan.textContent = newSelectedText;
                    filterPropertyDropdown.dataset.value = newSelectedValue;
                }

                // Populate property dropdowns in other modals
                const propertySelects = [
                    pageDOMElements.recurringWorkOrderForm?.elements.propertyId,
                    pageDOMElements.inspectionForm?.elements.propertyId,
                    pageDOMElements.unitTurnForm?.elements.propertyId,
                    pageDOMElements.projectForm?.elements.propertyId,
                    pageDOMElements.fixedAssetForm?.elements.propertyId
                    // Add other property selects here
                ];

                propertySelects.forEach(select => {
                    if (select) {
                        const currentVal = select.value;
                        select.innerHTML = '<option value="">Select Property</option>';
                         snapshot.forEach(childSnapshot => {
                            const key = childSnapshot.key;
                            const prop = childSnapshot.val();
                            if (prop && prop.address) {
                                const option = document.createElement('option');
                                option.value = key;
                                option.textContent = prop.address;
                                select.appendChild(option);
                            }
                        });
                        select.value = currentVal; // Restore selection if possible
                    }
                });
            });
        }
        
        // --- Work Orders Section Logic ---
        function setupWorkOrderEventListeners() {
            if (pageDOMElements.workOrderForm) {
                pageDOMElements.workOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!pageCurrentUserId) {
                        commonDependencies.commonShowAlert('User not authenticated.', 'Authentication Error');
                        return;
                    }
                    const title = pageDOMElements.workOrderTitleInput.value.trim();
                    const propertyId = pageDOMElements.workOrderPropertySelect.value;
                    const description = pageDOMElements.workOrderDescription.value.trim();
                    const status = pageDOMElements.workOrderStatus.value;
                    const priority = pageDOMElements.workOrderPriority.value;
                    const workOrderId = pageDOMElements.workOrderIdInput.value;

                    if (!title || !description) {
                        commonDependencies.commonShowAlert('Title and Description are required.', 'Validation Error');
                        return;
                    }

                    const workOrderData = {
                        title, description, status, priority,
                        userId: pageCurrentUserId,
                        propertyId: propertyId || null,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };

                    try {
                        if (workOrderId) { 
                            const workOrderRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/${workOrderId}`);
                            const snapshot = await commonDependencies.fbGetDbData(workOrderRef);
                            const existingData = snapshot.val() || {};                           
                            await commonDependencies.fbSet(workOrderRef, {...existingData, ...workOrderData, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp() });
                            commonDependencies.commonShowAlert('Work order updated successfully!');
                        } else { 
                            workOrderData.createdAt = commonDependencies.fbServerTimestamp();
                            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);
                            await commonDependencies.fbPush(workOrdersRef, workOrderData);
                            commonDependencies.commonShowAlert('Work order added successfully!');
                        }
                        if(pageDOMElements.workOrderModal) pageDOMElements.workOrderModal.style.display = 'none';
                        // loadWorkOrders(); // Data will be reloaded by onValue listener
                    } catch (error) {
                        console.error('Error saving work order:', error);
                        commonDependencies.commonShowAlert(`Error: ${error.message}`, 'Save Error');
                    }
                });
            }
        }

        function loadWorkOrders() { 
            if (!pageCurrentUserId || !pageDatabase) return;
            
            const filterPropertyValue = pageDOMElements.filterProperty ? pageDOMElements.filterProperty.dataset.value : '';
            const filterPriorityValue = pageDOMElements.filterPriority ? pageDOMElements.filterPriority.dataset.value : ''; 
            const filterStatusValue = pageDOMElements.filterStatus ? pageDOMElements.filterStatus.dataset.value : '';
            const sortByValue = pageDOMElements.sortBy ? pageDOMElements.sortBy.dataset.value : 'createdAt';
            const sortOrderValue = pageDOMElements.sortOrder ? pageDOMElements.sortOrder.dataset.value : 'desc';

            const workOrdersRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}`);
            onValue(commonDependencies.fbQuery(workOrdersRef, commonDependencies.fbOrderByChild('createdAt')), (snapshot) => {
                if(pageDOMElements.workOrderTableBody) pageDOMElements.workOrderTableBody.innerHTML = '';
                let workOrdersArray = [];
                const data = snapshot.val();
                
                if (data) {
                    for (const key in data) {
                        workOrdersArray.push({ id: key, ...data[key] });
                    }
                }

                if (filterPropertyValue) workOrdersArray = workOrdersArray.filter(wo => wo.propertyId === filterPropertyValue);
                if (filterPriorityValue) workOrdersArray = workOrdersArray.filter(wo => wo.priority === filterPriorityValue);
                if (filterStatusValue) workOrdersArray = workOrdersArray.filter(wo => wo.status === filterStatusValue);

                workOrdersArray.sort((a, b) => {
                    let valA = a[sortByValue];
                    let valB = b[sortByValue];
                    if (sortByValue === 'priority') {
                        const priorityOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
                        valA = priorityOrder[valA] || 0;
                        valB = priorityOrder[valB] || 0;
                    } else if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    let comparison = 0;
                    if (valA > valB) comparison = 1;
                    else if (valA < valB) comparison = -1;
                    return sortOrderValue === 'desc' ? comparison * -1 : comparison;
                });
                
                if (workOrdersArray.length > 0) {
                    if(pageDOMElements.noWorkOrdersMessage) pageDOMElements.noWorkOrdersMessage.style.display = 'none';
                    workOrdersArray.forEach(wo => populateWorkOrderRow(wo));
                } else {
                    if(pageDOMElements.noWorkOrdersMessage) pageDOMElements.noWorkOrdersMessage.style.display = 'block';
                }
            });
        }
        
        function populateWorkOrderRow(wo) {
            if(!pageDOMElements.workOrderTableBody) return;
            const row = pageDOMElements.workOrderTableBody.insertRow();
            row.setAttribute('data-id', wo.id);

            row.insertCell().textContent = wo.title || 'N/A';
            row.insertCell().textContent = wo.propertyId ? (localPropertiesMap[wo.propertyId] || 'Unknown Property') : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${(wo.status || 'N/A').toLowerCase().replace(' ', '-')}">${wo.status || 'N/A'}</span>`;
            row.insertCell().innerHTML = `<span class="priority-badge priority-${(wo.priority || 'N/A').toLowerCase()}">${wo.priority || 'N/A'}</span>`;
            row.insertCell().textContent = wo.createdAt ? new Date(wo.createdAt).toLocaleDateString() : 'N/A';

            const actionsCell = row.insertCell();
            actionsCell.classList.add('actions-cell');
            actionsCell.innerHTML = `<button class="edit-btn" title="Edit">${commonDependencies.commonEditIcon}</button><button class="delete-btn" title="Delete">${commonDependencies.commonDeleteIcon}</button>`;
            
            actionsCell.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openWorkOrderModal(wo.id, wo); });
            actionsCell.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteWorkOrder(wo.id); });
            row.addEventListener('click', () => openWorkOrderModal(wo.id, wo));
        }

        function openWorkOrderModal(id = null, data = {}) {
            if(!pageDOMElements.workOrderForm || !pageDOMElements.workOrderModal) return;
            pageDOMElements.workOrderForm.reset();
            pageDOMElements.workOrderIdInput.value = id || '';
            pageDOMElements.workOrderModalTitle.textContent = id ? 'Edit Work Order' : 'Add New Work Order';
            pageDOMElements.workOrderTitleInput.value = data.title || '';
            pageDOMElements.workOrderPropertySelect.value = data.propertyId || '';
            pageDOMElements.workOrderDescription.value = data.description || '';
            pageDOMElements.workOrderStatus.value = data.status || 'Open';
            pageDOMElements.workOrderPriority.value = data.priority || 'Medium';
            pageDOMElements.workOrderModal.style.display = 'flex';
        }

        async function handleDeleteWorkOrder(id) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await commonDependencies.commonShowConfirm('Are you sure you want to delete this work order?', 'Delete Work Order');
            if (confirmed) {
                try {
                    const workOrderRef = commonDependencies.fbRef(pageDatabase, `workOrders/${pageCurrentUserId}/${id}`);
                    await commonDependencies.fbRemove(workOrderRef);
                    commonDependencies.commonShowAlert('Work order deleted successfully!');
                } catch (error) {
                    console.error('Error deleting work order:', error);
                    commonDependencies.commonShowAlert(`Error: ${error.message}`, 'Delete Error');
                }
            }
        }

        // --- Recurring Work Orders Section Logic ---
        function setupRecurringWorkOrderEventListeners() {
            if (pageDOMElements.recurringWorkOrderForm) {
                pageDOMElements.recurringWorkOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.recurringWorkOrderId.value;
                    const data = {
                        taskName: form.taskName.value,
                        propertyId: form.propertyId.value,
                        frequency: form.frequency.value,
                        startDate: form.startDate.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.taskName || !data.propertyId || !data.frequency) {
                        commonDependencies.commonShowAlert('Task Name, Property, and Frequency are required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `recurringWorkOrders/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Recurring Work Order updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Recurring Work Order added.');
                        }
                        pageDOMElements.recurringWorkOrderModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadRecurringWorkOrders() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `recurringWorkOrders/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.recurringWorkOrderTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateRecurringWorkOrderRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noRecurringWorkOrdersMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateRecurringWorkOrderRow(data) {
            const row = pageDOMElements.recurringWorkOrderTableBody.insertRow();
            row.insertCell().textContent = data.taskName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.frequency;
            row.insertCell().textContent = data.startDate ? new Date(data.startDate).toLocaleDateString() : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-active">Active</span>`; // Placeholder status
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openRecurringWorkOrderModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('recurringWorkOrders', data.id, 'Recurring Work Order'));
             row.addEventListener('click', () => openRecurringWorkOrderModal(data.id, data));
        }
        
        function openRecurringWorkOrderModal(id = null, data = {}) {
            pageDOMElements.recurringWorkOrderForm.reset();
            pageDOMElements.recurringWorkOrderForm.recurringWorkOrderId.value = id || '';
            pageDOMElements.recurringWorkOrderForm.taskName.value = data.taskName || '';
            pageDOMElements.recurringWorkOrderForm.propertyId.value = data.propertyId || '';
            pageDOMElements.recurringWorkOrderForm.frequency.value = data.frequency || 'Monthly';
            pageDOMElements.recurringWorkOrderForm.startDate.value = data.startDate || '';
            pageDOMElements.recurringWorkOrderModal.style.display = 'flex';
        }

        // --- Inspections Section Logic ---
        function setupInspectionEventListeners() {
            if (pageDOMElements.inspectionForm) {
                pageDOMElements.inspectionForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.inspectionId.value;
                    const data = {
                        inspectionName: form.inspectionName.value,
                        propertyId: form.propertyId.value,
                        scheduledDate: form.scheduledDate.value,
                        inspector: form.inspector.value,
                        status: form.status.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.inspectionName || !data.propertyId || !data.scheduledDate) {
                         commonDependencies.commonShowAlert('Name, Property, and Scheduled Date are required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `inspections/${pageCurrentUserId}`;
                        if (id) {
                             const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Inspection updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Inspection added.');
                        }
                        pageDOMElements.inspectionModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadInspections() {
             if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `inspections/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.inspectionsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateInspectionRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noInspectionsMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateInspectionRow(data) {
            const row = pageDOMElements.inspectionsTableBody.insertRow();
            row.insertCell().textContent = data.inspectionName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.scheduledDate ? new Date(data.scheduledDate).toLocaleString() : 'N/A';
            row.insertCell().textContent = data.inspector || 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openInspectionModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('inspections', data.id, 'Inspection'));
            row.addEventListener('click', () => openInspectionModal(data.id, data));
        }

        function openInspectionModal(id = null, data = {}) {
            pageDOMElements.inspectionForm.reset();
            pageDOMElements.inspectionForm.inspectionId.value = id || '';
            pageDOMElements.inspectionForm.inspectionName.value = data.inspectionName || '';
            pageDOMElements.inspectionForm.propertyId.value = data.propertyId || '';
            pageDOMElements.inspectionForm.scheduledDate.value = data.scheduledDate || '';
            pageDOMElements.inspectionForm.inspector.value = data.inspector || '';
            pageDOMElements.inspectionForm.status.value = data.status || 'Scheduled';
            pageDOMElements.inspectionModal.style.display = 'flex';
        }


        // --- Unit Turns Section Logic ---
        function setupUnitTurnEventListeners() {
            if (pageDOMElements.unitTurnForm) {
                pageDOMElements.unitTurnForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.unitTurnId.value;
                    const data = {
                        propertyId: form.propertyId.value,
                        moveOutDate: form.moveOutDate.value,
                        targetMoveInDate: form.targetMoveInDate.value,
                        status: form.status.value,
                        assignedTo: form.assignedTo.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                     if (!data.propertyId) {
                         commonDependencies.commonShowAlert('Property is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `unitTurns/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Unit Turn updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Unit Turn added.');
                        }
                        pageDOMElements.unitTurnModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadUnitTurns() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `unitTurns/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.unitTurnsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateUnitTurnRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noUnitTurnsMessage.style.display = hasData ? 'none' : 'block';
            });
        }
        
        function populateUnitTurnRow(data) {
            const row = pageDOMElements.unitTurnsTableBody.insertRow();
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.moveOutDate ? new Date(data.moveOutDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.targetMoveInDate ? new Date(data.targetMoveInDate).toLocaleDateString() : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            row.insertCell().textContent = data.assignedTo || 'N/A';
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openUnitTurnModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('unitTurns', data.id, 'Unit Turn'));
            row.addEventListener('click', () => openUnitTurnModal(data.id, data));
        }

        function openUnitTurnModal(id = null, data = {}) {
            pageDOMElements.unitTurnForm.reset();
            pageDOMElements.unitTurnForm.unitTurnId.value = id || '';
            pageDOMElements.unitTurnForm.propertyId.value = data.propertyId || '';
            pageDOMElements.unitTurnForm.moveOutDate.value = data.moveOutDate || '';
            pageDOMElements.unitTurnForm.targetMoveInDate.value = data.targetMoveInDate || '';
            pageDOMElements.unitTurnForm.status.value = data.status || 'Pending';
            pageDOMElements.unitTurnForm.assignedTo.value = data.assignedTo || '';
            pageDOMElements.unitTurnModal.style.display = 'flex';
        }

        // --- Projects Section Logic ---
        function setupProjectEventListeners() {
             if (pageDOMElements.projectForm) {
                pageDOMElements.projectForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.projectId.value;
                    const data = {
                        projectName: form.projectName.value,
                        propertyId: form.propertyId.value,
                        startDate: form.startDate.value,
                        endDate: form.endDate.value,
                        budget: parseFloat(form.budget.value) || 0,
                        status: form.status.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.projectName) {
                         commonDependencies.commonShowAlert('Project Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `projects/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                             const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Project updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Project added.');
                        }
                        pageDOMElements.projectModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadProjects() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `projects/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.projectsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateProjectRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noProjectsMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateProjectRow(data) {
            const row = pageDOMElements.projectsTableBody.insertRow();
            row.insertCell().textContent = data.projectName;
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.startDate ? new Date(data.startDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.endDate ? new Date(data.endDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.budget ? `$${data.budget.toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openProjectModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('projects', data.id, 'Project'));
            row.addEventListener('click', () => openProjectModal(data.id, data));
        }

        function openProjectModal(id = null, data = {}) {
            pageDOMElements.projectForm.reset();
            pageDOMElements.projectForm.projectId.value = id || '';
            pageDOMElements.projectForm.projectName.value = data.projectName || '';
            pageDOMElements.projectForm.propertyId.value = data.propertyId || '';
            pageDOMElements.projectForm.startDate.value = data.startDate || '';
            pageDOMElements.projectForm.endDate.value = data.endDate || '';
            pageDOMElements.projectForm.budget.value = data.budget || '';
            pageDOMElements.projectForm.status.value = data.status || 'Planning';
            pageDOMElements.projectModal.style.display = 'flex';
        }

        // --- Purchase Orders Section Logic ---
        function setupPurchaseOrderEventListeners() {
            if (pageDOMElements.purchaseOrderForm) {
                pageDOMElements.purchaseOrderForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.purchaseOrderId.value;
                    const data = {
                        poNumber: form.poNumber.value,
                        vendorId: form.vendorId.value, // Assuming you'll have vendor management later
                        orderDate: form.orderDate.value,
                        totalAmount: parseFloat(form.totalAmount.value) || 0,
                        status: form.status.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                     if (!data.poNumber || !data.vendorId) {
                         commonDependencies.commonShowAlert('PO Number and Vendor are required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `purchaseOrders/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Purchase Order updated.');
                        } else {
                             data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Purchase Order added.');
                        }
                        pageDOMElements.purchaseOrderModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }
        
        function loadPurchaseOrders() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `purchaseOrders/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.purchaseOrdersTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populatePurchaseOrderRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noPurchaseOrdersMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populatePurchaseOrderRow(data) {
            const row = pageDOMElements.purchaseOrdersTableBody.insertRow();
            row.insertCell().textContent = data.poNumber;
            row.insertCell().textContent = data.vendorId || 'N/A'; // Replace with vendor name when available
            row.insertCell().textContent = data.orderDate ? new Date(data.orderDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.totalAmount ? `$${data.totalAmount.toFixed(2)}` : 'N/A';
            row.insertCell().innerHTML = `<span class="status-badge status-${data.status.toLowerCase().replace(' ', '-')}">${data.status}</span>`;
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openPurchaseOrderModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('purchaseOrders', data.id, 'Purchase Order'));
            row.addEventListener('click', () => openPurchaseOrderModal(data.id, data));
        }

        function openPurchaseOrderModal(id = null, data = {}) {
            pageDOMElements.purchaseOrderForm.reset();
            pageDOMElements.purchaseOrderForm.purchaseOrderId.value = id || '';
            pageDOMElements.purchaseOrderForm.poNumber.value = data.poNumber || '';
            pageDOMElements.purchaseOrderForm.vendorId.value = data.vendorId || '';
            pageDOMElements.purchaseOrderForm.orderDate.value = data.orderDate || '';
            pageDOMElements.purchaseOrderForm.totalAmount.value = data.totalAmount || '';
            pageDOMElements.purchaseOrderForm.status.value = data.status || 'Draft';
            pageDOMElements.purchaseOrderModal.style.display = 'flex';
        }

        // --- Inventory Section Logic ---
        function setupInventoryEventListeners() {
            if (pageDOMElements.inventoryForm) {
                pageDOMElements.inventoryForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.inventoryItemId.value;
                    const data = {
                        itemName: form.itemName.value,
                        sku: form.sku.value,
                        category: form.category.value,
                        quantity: parseInt(form.quantity.value) || 0,
                        location: form.location.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.itemName) {
                         commonDependencies.commonShowAlert('Item Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `inventory/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Inventory Item updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Inventory Item added.');
                        }
                        pageDOMElements.inventoryModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadInventory() {
             if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `inventory/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.inventoryTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateInventoryRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noInventoryMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateInventoryRow(data) {
            const row = pageDOMElements.inventoryTableBody.insertRow();
            row.insertCell().textContent = data.itemName;
            row.insertCell().textContent = data.sku || 'N/A';
            row.insertCell().textContent = data.category || 'N/A';
            row.insertCell().textContent = data.quantity;
            row.insertCell().textContent = data.location || 'N/A';
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openInventoryModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('inventory', data.id, 'Inventory Item'));
            row.addEventListener('click', () => openInventoryModal(data.id, data));
        }

        function openInventoryModal(id = null, data = {}) {
            pageDOMElements.inventoryForm.reset();
            pageDOMElements.inventoryForm.inventoryItemId.value = id || '';
            pageDOMElements.inventoryForm.itemName.value = data.itemName || '';
            pageDOMElements.inventoryForm.sku.value = data.sku || '';
            pageDOMElements.inventoryForm.category.value = data.category || '';
            pageDOMElements.inventoryForm.quantity.value = data.quantity || 0;
            pageDOMElements.inventoryForm.location.value = data.location || '';
            pageDOMElements.inventoryModal.style.display = 'flex';
        }


        // --- Fixed Assets Section Logic ---
        function setupFixedAssetEventListeners() {
            if (pageDOMElements.fixedAssetForm) {
                pageDOMElements.fixedAssetForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const id = form.fixedAssetId.value;
                    const data = {
                        assetName: form.assetName.value,
                        assetId: form.assetId.value,
                        propertyId: form.propertyId.value,
                        purchaseDate: form.purchaseDate.value,
                        purchaseCost: parseFloat(form.purchaseCost.value) || 0,
                        notes: form.notes.value,
                        userId: pageCurrentUserId,
                        updatedAt: commonDependencies.fbServerTimestamp()
                    };
                    if (!data.assetName) {
                        commonDependencies.commonShowAlert('Asset Name is required.', 'Validation Error');
                        return;
                    }
                    try {
                        const path = `fixedAssets/${pageCurrentUserId}`;
                        if (id) {
                            const itemRef = commonDependencies.fbRef(pageDatabase, `${path}/${id}`);
                            const snapshot = await commonDependencies.fbGetDbData(itemRef);
                            const existingData = snapshot.val() || {};
                            await commonDependencies.fbSet(itemRef, {...existingData, ...data, createdAt: existingData.createdAt || commonDependencies.fbServerTimestamp()});
                            commonDependencies.commonShowAlert('Fixed Asset updated.');
                        } else {
                            data.createdAt = commonDependencies.fbServerTimestamp();
                            await commonDependencies.fbPush(commonDependencies.fbRef(pageDatabase, path), data);
                            commonDependencies.commonShowAlert('Fixed Asset added.');
                        }
                        pageDOMElements.fixedAssetModal.style.display = 'none';
                    } catch (error) { commonDependencies.commonShowAlert(`Error: ${error.message}`); }
                });
            }
        }

        function loadFixedAssets() {
            if (!pageCurrentUserId || !pageDatabase) return;
            const dataRef = commonDependencies.fbRef(pageDatabase, `fixedAssets/${pageCurrentUserId}`);
            onValue(dataRef, (snapshot) => {
                pageDOMElements.fixedAssetsTableBody.innerHTML = '';
                let hasData = false;
                snapshot.forEach(child => {
                    hasData = true;
                    populateFixedAssetRow({ id: child.key, ...child.val() });
                });
                pageDOMElements.noFixedAssetsMessage.style.display = hasData ? 'none' : 'block';
            });
        }

        function populateFixedAssetRow(data) {
            const row = pageDOMElements.fixedAssetsTableBody.insertRow();
            row.insertCell().textContent = data.assetName;
            row.insertCell().textContent = data.assetId || 'N/A';
            row.insertCell().textContent = localPropertiesMap[data.propertyId] || data.propertyId || 'N/A';
            row.insertCell().textContent = data.purchaseDate ? new Date(data.purchaseDate).toLocaleDateString() : 'N/A';
            row.insertCell().textContent = data.purchaseCost ? `$${data.purchaseCost.toFixed(2)}` : 'N/A';
            row.insertCell().textContent = 'N/A'; // Placeholder for current value
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `<button class="edit-btn">${commonDependencies.commonEditIcon}</button><button class="delete-btn">${commonDependencies.commonDeleteIcon}</button>`;
            actionsCell.querySelector('.edit-btn').addEventListener('click', () => openFixedAssetModal(data.id, data));
            actionsCell.querySelector('.delete-btn').addEventListener('click', () => handleDeleteGeneric('fixedAssets', data.id, 'Fixed Asset'));
            row.addEventListener('click', () => openFixedAssetModal(data.id, data));
        }

        function openFixedAssetModal(id = null, data = {}) {
            pageDOMElements.fixedAssetForm.reset();
            pageDOMElements.fixedAssetForm.fixedAssetId.value = id || '';
            pageDOMElements.fixedAssetForm.assetName.value = data.assetName || '';
            pageDOMElements.fixedAssetForm.assetId.value = data.assetId || '';
            pageDOMElements.fixedAssetForm.propertyId.value = data.propertyId || '';
            pageDOMElements.fixedAssetForm.purchaseDate.value = data.purchaseDate || '';
            pageDOMElements.fixedAssetForm.purchaseCost.value = data.purchaseCost || '';
            pageDOMElements.fixedAssetForm.notes.value = data.notes || '';
            pageDOMElements.fixedAssetModal.style.display = 'flex';
        }

        // --- Generic Delete Function ---
        async function handleDeleteGeneric(sectionPath, itemId, itemNameSingular) {
            if (!pageCurrentUserId || !pageDatabase) return;
            const confirmed = await commonDependencies.commonShowConfirm(`Are you sure you want to delete this ${itemNameSingular}?`, `Delete ${itemNameSingular}`);
            if (confirmed) {
                try {
                    const itemRef = commonDependencies.fbRef(pageDatabase, `${sectionPath}/${pageCurrentUserId}/${itemId}`);
                    await commonDependencies.fbRemove(itemRef);
                    commonDependencies.commonShowAlert(`${itemNameSingular} deleted successfully!`);
                } catch (error) {
                    console.error(`Error deleting ${itemNameSingular}:`, error);
                    commonDependencies.commonShowAlert(`Error: ${error.message}`, `Delete Error`);
                }
            }
        }
        
        initializeAuth(pageInit);
    </script>
</body>
</html> 